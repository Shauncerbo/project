@page "/members"
@layout MainLayout
@using System.Diagnostics
@using System.Linq
@using System.Collections.Generic
@using System.Threading.Tasks
@using System.ComponentModel.DataAnnotations
@inject IJSRuntime JSRuntime
@inject AppDbContext Context
@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject IMemberService MemberService
@inject IToastService ToastService
@inject IAuthService AuthService
@inject IPayMongoService PayMongoService
@using project.Data
@using project.Models
@using project.Services
@using Microsoft.EntityFrameworkCore
@using MemberPromo = project.Models.MemberPromo
@using PaymentModel = project.Models.Payment

<div class="members-container">
    <!-- Loading Indicator -->
    @if (isLoading)
    {
        <div class="loading-overlay">
            <div class="loading-spinner">Loading members...</div>
        </div>
    }

    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Members</h1>
    </div>

    <!-- Members Data Table -->
    <div class="table-container">
        <div class="table-toolbar">
            <span class="table-title">Active Members</span>
            <input type="text"
                   class="search-bar"
                   placeholder="Search Active members..."
                   @bind="searchQuery"
                   @bind:event="oninput"
                   @onkeyup="HandleSearch" />
        </div>
        <table class="members-table">
            <thead>
                <tr>
                    <th>NAME</th>
                    <th>CONTACT</th>
                    <th>EMAIL</th>
                    <th>JOIN DATE</th>
                    <th>EXPIRATION</th>
                    <th>TYPE</th>
                    <th>TRAINER</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody>
                @if (filteredMembers == null || !filteredMembers.Any())
                {
                    <tr>
                        <td colspan="8" class="no-data">
                            <div class="no-data-content">
                                <span class="no-data-icon">👥</span>
                                <p>No members found</p>
                                <p class="no-data-sub">Add your first member to get started</p>
                            </div>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var member in paginatedActiveMembers)
                    {
                        <tr>
                            <td>
                                <div class="member-info">
                                    <div class="member-avatar">@GetInitials(member.FirstName, member.LastName)</div>
                                    <span>@GetDisplayName(member.FirstName, member.MiddleInitial, member.LastName)</span>
                                </div>
                            </td>
                            <td>@member.ContactNumber</td>
                            <td>@member.Email</td>
                            <td>@member.JoinDate.ToString("MM/dd/yyyy")</td>
                            <td>
                                @if (member.ExpirationDate.HasValue)
                                {
                                    <span class="@GetExpirationClass(member.ExpirationDate.Value)">
                                        @member.ExpirationDate.Value.ToString("MM/dd/yyyy")
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td>
                                @{
                                    var membershipName = member.MembershipType != null
                                        ? member.MembershipType.TypeName
                                        : "N/A";
                                }
                                <span class="payment-method-text">@membershipName</span>
                            </td>
                            <td>
                                @if (member.TrainerID.HasValue && member.Trainer != null)
                                {
                                    <div class="trainer-info">
                                        <span class="trainer-name">@member.Trainer.FullName</span>
                                        <span class="trainer-specialty">@member.Trainer.Specialty</span>
                                        @if (member.TrainerSchedule != null)
                                        {
                                            <span class="trainer-schedule">@member.TrainerSchedule.DisplayText</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span class="no-trainer">No trainer assigned</span>
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn edit-btn" @onclick="() => EditMember(member)" title="Edit">
                                        <img src="/Newedit_icon.svg" class="action-icon" alt="Edit" />
                                    </button>
                                    <button class="action-btn archive-btn" @onclick="() => ShowArchiveConfirmation(member)" title="Archive">
                                        <img src="/archived_icon.svg" class="action-icon" alt="Archive" />
                                    </button>
                                    <button class="action-btn qr-btn" @onclick="() => ShowQrCode(member)" title="QR Code">
                                        <img src="/QR_icon.svg" class="action-icon" alt="QR Code" />
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
        
        <!-- Pagination Controls for Active Members -->
        @if (filteredMembers.Any() && totalActivePages > 1)
        {
            <div class="pagination-container">
                <div class="pagination-info">
                    Showing @((currentActivePage - 1) * itemsPerPage + 1) - @(Math.Min(currentActivePage * itemsPerPage, filteredMembers.Count)) of @filteredMembers.Count
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" 
                            @onclick="PreviousActivePage" 
                            disabled="@(currentActivePage == 1)">
                        Previous
                    </button>
                    @foreach (var pageNum in GetPageNumbers(currentActivePage, totalActivePages))
                    {
                        @if (pageNum == -1)
                        {
                            <span class="pagination-ellipsis">...</span>
                        }
                        else
                        {
                            <button class="pagination-btn @(pageNum == currentActivePage ? "active" : "")" 
                                    @onclick="() => GoToActivePage(pageNum)">
                                @pageNum
                            </button>
                        }
                    }
                    <button class="pagination-btn" 
                            @onclick="NextActivePage" 
                            disabled="@(currentActivePage == totalActivePages)">
                        Next
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- Expired/Inactive Members Section -->
    @if (expiredInactiveMembers != null)
    {
        <div class="expired-section">
            <div class="section-header">
            </div>
            <div class="table-container">
                <div class="table-toolbar">
                    <span class="table-title">Expired / Inactive Members</span>
                    <input type="text"
                           class="search-bar"
                           placeholder="Search expired/inactive members..."
                           @bind="expiredSearchQuery"
                           @bind:event="oninput"
                           @onkeyup="FilterExpiredMembers" />
                </div>
                <table class="members-table expired-table">
                    <thead>
                        <tr>
                            <th>NAME</th>
                            <th>CONTACT NUMBER</th>
                            <th>EMAIL</th>
                            <th>EXPIRED DATE</th>
                            <th>LAST MEMBERSHIP</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!expiredInactiveMembers.Any())
                        {
                            <tr>
                                <td colspan="6" class="no-data">
                                    <div class="no-data-content">
                                        <span class="no-data-icon">👥</span>
                                        <p>@(string.IsNullOrWhiteSpace(expiredSearchQuery) ? "No expired/inactive members found" : "No expired/inactive members match your search")</p>
                                        @if (!string.IsNullOrWhiteSpace(expiredSearchQuery))
                                        {
                                            <p class="no-data-sub">Try a different search term or clear the search</p>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var member in paginatedInactiveMembers)
                            {
                                <tr>
                                    <td>
                                        <div class="member-info">
                                            <div class="member-avatar">@GetInitials(member.FirstName, member.LastName)</div>
                                            <span>@GetDisplayName(member.FirstName, member.MiddleInitial, member.LastName)</span>
                                        </div>
                                    </td>
                                    <td>@member.ContactNumber</td>
                                    <td>@member.Email</td>
                                    <td>
                                        @if (member.ExpirationDate.HasValue)
                                        {
                                            <span class="expiration-expired">
                                                @member.ExpirationDate.Value.ToString("MM/dd/yyyy")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </td>
                                    <td>
                                        @if (member.MembershipType != null)
                                        {
                                            <span>@member.MembershipType.TypeName</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="renew-btn" @onclick="() => OpenRenewModal(member)" title="Renew Membership">
                                            Renew
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
                
                <!-- Pagination Controls for Inactive Members -->
                @if (expiredInactiveMembers.Any() && totalInactivePages > 1)
                {
                    <div class="pagination-container">
                        <div class="pagination-info">
                            Showing @((currentInactivePage - 1) * itemsPerPage + 1) - @(Math.Min(currentInactivePage * itemsPerPage, expiredInactiveMembers.Count)) of @expiredInactiveMembers.Count
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" 
                                    @onclick="PreviousInactivePage" 
                                    disabled="@(currentInactivePage == 1)">
                                Previous
                            </button>
                            @foreach (var pageNum in GetPageNumbers(currentInactivePage, totalInactivePages))
                            {
                                @if (pageNum == -1)
                                {
                                    <span class="pagination-ellipsis">...</span>
                                }
                                else
                                {
                                    <button class="pagination-btn @(pageNum == currentInactivePage ? "active" : "")" 
                                            @onclick="() => GoToInactivePage(pageNum)">
                                        @pageNum
                                    </button>
                                }
                            }
                            <button class="pagination-btn" 
                                    @onclick="NextInactivePage" 
                                    disabled="@(currentInactivePage == totalInactivePages)">
                                Next
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Renew Membership Modal -->
    @if (showRenewModal)
    {
            <div class="modal-overlay" @onclick="() => { showRenewModal = false; ResetRenewModalState(); }">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h2>Renew Membership - @(memberToRenew != null ? GetDisplayName(memberToRenew.FirstName, memberToRenew.MiddleInitial, memberToRenew.LastName) : "")</h2>
                    <button class="close-btn" @onclick="CloseRenewModal">×</button>
                </div>

                <div class="modal-body">
                    @if (!string.IsNullOrWhiteSpace(renewError))
                    {
                        <div class="general-error">
                            ⚠️ @renewError
                        </div>
                    }

                    <div class="form-section">
                        <h4>Renewal Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="required">New Membership Type</label>
                                <div class="select-wrapper">
                                    <select class="form-control select-dropdown @(HasRenewError("MembershipTypeID") ? "error" : "")" 
                                            @bind="renewMembershipTypeId" 
                                            @bind:after="OnRenewMembershipTypeChanged">
                                        <option value="0">Select membership type</option>
                                        @foreach (var type in availableMembershipTypes)
                                        {
                                            <option value="@type.MembershipTypeID">@type.TypeName - ₱@type.Price.ToString("N2") (@type.DurationInDays days)</option>
                                        }
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                @if (HasRenewError("MembershipTypeID"))
                                {
                                    <div class="field-error">Membership type is required</div>
                                }
                            </div>
                            <div class="form-group">
                                <label class="required">Payment Method</label>
                                <div class="select-wrapper">
                                    <select class="form-control select-dropdown @(HasRenewError("PaymentMethod") ? "error" : "")" @bind="renewPaymentMethod" @bind:after="OnRenewPaymentMethodChanged">
                                        <option value="Cash">Cash</option>
                                        <option value="PayMongo">Pay Online (PayMongo)</option>
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                @if (HasRenewError("PaymentMethod"))
                                {
                                    <div class="field-error">Payment method is required</div>
                                }
                                @if (renewPaymentMethod == "PayMongo")
                                {
                                    <div class="paymongo-info">
                                        <p><strong>Online Payment:</strong> Customer will be redirected to PayMongo to complete payment via GCash, PayMaya, Credit Card, or other methods.</p>
                                    </div>
                                }
                            </div>
                            <div class="form-group">
                                <label>Assign Trainer (Optional)</label>
                                <div class="select-wrapper">
                                    <select class="form-control select-dropdown @(HasRenewError("TrainerID") ? "error" : "")"
                                            @bind="renewTrainerId"
                                            @bind:after="OnRenewTrainerChanged">
                                        <option value="">Select a trainer (optional)</option>
                                        @foreach (var trainer in availableRenewTrainers)
                                        {
                                            <option value="@trainer.TrainerID">@trainer.FullName - @trainer.Specialty</option>
                                        }
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Preferred Schedule</label>
                            @if (renewTrainerId.HasValue && visibleRenewTrainerSchedules.Any())
                            {
                                <div class="select-wrapper">
                                    <select class="form-control select-dropdown @(HasRenewError("TrainerScheduleID") ? "error" : "")"
                                            @bind="renewTrainerScheduleId"
                                            @bind:after="OnRenewTrainerScheduleChanged">
                                        <option value="">Select schedule</option>
                                        @foreach (var schedule in visibleRenewTrainerSchedules)
                                        {
                                            <option value="@schedule.TrainerScheduleID">@schedule.DisplayText</option>
                                        }
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                @if (HasRenewError("TrainerScheduleID"))
                                {
                                    <div class="field-error">Please select a schedule for the trainer.</div>
                                }
                            }
                            else if (renewTrainerId.HasValue)
                            {
                                <div class="info-box">
                                    <span class="info-icon">ℹ️</span>
                                    <div class="info-content">
                                        <strong>No schedule available</strong>
                                        <p>This trainer has no available schedules yet.</p>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="form-group">
                            <label>Promotion (Optional)</label>
                            <div class="select-wrapper">
                                <select class="form-control select-dropdown" @bind="renewPromotionId" @bind:after="OnRenewPromotionChanged">
                                    <option value="0">No promotion</option>
                                    @if (activePromotions != null && activePromotions.Any())
                                    {
                                        @foreach (var promo in activePromotions)
                                        {
                                            <option value="@promo.PromoID">@promo.PromoName - @promo.DiscountRate.ToString("F0")% off</option>
                                        }
                                    }
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            @if (selectedRenewPromotion != null)
                            {
                                <small class="promo-description">@selectedRenewPromotion.Description</small>
                            }
                            @if (activePromotions != null && !activePromotions.Any())
                            {
                                <small class="promo-description" style="color: #999;">No active promotions available</small>
                            }
                        </div>

                        @if (renewMembershipType != null)
                        {
                            <div class="price-breakdown">
                                <div class="price-row">
                                    <span>Membership Price:</span>
                                    <span class="price-original">₱@(renewMembershipType.Price.ToString("N2"))</span>
                                </div>
                                @if (selectedRenewPromotion != null && renewDiscountAmount > 0)
                                {
                                    <div class="price-row discount-row">
                                        <span>Discount (@selectedRenewPromotion.DiscountRate.ToString("F0")%):</span>
                                        <span class="price-discount">-₱@(renewDiscountAmount.ToString("N2"))</span>
                                    </div>
                                }
                                <div class="price-row total-row">
                                    <span><strong>Amount to Pay:</strong></span>
                                    <span class="price-final"><strong>₱@(renewFinalPrice.ToString("N2"))</strong></span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-cancel" @onclick="ResetRenewModalState" disabled="@(isRenewing || isVerifyingRenewalPayment)">Cancel</button>
                    @if (showVerifyRenewalPaymentButton && !string.IsNullOrEmpty(pendingRenewalPaymentIntentId))
                    {
                        <button class="btn btn-verify" @onclick="VerifyAndSaveRenewalPayment" disabled="@(isRenewing || isVerifyingRenewalPayment)">
                            @if (isVerifyingRenewalPayment)
                            {
                                <span>Verifying Payment...</span>
                            }
                            else
                            {
                                <span>Verify Payment</span>
                            }
                        </button>
                    }
                    <button class="btn btn-primary" disabled="@(isRenewing || isVerifyingRenewalPayment || showVerifyRenewalPaymentButton)" @onclick="RenewMembershipAsync">
                        @if (isProcessingRenewalPayment)
                        {
                            <span>Processing Payment...</span>
                        }
                        else if (renewPaymentMethod == "PayMongo" && !showVerifyRenewalPaymentButton)
                        {
                            <span>Proceed to Payment</span>
                        }
                        else if (isRenewing)
                        {
                            <span>Processing...</span>
                        }
                        else
                        {
                            <span>Renew Membership</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Add/Edit Member Modal -->
    @if (showModal)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h2>@(isEditMode ? "Edit Member" : "Add New Member")</h2>
                    <button class="close-btn" @onclick="CloseModal">×</button>
                </div>

                <div class="modal-body">
                    <!-- Validation Error Message -->
                    @if (showValidationError)
                    {
                        <div class="validation-error">
                            ⚠️ Please fill in all required fields marked with *
                        </div>
                    }

                    <!-- Name Fields -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">First Name</label>
                            <input type="text"
                                   class="form-control @(HasError("FirstName") ? "error" : "")"
                                   @bind="currentMember.FirstName"
                                   placeholder="Enter first name"
                                   disabled="@lockIdentityFields" />
                            @if (HasError("FirstName"))
                            {
                                <div class="field-error">First name is required</div>
                            }
                        </div>
                        <div class="form-group">
                            <label>Middle Initial</label>
                            <input type="text"
                                   class="form-control"
                                   @bind="currentMember.MiddleInitial"
                                   placeholder="Enter middle initial"
                                   maxlength="10"
                                   disabled="@lockIdentityFields" />
                        </div>
                        <div class="form-group">
                            <label class="required">Last Name</label>
                            <input type="text"
                                   class="form-control @(HasError("LastName") ? "error" : "")"
                                   @bind="currentMember.LastName"
                                   placeholder="Enter last name"
                                   disabled="@lockIdentityFields" />
                            @if (HasError("LastName"))
                            {
                                <div class="field-error">Last name is required</div>
                            }
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Contact Information -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Contact Number</label>
                            <input type="text"
                                   class="form-control @(HasError("ContactNumber") ? "error" : "")"
                                   @bind-value="ContactNumberInput"
                                   @bind-value:event="oninput"
                                   inputmode="numeric"
                                   pattern="[0-9]*"
                                   maxlength="11"
                                   placeholder="09XXXXXXXXX" />
                            @if (HasError("ContactNumber"))
                            {
                                <div class="field-error">Contact number is required (11 digits)</div>
                            }
                        </div>
                        <div class="form-group">
                            <label class="required">Email</label>
                            <input type="email" class="form-control @(HasError("Email") ? "error" : "")" @bind="currentMember.Email" placeholder="Enter email address (e.g., name@example.com)" />
                            @if (HasError("Email"))
                            {
                                <div class="field-error">@(string.IsNullOrWhiteSpace(currentMember.Email) ? "Email is required" : "Please enter a valid email address with @ symbol and domain (e.g., name@example.com, not just 'gmail' or 'name')")</div>
                            }
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">Address</label>
                        <textarea class="form-control address-textarea @(HasError("Address") ? "error" : "")" @bind="currentMember.Address" placeholder="Enter full address" rows="3"></textarea>
                        @if (HasError("Address"))
                        {
                            <div class="field-error">Address is required</div>
                        }
                    </div>

                    <!-- Lead Source -->
                    <div class="form-group">
                        <label>How did you hear about us?</label>
                        <div class="select-wrapper">
                            <select class="form-control select-dropdown" @bind="currentMember.LeadSource">
                                <option value="">Select source (optional)</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Referral">Referral (Friend/Family)</option>
                                <option value="Walk-in">Walk-in / Passed by</option>
                                <option value="Promotion">Promotion / Discount</option>
                                <option value="Google">Google Search</option>
                                <option value="Website">Website</option>
                                <option value="Other">Other</option>
                            </select>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Membership Details -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Join Date</label>
                            <input type="date"
                                   class="form-control @(HasError("JoinDate") ? "error" : "")"
                                   @bind="currentMember.JoinDate"
                                   @bind:after="OnJoinDateChanged"
                                   format="yyyy-MM-dd"
                                   disabled="@lockIdentityFields" />
                            @if (HasError("JoinDate"))
                            {
                                <div class="field-error">Join date is required</div>
                            }
                        </div>
                    </div>

                    <!-- Membership Type -->
                    <div class="form-group">
                        <label class="required">Membership Type</label>
                        <div class="select-wrapper">
                            <select class="form-control select-dropdown @(HasError("MembershipTypeID") ? "error" : "")" @bind="currentMember.MembershipTypeID" @bind:after="OnMembershipTypeChanged">
                                <option value="0">Select membership type</option>
                                @foreach (var membershipType in availableMembershipTypes)
                                {
                                    <option value="@membershipType.MembershipTypeID">@membershipType.TypeName - ₱@membershipType.Price.ToString("N2") (@membershipType.DurationInDays days)</option>
                                }
                            </select>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        @if (HasError("MembershipTypeID"))
                        {
                            <div class="field-error">Membership type is required</div>
                        }
                        @if (currentMember.MembershipTypeID > 0 && currentMember.JoinDate != DateTime.MinValue && currentMember.ExpirationDate.HasValue)
                        {
                            <div class="expiration-preview">
                                <small style="color: #e74c3c; font-weight: 500;"> Expiration: @currentMember.ExpirationDate.Value.ToString("MM/dd/yyyy")</small>
                            </div>
                        }
                    </div>

                    <!-- Trainer Assignment -->
                    <div class="form-group">    
                        <label>Assign Trainer (Optional)</label>
                        <div class="select-wrapper">
                            <select class="form-control select-dropdown" 
                                    @bind="currentMember.TrainerID"
                                    @bind:after="OnTrainerSelectionChanged">
                                <option value="">Select a trainer (optional)</option>
                                @foreach (var trainer in availableTrainers)
                                {
                                    <option value="@trainer.TrainerID">@trainer.FullName - @trainer.Specialty</option>
                                }
                            </select>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                    </div>

                    @if (currentMember.TrainerID.HasValue)
                    {
                        <div class="form-group">
                            <label class="required">Preferred Schedule</label>
                            @if (visibleTrainerSchedules.Any())
                            {
                                <div class="select-wrapper">
                                    <select class="form-control select-dropdown @(HasError("TrainerScheduleID") ? "error" : "")"
                                            @bind="selectedTrainerScheduleId"
                                            @bind:after="OnTrainerScheduleChanged">
                                        <option value="0">Select schedule</option>
                                        @foreach (var schedule in visibleTrainerSchedules)
                                        {
                                            <option value="@schedule.TrainerScheduleID">@schedule.DisplayText</option>
                                        }
                                    </select>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                @if (HasError("TrainerScheduleID"))
                                {
                                    <div class="field-error">Please select a schedule for the trainer.</div>
                                }
                            }
                            else
                            {
                                <div class="info-box">
                                    <span class="info-icon">ℹ️</span>
                                    <div class="info-content">
                                        <strong>No schedule available</strong>
                                        <p>This trainer has no available schedules yet.</p>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- QR Code / Student ID Section -->
                    @if (currentMember.MemberID > 0)
                    {
                        <div class="divider"></div>
                        @if (IsStudentMemberWithID())
                        {
                            <!-- Student ID Image Section -->
                            <div class="qr-code-section">
                                <h4>Student ID</h4>
                                <div class="qr-code-container">
                                    <div class="qr-code-display">
                                        <div class="qr-header">
                                            <strong>@currentMember.FirstName @currentMember.LastName</strong>
                                        </div>
                                        <div class="qr-image-container">
                                            @if (currentMember.StudentIDImage != null && currentMember.StudentIDImage.Length > 0)
                                            {
                                                <img src="data:image/jpeg;base64,@Convert.ToBase64String(currentMember.StudentIDImage)"
                                                     alt="Student ID"
                                                     class="qr-image student-id-image" />
                                            }
                                            else
                                            {
                                                <div class="no-student-id">No Student ID uploaded</div>
                                            }
                                        </div>
                                        <div class="qr-instructions">
                                            <small>Student ID for membership verification</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else if (qrCodeImage != null)
                        {
                            <!-- QR Code Section -->
                            <div class="qr-code-section">
                                <h4>Member QR Code</h4>
                                <div class="qr-code-container">
                                    <div class="qr-code-display">
                                        <div class="qr-header">
                                            <strong>@currentMember.FirstName @currentMember.LastName</strong>
                                        </div>
                                        <div class="qr-image-container">
                                            <img src="data:image/png;base64,@Convert.ToBase64String(qrCodeImage)"
                                                 alt="QR Code"
                                                 class="qr-image" />
                                        </div>
                                        <div class="qr-instructions">
                                            <small> Scan this code for attendance tracking</small>
                                        </div>
                                        <div class="qr-actions">
                                            <button class="btn btn-outline-primary btn-sm" @onclick="PrintQrCode">
                                                 Print
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" @onclick="DownloadQrCode">
                                                 Download
                                            </button>
                                            <button class="btn btn-outline-info btn-sm" @onclick="GenerateNewQrCode">
                                                 Regenerate
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-cancel" @onclick="CloseModal">Cancel</button>
                    <button class="btn btn-save" @onclick="SaveMember">
                        @(isEditMode ? "Update" : "Add") Member
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Archive Confirmation Modal -->
    @if (showArchiveConfirmation)
    {
        <div class="modal-overlay" @onclick="CloseArchiveConfirmation">
            <div class="modal-content confirmation-modal" @onclick:stopPropagation="true">
    <div class="modal-header">
        <h2>Archive Member</h2>
        <button class="close-btn" @onclick="CloseArchiveConfirmation">×</button>
    </div>

    <div class="modal-body">
        <div class="confirmation-content text-only">
            <h3>Archive Member</h3>
            <p>You are about to archive <strong>@(selectedMember != null ? GetDisplayName(selectedMember.FirstName, selectedMember.MiddleInitial, selectedMember.LastName) : "")</strong>.</p>
            <p class="confirmation-warning">This will remove the member from the active list. Continue?</p>
        </div>
    </div>

                <div class="modal-footer">
                    <button class="btn btn-cancel" @onclick="CloseArchiveConfirmation">Cancel</button>
                    <button class="btn btn-danger" @onclick="ConfirmArchive">Yes, Archive Member</button>
                </div>
            </div>
        </div>
    }

    <!-- QR Code Display Modal -->
    @if (showQrModal)
    {
        <div class="modal-overlay" @onclick="CloseQrModal">
            <div class="modal-content qr-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h2>Member QR Code</h2>
                    <button class="close-btn" @onclick="CloseQrModal">×</button>
                </div>

                <div class="modal-body">
                    <div class="qr-code-display-full">
                        <div class="qr-header-full">
                            <h4>@selectedMember?.FirstName @selectedMember?.LastName</h4>
                        </div>
                        <div class="qr-image-container-full">
                            @if (selectedMemberQrImage != null)
                            {
                                <img src="data:image/png;base64,@Convert.ToBase64String(selectedMemberQrImage)"
                                     alt="QR Code"
                                     class="qr-image-full" />
                            }
                            else
                            {
                                <div class="qr-loading">Generating QR Code...</div>
                            }
                        </div>
                        <div class="qr-instructions-full">
                            <p> Show this code at the gym for quick check-in</p>
                        </div>
                        <div class="qr-actions-full">
                            <button class="btn btn-primary" @onclick="PrintQrCode">
                                 Print QR Code
                            </button>
                            <button class="btn btn-secondary" @onclick="DownloadQrCode">
                                 Download QR Code
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
     .members-container {
         padding: 30px;
         background: #ffffff;
         min-height: 100vh;
     }

     .loading-overlay {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(255, 255, 255, 0.8);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 9999;
     }

     .loading-spinner {
         padding: 20px;
         background: white;
         border-radius: 8px;
         box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
         font-weight: 600;
     }

     .page-header {
         background: white;
         padding: 25px 30px;
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin: 0 0 30px 0;
         border-radius: 10px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.1);
     }

     .page-title {
         font-size: 24px;
         font-weight: 600;
         margin: 0;
         color: #333;
     }

     .header-actions {
         display: flex;
         gap: 15px;
         align-items: center;
     }

     .search-bar {
         padding: 10px 15px;
         border: 1px solid #ddd;
         border-radius: 6px;
         width: 250px;
         font-size: 14px;
         transition: all 0.3s;
     }

         .search-bar:focus {
             outline: none;
             border-color: #5cb85c;
             box-shadow: 0 0 0 3px rgba(92, 184, 92, 0.1);
         }

     .add-member-btn {
         background: #5cb85c;
         color: white;
         border: none;
         padding: 10px 20px;
         border-radius: 6px;
         font-size: 14px;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.3s;
     }

         .add-member-btn:hover {
             background: #4cae4c;
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(92, 184, 92, 0.3);
         }

     .table-container {
         margin: 0;
         background: white;
         border-radius: 10px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.1);
         overflow-x: auto;
         overflow-y: auto;
         max-height: calc(100vh - 250px);
         position: relative;
     }

     .table-toolbar {
         display: flex;
         align-items: center;
         padding: 12px 16px 8px 16px;
         margin-bottom: 4px;
     }

     .table-toolbar .search-bar {
         margin-left: auto; /* push search to the right */
     }

     .table-title {
         font-size: 16px;
         font-weight: 600;
         color: #234060;
     }

     .payment-method-text {
         color: #333;
         font-size: 14px;
     }

     .members-table {
         width: 100%;
         border-collapse: collapse;
     }

         .members-table thead {
             background: #234060;
             color: white;
             position: sticky;
             top: 0;
             z-index: 10;
         }

         .members-table th {
             padding: 12px 16px;
             text-align: left;
             font-weight: 600;
             font-size: 14px;
             text-transform: uppercase;
             letter-spacing: 0.5px;
             border-bottom: 2px solid #1a3450;
         }

         .members-table td {
             padding: 12px 16px;
             border-bottom: 1px solid #f0f0f0;
             color: #333;
             vertical-align: middle;
         }

         .members-table tbody tr {
             transition: background 0.2s;
         }

             .members-table tbody tr:hover {
                 background: #f8f9fa;
             }

    .member-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .member-info span {
            font-weight: normal;
            color: #1f2b3d;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
        }

     .member-avatar {
         width: 36px;
         height: 36px;
         border-radius: 50%;
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
         display: flex;
         align-items: center;
         justify-content: center;
         font-weight: bold;
         font-size: 14px;
         flex-shrink: 0;
     }

     .address-cell {
         max-width: 250px;
         word-wrap: break-word;
     }

     .status-badge {
         padding: 0;
         border-radius: 0;
         font-size: 14px;
         font-weight: 600;
         background: transparent !important;
         border: none !important;
     }

     .status-active {
         background: transparent !important;
         color: #333 !important;
     }

     .status-inactive {
         background: transparent !important;
         color: #333 !important;
     }

     .status-suspended {
         background: transparent !important;
         color: #333 !important;
     }

     .trainer-info {
         display: flex;
         flex-direction: column;
         gap: 2px;
     }

     .trainer-name {
         font-weight: 600;
         color: #333;
         font-size: 13px;
     }

     .trainer-specialty {
         font-size: 11px;
         color: #666;
         background: #f8f9fa;
         padding: 2px 6px;
         border-radius: 10px;
         display: inline-block;
     }

    .trainer-schedule {
        font-size: 11px;
        color: #2d5bd1;
     }

     .no-trainer {
         color: #999;
         font-style: italic;
         font-size: 13px;
     }

     .action-buttons {
         display: flex;
         gap: 8px;
     }

     .action-btn {
        background: transparent !important;
        border: none !important;
         cursor: pointer;
        padding: 0;
        transition: transform 0.15s ease;
         display: flex;
         align-items: center;
         justify-content: center;
        box-shadow: none !important;
     }

        .action-btn:hover {
             transform: scale(1.1);
            background: transparent !important;
             }

        .action-btn:focus {
            background: transparent !important;
            outline: none;
     }

        .action-btn:active {
            background: transparent !important;
        }

    .action-icon {
        width: 20px;
        height: 20px;
        transition: filter 0.15s ease;
         }

        .action-btn:hover .action-icon {
            filter: brightness(1.15);
             }

    .edit-btn,
    .archive-btn,
     .qr-btn {
        background: transparent !important;
             }

     .no-data {
         text-align: center;
         padding: 60px 20px;
     }

     .no-data-content {
         color: #999;
     }

     .no-data-icon {
         font-size: 64px;
         display: block;
         margin-bottom: 16px;
     }

     .no-data-content p {
         margin: 8px 0;
         font-size: 16px;
     }

     .no-data-sub {
         font-size: 14px;
         color: #bbb;
     }

     .modal-overlay {
         position: fixed;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background: rgba(0, 0, 0, 0.5);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 1000;
         padding: 20px;
         box-sizing: border-box;
     }

     .modal-content {
         background: white;
         border-radius: 12px;
         width: 95%;
         max-width: 900px;
         max-height: 90vh;
         overflow-y: auto;
         box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
         display: flex;
         flex-direction: column;
     }

     .modal-header {
         padding: 20px 24px;
         border-bottom: 1px solid #eee;
         display: flex;
         justify-content: space-between;
         align-items: center;
         flex-shrink: 0;
     }

         .modal-header h2 {
             margin: 0;
             font-size: 22px;
             color: #333;
         }

     .close-btn {
         background: transparent;
         border: none;
         font-size: 32px;
         color: #999;
         cursor: pointer;
         line-height: 1;
         padding: 0;
         width: 32px;
         height: 32px;
         transition: color 0.2s;
     }

         .close-btn:hover {
             color: #333;
         }

     .modal-body {
         padding: 24px;
         overflow-y: auto;
         flex: 1;
         max-height: calc(90vh - 140px);
     }

     .validation-error {
         background: #ffeaa7;
         border: 1px solid #fdcb6e;
         border-radius: 8px;
         padding: 12px 16px;
         margin-bottom: 20px;
         color: #e17055;
         font-weight: 600;
         font-size: 14px;
         display: flex;
         align-items: center;
         gap: 8px;
         flex-shrink: 0;
     }

     .form-group {
         margin-bottom: 20px;
     }

         .form-group label {
             display: block;
             margin-bottom: 8px;
             font-weight: 600;
             color: #333;
             font-size: 14px;
         }

     .form-control {
         width: 100%;
         padding: 12px;
         border: 1px solid #ddd;
         border-radius: 8px;
         font-size: 15px;
         transition: all 0.3s;
         box-sizing: border-box;
     }

         .form-control:focus {
             outline: none;
             border-color: #5cb85c;
             box-shadow: 0 0 0 3px rgba(92, 184, 92, 0.1);
         }

         .form-control.error {
             border-color: #e74c3c;
             box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
         }

     .field-error {
         color: #e74c3c;
         font-size: 12px;
         margin-top: 5px;
         font-weight: 500;
         display: flex;
         align-items: center;
         gap: 4px;
     }

         .field-error::before {
             content: "⚠";
         }

     /* Expiration Date Styling */
     .expiration-expired {
         color: #e74c3c;
         font-weight: 600;
     }

     .expiration-warning {
         color: #f39c12;
         font-weight: 600;
     }

     .expiration-approaching {
         color: #f1c40f;
         font-weight: 500;
     }

     .expiration-valid {
        color: #f39c12;
     }

    .expiration-preview {
        margin-top: 8px;
        padding: 6px 10px;
        background: #fff4f4;
        border-radius: 6px;
        border-left: 3px solid #e74c3c;
    }

     /* Status Badge Styling */
     .status-badge {
         display: inline-block;
         padding: 4px 12px;
         border-radius: 12px;
         font-size: 12px;
         font-weight: 600;
         text-transform: uppercase;
         letter-spacing: 0.5px;
     }

     .status-active {
         background: #d4edda;
         color: #155724;
     }

     .status-expired {
         background: #f8d7da;
         color: #721c24;
     }

     .status-inactive {
         background: #e2e3e5;
         color: #383d41;
     }

     .status-suspended {
         background: #fff3cd;
         color: #856404;
     }

     .address-textarea {
         resize: vertical;
         min-height: 80px;
         font-family: inherit;
     }

     .select-wrapper {
         position: relative;
         display: inline-block;
         width: 100%;
     }

     .select-dropdown {
         appearance: none;
         -webkit-appearance: none;
         -moz-appearance: none;
         padding-right: 40px;
         background: white;
         cursor: pointer;
         width: 100%;
         padding: 12px;
         border: 1px solid #ddd;
         border-radius: 8px;
         font-size: 15px;
         transition: all 0.3s;
         box-sizing: border-box;
     }

     .dropdown-arrow {
         position: absolute;
         right: 15px;
         top: 50%;
         transform: translateY(-50%);
         pointer-events: none;
         color: #666;
         font-size: 12px;
         transition: all 0.2s;
     }

     .select-dropdown:focus + .dropdown-arrow {
         color: #5cb85c;
         transform: translateY(-50%) rotate(180deg);
     }

     .modal-footer {
         padding: 16px 24px;
         border-top: 1px solid #eee;
         display: flex;
         justify-content: flex-end;
         gap: 12px;
         flex-shrink: 0;
     }

     .btn {
         padding: 10px 20px;
         border: none;
         border-radius: 8px;
         font-size: 15px;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.3s;
     }

     .btn-cancel {
         background: #f5f5f5;
         color: #666;
     }

         .btn-cancel:hover {
             background: #e0e0e0;
         }

     .btn-save,
     .btn-primary {
         background: #5cb85c;
         color: white;
     }

         .btn-save:hover,
         .btn-primary:hover:not([disabled]) {
             background: #4cae4c;
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(92, 184, 92, 0.3);
         }

         .btn-primary[disabled] {
             opacity: 0.7;
             cursor: not-allowed;
         }

     .form-row {
         display: flex;
         gap: 15px;
     }

         .form-row .form-group {
             flex: 1;
         }

     .required::after {
         content: " *";
         color: #e74c3c;
     }

     .divider {
         height: 1px;
         background-color: #eee;
         margin: 20px 0;
         border: none;
     }

     .confirmation-modal {
         max-width: 500px;
     }

     .confirmation-content {
         text-align: center;
         padding: 10px 0;
     }

     .confirmation-icon {
         font-size: 64px;
         margin-bottom: 20px;
     }

     .confirmation-content h3 {
         margin: 0 0 15px 0;
         color: #333;
         font-size: 24px;
     }

     .confirmation-content p {
         margin: 10px 0;
         color: #666;
         line-height: 1.5;
     }

     .confirmation-warning {
         color: #e74c3c !important;
         font-weight: 600;
         background: #ffeaa7;
         padding: 10px;
         border-radius: 8px;
         margin-top: 15px !important;
     }

     .btn-danger {
         background: #e74c3c;
         color: white;
     }

         .btn-danger:hover {
             background: #c0392b;
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
         }

     /* QR Code Styles */
     .qr-code-section {
         margin-top: 20px;
     }

         .qr-code-section h4 {
             margin-bottom: 15px;
             color: #333;
             font-size: 18px;
         }

     .qr-code-container {
         background: #f8f9fa;
         border-radius: 8px;
         padding: 20px;
         border: 1px solid #e9ecef;
     }

     .qr-code-display {
         text-align: center;
     }

     .qr-header {
         margin-bottom: 15px;
     }

         .qr-header strong {
             display: block;
             font-size: 16px;
             color: #333;
         }

         .qr-header small {
             color: #666;
             font-size: 12px;
         }

     .qr-image-container {
         margin: 15px 0;
         text-align: center;
     }

     .qr-image {
         width: 200px;
         height: 200px;
         border: 1px solid #ddd;
         border-radius: 8px;
         padding: 10px;
         background: white;
     }

     .qr-instructions {
         margin: 10px 0;
         color: #666;
     }

     .qr-actions {
         display: flex;
         gap: 8px;
         justify-content: center;
         flex-wrap: wrap;
     }

     .btn-sm {
         padding: 6px 12px;
         font-size: 12px;
     }

     .btn-outline-primary {
         background: transparent;
         border: 1px solid #3498db;
         color: #3498db;
     }

         .btn-outline-primary:hover {
             background: #3498db;
             color: white;
         }

     .btn-outline-secondary {
         background: transparent;
         border: 1px solid #95a5a6;
         color: #95a5a6;
     }

         .btn-outline-secondary:hover {
             background: #95a5a6;
             color: white;
         }

     .btn-outline-info {
         background: transparent;
         border: 1px solid #17a2b8;
         color: #17a2b8;
     }

         .btn-outline-info:hover {
             background: #17a2b8;
             color: white;
         }

     /* Expired/Inactive Members Section */
     .expired-section {
         margin-top: 40px;
         padding-top: 30px;
         border-top: 2px solid #e9ecef;
     }

     .section-header {
         margin-bottom: 20px;
     }

     .section-title {
         font-size: 20px;
         font-weight: 600;
         color: #234060;
         margin: 0 0 5px 0;
     }

     .section-subtitle {
         font-size: 14px;
         color: #666;
         margin: 0;
     }

     .expired-table {
        margin-top: 0; /* align header gap with active members table */
     }

     .expired-table tbody tr {
         background: #fff5f5;
     }

     .expired-table tbody tr:hover {
         background: #ffeaea;
     }

     .expiration-expired {
         color: #e74c3c;
         font-weight: 600;
     }

     .renew-btn {
         background: #FFA500;
         color: white;
         border: none;
         padding: 8px 16px;
         border-radius: 6px;
         font-size: 13px;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.2s;
     }

     .renew-btn:hover {
            background: #ff8c00;
         transform: translateY(-1px);
         box-shadow: 0 4px 12px rgba(255,165,0,0.3);
     }

     .renew-btn:active {
         transform: translateY(0);
     }

     /* Pagination Styles */
     .pagination-container {
         display: flex;
         justify-content: space-between;
         align-items: center;
         padding: 20px;
         background: white;
         border-top: 1px solid #e9ecef;
         margin-top: 0;
     }

     .pagination-info {
         color: #666;
         font-size: 14px;
     }

     .pagination-controls {
         display: flex;
         gap: 8px;
         align-items: center;
     }

     .pagination-btn {
         min-width: 40px;
         height: 40px;
         padding: 8px 12px;
         border: 1px solid #dee2e6;
         background: white;
         color: #234060;
         border-radius: 6px;
         cursor: pointer;
         font-size: 14px;
         font-weight: 500;
         transition: all 0.2s ease;
         display: flex;
         align-items: center;
         justify-content: center;
     }

     .pagination-btn:hover:not(:disabled) {
         background: #f8f9fa;
         border-color: #234060;
         transform: translateY(-1px);
     }

     .pagination-btn.active {
         background: #234060;
         color: white;
         border-color: #234060;
         font-weight: 600;
     }

     .pagination-btn:disabled {
         opacity: 0.5;
         cursor: not-allowed;
         background: #f8f9fa;
     }

     .pagination-btn:disabled:hover {
         transform: none;
         border-color: #dee2e6;
     }

     .pagination-ellipsis {
         padding: 0 8px;
         color: #666;
         font-weight: 500;
     }

     .price-breakdown {
         background: #f8f9fa;
         border: 1px solid #e9ecef;
         border-radius: 8px;
         padding: 15px;
         margin-top: 15px;
     }

     .price-row {
         display: flex;
         justify-content: space-between;
         align-items: center;
         padding: 8px 0;
         border-bottom: 1px solid #e9ecef;
     }

     .price-row:last-child {
         border-bottom: none;
         margin-top: 5px;
         padding-top: 12px;
         border-top: 2px solid #dee2e6;
     }

     .price-original {
         color: #666;
     }

     .price-discount {
         color: #5cb85c;
         font-weight: 600;
     }

     .price-final {
         color: #234060;
         font-size: 1.1em;
     }

     .total-row {
         font-size: 1.05em;
     }

     .promo-description {
         display: block;
         margin-top: 5px;
         font-size: 12px;
         color: #666;
         font-style: italic;
     }

     .general-error {
         background: #fff3cd;
         border: 1px solid #ffeeba;
         padding: 10px 14px;
         border-radius: 8px;
         color: #856404;
         margin-bottom: 15px;
     }

     .paymongo-info {
         background: #e3f2fd;
         border: 1px solid #90caf9;
         border-radius: 6px;
         padding: 12px;
         margin-top: 8px;
     }

     .paymongo-info p {
         margin: 0;
         font-size: 13px;
         color: #1976d2;
         line-height: 1.4;
     }

     .paymongo-info strong {
         color: #1565c0;
     }

     .btn-verify {
         background: #2196F3;
         color: white;
     }

     .btn-verify:hover {
         background: #1976D2;
         transform: translateY(-1px);
         box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
     }

     .btn-verify:disabled {
         opacity: 0.6;
         cursor: not-allowed;
     }

    .info-box {
        display: flex;
        gap: 12px;
        padding: 12px;
        border: 1px dashed #cfd8dc;
        border-radius: 8px;
        background: #f8fbff;
        color: #546e7a;
    }

    .info-icon {
        font-size: 20px;
        line-height: 1;
    }

    .info-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-content p {
        margin: 0;
        font-size: 13px;
    }

     /* QR Modal Styles */
     .qr-modal {
         max-width: 500px;
     }

     .qr-code-display-full {
         text-align: center;
         padding: 20px;
     }

     .qr-header-full h4 {
         margin: 0 0 5px 0;
         color: #333;
     }

     .qr-image-container-full {
         margin: 20px 0;
         text-align: center;
     }

     .qr-image-full {
         width: 250px;
         height: 250px;
         border: 2px solid #3498db;
         border-radius: 12px;
         padding: 15px;
         background: white;
     }

     .qr-loading {
         padding: 40px;
         color: #666;
         font-style: italic;
     }

     .qr-instructions-full {
         margin: 15px 0;
         color: #666;
     }

     .qr-actions-full {
         display: flex;
         gap: 10px;
         justify-content: center;
         flex-wrap: wrap;
     }

     @@media (max-width: 768px) {
         .action-buttons {
             flex-direction: column;
             gap: 4px;
         }

         .action-btn {
             width: 32px;
             height: 32px;
         }

         .action-icon {
             width: 16px;
             height: 16px;
         }

         .header-actions {
             flex-direction: column;
             gap: 10px;
             align-items: flex-start;
         }

         .search-bar {
             width: 100%;
         }

         .confirmation-modal {
             max-width: 95%;
         }

         .confirmation-icon {
             font-size: 48px;
         }

         .confirmation-content h3 {
             font-size: 20px;
         }

         .qr-modal {
             max-width: 95%;
         }

         .qr-actions-full {
             flex-direction: column;
         }
     }
</style>

@code {
    private string currentUserRole = "";
    private string searchQuery = "";
    private string expiredSearchQuery = "";
    
    // Pagination variables
    private int currentActivePage = 1;
    private int currentInactivePage = 1;
    private const int itemsPerPage = 10;
    
    private bool showModal = false;
    private bool isEditMode = false;
    private bool showValidationError = false;
    private bool isLoading = false;
    private Member currentMember = new Member
    {
        MembershipTypeID = 0,
        Status = "Active"
    };
    private List<Member> members = new List<Member>();
    private List<Member> filteredMembers = new List<Member>();
    private List<Member> expiredInactiveMembers = new List<Member>();
    private List<string> validationErrors = new List<string>();
    private bool showArchiveConfirmation = false;
    private Member? selectedMember;
    private List<Trainer> availableTrainers = new List<Trainer>();
    private List<Trainer> availableRenewTrainers = new();
    private List<TrainerSchedule> trainerSchedules = new();
    private List<TrainerSchedule> visibleTrainerSchedules = new();
    private List<TrainerSchedule> visibleRenewTrainerSchedules = new();
    private bool lockIdentityFields => isEditMode && (currentUserRole == "admin" || currentUserRole == "staff");
    private int selectedTrainerScheduleId = 0;
    private bool isInitializingTrainerSelection = false;
    // Renew modal trainer selection
    private int? renewTrainerId;
    private int? renewTrainerScheduleId;
    private List<project.Models.MembershipType> availableMembershipTypes = new List<project.Models.MembershipType>();
    private List<Promotion> activePromotions = new List<Promotion>();

    // QR Code Variables
    private byte[]? qrCodeImage;
    private byte[]? selectedMemberQrImage;
    private bool showQrModal = false;

    // Renew Membership Variables
    private bool showRenewModal = false;
    private Member? memberToRenew;
    private int renewMembershipTypeId = 0;
    private project.Models.MembershipType? renewMembershipType;
    private string renewPaymentMethod = "Cash";
    private int renewPromotionId = 0;
    private Promotion? selectedRenewPromotion;
    private decimal renewDiscountAmount = 0;
    private decimal renewFinalPrice = 0;
    private bool isRenewing = false;
    private string? renewError;
    private List<string> renewErrors = new List<string>();
    
    // PayMongo payment variables for renewal
    private bool isProcessingRenewalPayment = false;
    private bool isVerifyingRenewalPayment = false;
    private string? renewalPayMongoCheckoutUrl = null;
    private string? pendingRenewalPaymentIntentId = null;
    private string? pendingRenewalPaymentLinkId = null;
    private bool showVerifyRenewalPaymentButton = false;
    private System.Threading.Timer? renewalPaymentCheckTimer = null;

    // Pagination computed properties
    private List<Member> paginatedActiveMembers => 
        filteredMembers.Skip((currentActivePage - 1) * itemsPerPage).Take(itemsPerPage).ToList();

    private List<Member> paginatedInactiveMembers => 
        expiredInactiveMembers.Skip((currentInactivePage - 1) * itemsPerPage).Take(itemsPerPage).ToList();

    private int totalActivePages => 
        filteredMembers.Count == 0 ? 1 : (int)Math.Ceiling((double)filteredMembers.Count / itemsPerPage);

    private int totalInactivePages => 
        expiredInactiveMembers.Count == 0 ? 1 : (int)Math.Ceiling((double)expiredInactiveMembers.Count / itemsPerPage);

    protected override async Task OnInitializedAsync()
    {
        // Get current user role for edit permissions
        currentUserRole = (await AuthService.GetCurrentUserRole())?.ToLower() ?? "";

        await ReleaseCompletedTrainerSchedulesAsync();
        await LoadMembersFromDatabase();
        await LoadTrainersFromDatabase();
        await LoadTrainerSchedules();
        await LoadMembershipTypesFromDatabase();
        await LoadActivePromotions();
    }

    private async Task LoadActivePromotions()
    {
        try
        {
            var today = DateTime.Today;
            activePromotions = await Context.Promotions
                .AsNoTracking()
                .Where(p => p.EndDate >= today && !p.IsArchived)
                .OrderByDescending(p => p.DiscountRate)
                .ThenByDescending(p => p.StartDate)
                .ToListAsync();
        }
        catch (Exception)
        {
            activePromotions = new List<Promotion>();
        }
    }

    private async Task LoadTrainersFromDatabase(int? includeTrainerId = null)
    {
        try
        {
            availableTrainers = await FetchAvailableTrainersAsync(includeTrainerId);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading trainers: {ex.Message}");
        }
    }

    private async Task LoadRenewTrainersAsync(int? includeTrainerId = null)
    {
        try
        {
            availableRenewTrainers = await FetchAvailableTrainersAsync(includeTrainerId);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading trainers: {ex.Message}");
        }
    }

    private async Task<List<Trainer>> FetchAvailableTrainersAsync(int? includeTrainerId = null)
    {
        var bookedScheduleIdsQuery = GetBookedTrainerScheduleIdsQuery();

        // Get IDs of trainers that currently have at least one available schedule
        var availableTrainerIds = await Context.TrainerSchedules
            .Where(ts => ts.IsAvailable && !bookedScheduleIdsQuery.Contains(ts.TrainerScheduleID))
            .Select(ts => ts.TrainerID)
            .Distinct()
            .ToListAsync();

        IQueryable<Trainer> trainersQuery = Context.Trainers.AsNoTracking();

        // If there are trainers with available schedules, show only them.
        // If there are none, fall back to showing ALL trainers so the dropdown is never empty.
        if (availableTrainerIds.Any())
        {
            trainersQuery = trainersQuery.Where(t => availableTrainerIds.Contains(t.TrainerID));
        }

        var trainersList = await trainersQuery
            .OrderBy(t => t.LastName)
            .ThenBy(t => t.FirstName)
            .ToListAsync();

        // When editing a member, ensure their current trainer is always in the list
        if (includeTrainerId.HasValue && !trainersList.Any(t => t.TrainerID == includeTrainerId.Value))
        {
            var currentTrainer = await Context.Trainers
                .AsNoTracking()
                .FirstOrDefaultAsync(t => t.TrainerID == includeTrainerId.Value);
            if (currentTrainer != null)
            {
                trainersList.Add(currentTrainer);
                trainersList = trainersList
                    .OrderBy(t => t.LastName)
                    .ThenBy(t => t.FirstName)
                    .ToList();
            }
        }

        return trainersList;
    }

    private async Task LoadTrainerSchedules(int? includeScheduleId = null)
    {
        try
        {
            var bookedScheduleIdsQuery = GetBookedTrainerScheduleIdsQuery();
            IQueryable<TrainerSchedule> query = Context.TrainerSchedules
                .AsNoTracking()
                .Include(ts => ts.Trainer);

            if (includeScheduleId.HasValue)
            {
                query = query.Where(ts =>
                    ts.TrainerScheduleID == includeScheduleId.Value ||
                    (ts.IsAvailable && !bookedScheduleIdsQuery.Contains(ts.TrainerScheduleID)));
            }
            else
            {
                query = query.Where(ts => ts.IsAvailable && !bookedScheduleIdsQuery.Contains(ts.TrainerScheduleID));
            }

            trainerSchedules = await query
                .OrderBy(ts => ts.DayOfWeek)
                .ThenBy(ts => ts.StartTime)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading trainer schedules: {ex.Message}");
        }
    }

    private async Task LoadMembershipTypesFromDatabase()
    {
        try
        {
            // Load all membership types (not just Basic and Premium, exclude archived)
            availableMembershipTypes = await Context.MembershipTypes
                .Where(mt => mt.IsArchived == false)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading membership types: {ex.Message}");
        }
    }

    private async Task LoadMembersFromDatabase()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // First, check and update expired memberships
            await CheckAndUpdateExpiredMemberships();
            
            // Load members with related data (exclude archived)
            members = await Context.Members
                .Where(m => m.IsArchived == false)
                .Include(m => m.Trainer)
                .Include(m => m.TrainerSchedule)
                .Include(m => m.MembershipType)
                .Include(m => m.Payments)
                .ToListAsync();
            
            // Calculate expiration dates for members that don't have one
            bool hasChanges = false;
            foreach (var member in members)
            {
                if (!member.ExpirationDate.HasValue && member.MembershipType != null)
                {
                    member.ExpirationDate = member.JoinDate.AddDays(member.MembershipType.DurationInDays);
                    hasChanges = true;
                }
            }
            
            if (hasChanges)
            {
                await Context.SaveChangesAsync();
                // Reload to get updated data
                members = await Context.Members
                    .Where(m => m.IsArchived == false)
                    .Include(m => m.Trainer)
                    .Include(m => m.TrainerSchedule)
                    .Include(m => m.MembershipType)
                    .Include(m => m.Payments)
                    .ToListAsync();
            }
            
            // Separate active and expired/inactive members
            var today = DateTime.Today;
            filteredMembers = members.Where(m => 
                m.Status == "Active" && 
                (m.ExpirationDate == null || m.ExpirationDate.Value.Date > today)
            ).ToList();

            expiredInactiveMembers = members.Where(m => 
                m.Status == "Inactive" || 
                (m.ExpirationDate.HasValue && m.ExpirationDate.Value.Date <= today)
            ).OrderByDescending(m => m.ExpirationDate ?? DateTime.MinValue)
            .ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading members: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private DateTime? CalculateExpirationDate(DateTime joinDate, int membershipTypeID)
    {
        var membershipType = availableMembershipTypes.FirstOrDefault(mt => mt.MembershipTypeID == membershipTypeID);
        if (membershipType != null)
        {
            return joinDate.AddDays(membershipType.DurationInDays);
        }
        return null;
    }

    private string GetExpirationClass(DateTime expirationDate)
    {
        var daysUntilExpiration = (expirationDate.Date - DateTime.Today).Days;
        
        if (daysUntilExpiration < 0)
            return "expiration-expired"; // Already expired
        else if (daysUntilExpiration <= 7)
            return "expiration-warning"; // Expiring soon (within 7 days)
        else if (daysUntilExpiration <= 30)
            return "expiration-approaching"; // Approaching expiration (within 30 days)
        else
            return "expiration-valid"; // Valid membership
    }

    private string GetStatusClass(Member member)
    {
        // Check if membership is expired based on expiration date
        if (member.ExpirationDate.HasValue && member.ExpirationDate.Value.Date <= DateTime.Today)
        {
            return "status-inactive";
        }

        return member.Status.ToLower() switch
        {
            "active" => "status-active",
            "inactive" => "status-inactive",
            "suspended" => "status-suspended",
            _ => "status-active"
        };
    }

    private string GetStatusText(Member member)
    {
        if (member.ExpirationDate.HasValue && member.ExpirationDate.Value.Date <= DateTime.Today)
            return "Inactive";
        else
            return member.Status;
    }

    private string GetInitials(string firstName, string lastName)
    {
        return $"{firstName?.FirstOrDefault()}{lastName?.FirstOrDefault()}".ToUpper();
    }

    // Helper method to format name for display with proper capitalization
    private string GetDisplayName(string firstName, string middleInitial, string lastName)
    {
        var parts = new List<string>();
        if (!string.IsNullOrWhiteSpace(firstName))
            parts.Add(CapitalizeName(firstName));
        if (!string.IsNullOrWhiteSpace(middleInitial))
            parts.Add(CapitalizeName(middleInitial));
        if (!string.IsNullOrWhiteSpace(lastName))
            parts.Add(CapitalizeName(lastName));
        
        return string.Join(" ", parts);
    }

    // Pagination methods for Active Members
    private void GoToActivePage(int page)
    {
        if (page >= 1 && page <= totalActivePages)
        {
            currentActivePage = page;
            StateHasChanged();
        }
    }

    private void PreviousActivePage()
    {
        if (currentActivePage > 1)
        {
            currentActivePage--;
            StateHasChanged();
        }
    }

    private void NextActivePage()
    {
        if (currentActivePage < totalActivePages)
        {
            currentActivePage++;
            StateHasChanged();
        }
    }

    // Pagination methods for Inactive Members
    private void GoToInactivePage(int page)
    {
        if (page >= 1 && page <= totalInactivePages)
        {
            currentInactivePage = page;
            StateHasChanged();
        }
    }

    private void PreviousInactivePage()
    {
        if (currentInactivePage > 1)
        {
            currentInactivePage--;
            StateHasChanged();
        }
    }

    private void NextInactivePage()
    {
        if (currentInactivePage < totalInactivePages)
        {
            currentInactivePage++;
            StateHasChanged();
        }
    }

    // Helper method to get page numbers to display
    private List<int> GetPageNumbers(int currentPage, int totalPages)
    {
        var pages = new List<int>();
        int maxPagesToShow = 7;
        
        if (totalPages <= maxPagesToShow)
        {
            // Show all pages if total is less than max
            for (int i = 1; i <= totalPages; i++)
            {
                pages.Add(i);
            }
        }
        else
        {
            // Show pages with ellipsis
            if (currentPage <= 4)
            {
                // Show first 5 pages, ellipsis, last page
                for (int i = 1; i <= 5; i++)
                {
                    pages.Add(i);
                }
                pages.Add(-1); // -1 represents ellipsis
                pages.Add(totalPages);
            }
            else if (currentPage >= totalPages - 3)
            {
                // Show first page, ellipsis, last 5 pages
                pages.Add(1);
                pages.Add(-1); // -1 represents ellipsis
                for (int i = totalPages - 4; i <= totalPages; i++)
                {
                    pages.Add(i);
                }
            }
            else
            {
                // Show first page, ellipsis, current-1, current, current+1, ellipsis, last page
                pages.Add(1);
                pages.Add(-1); // -1 represents ellipsis
                for (int i = currentPage - 1; i <= currentPage + 1; i++)
                {
                    pages.Add(i);
                }
                pages.Add(-1); // -1 represents ellipsis
                pages.Add(totalPages);
            }
        }
        
        return pages;
    }

    private void HandleSearch()
    {
        // Reset pagination to first page when search changes
        currentActivePage = 1;
        
        var today = DateTime.Today;
        
        // First, get only ACTIVE members (not expired) for the active table search
        var activeMembersOnly = members.Where(m => 
            m.Status == "Active" && 
            (m.ExpirationDate == null || m.ExpirationDate.Value.Date > today)
        ).ToList();

        // Apply search filter ONLY to active members
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            var query = searchQuery.Trim();
            filteredMembers = activeMembersOnly.Where(m =>
            {
                // Check individual name parts
                var matchesFirstName = m.FirstName.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesLastName = m.LastName.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesMiddleInitial = !string.IsNullOrEmpty(m.MiddleInitial) && 
                                         m.MiddleInitial.Contains(query, StringComparison.OrdinalIgnoreCase);
                
                // Check full display name (FirstName + MiddleInitial + LastName)
                var fullDisplayName = GetDisplayName(m.FirstName, m.MiddleInitial, m.LastName);
                var matchesFullName = fullDisplayName.Contains(query, StringComparison.OrdinalIgnoreCase);
                
                // Check other fields
                var matchesEmail = m.Email.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesContact = m.ContactNumber.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesAddress = m.Address.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesTrainer = m.Trainer != null && m.Trainer.FullName.Contains(query, StringComparison.OrdinalIgnoreCase);
                
                return matchesFirstName || matchesLastName || matchesMiddleInitial || matchesFullName ||
                       matchesEmail || matchesContact || matchesAddress || matchesTrainer;
            }).ToList();
        }
        else
        {
            // If no search query, show all active members
            filteredMembers = activeMembersOnly;
        }

        // Keep expired/inactive members separate (don't change them during active search)
        // Only update if expired search query is being used
        if (string.IsNullOrWhiteSpace(expiredSearchQuery))
        {
            expiredInactiveMembers = members.Where(m => 
                m.Status == "Inactive" || 
                (m.ExpirationDate.HasValue && m.ExpirationDate.Value.Date <= today)
            ).OrderByDescending(m => m.ExpirationDate ?? DateTime.MinValue)
            .ToList();
        }
    }

    private void FilterExpiredMembers()
    {
        // Reset pagination to first page when search changes
        currentInactivePage = 1;
        
        var today = DateTime.Today;
        var baseQuery = members.Where(m =>
            m.Status == "Inactive" ||
            (m.ExpirationDate.HasValue && m.ExpirationDate.Value.Date <= today));

        if (!string.IsNullOrWhiteSpace(expiredSearchQuery))
        {
            var query = expiredSearchQuery.Trim();
            baseQuery = baseQuery.Where(m =>
            {
                // Check individual name parts
                var matchesFirstName = m.FirstName.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesLastName = m.LastName.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesMiddleInitial = !string.IsNullOrEmpty(m.MiddleInitial) && 
                                         m.MiddleInitial.Contains(query, StringComparison.OrdinalIgnoreCase);
                
                // Check full display name (FirstName + MiddleInitial + LastName)
                var fullDisplayName = GetDisplayName(m.FirstName, m.MiddleInitial, m.LastName);
                var matchesFullName = fullDisplayName.Contains(query, StringComparison.OrdinalIgnoreCase);
                
                // Check other fields
                var matchesEmail = m.Email.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesContact = m.ContactNumber.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesAddress = m.Address.Contains(query, StringComparison.OrdinalIgnoreCase);
                var matchesTrainer = m.Trainer != null && m.Trainer.FullName.Contains(query, StringComparison.OrdinalIgnoreCase);
                
                return matchesFirstName || matchesLastName || matchesMiddleInitial || matchesFullName ||
                       matchesEmail || matchesContact || matchesAddress || matchesTrainer;
            });
        }

        expiredInactiveMembers = baseQuery
            .OrderByDescending(m => m.ExpirationDate ?? DateTime.MinValue)
        .ToList();
    }

    private void OnTrainerSelectionChanged()
    {
        if (currentMember.TrainerID.HasValue)
        {
            visibleTrainerSchedules = trainerSchedules
                .Where(ts => ts.TrainerID == currentMember.TrainerID.Value)
                .ToList();

            if (isInitializingTrainerSelection &&
                currentMember.TrainerScheduleID.HasValue &&
                visibleTrainerSchedules.Any(ts => ts.TrainerScheduleID == currentMember.TrainerScheduleID.Value))
            {
                selectedTrainerScheduleId = currentMember.TrainerScheduleID.Value;
            }
            else
            {
                selectedTrainerScheduleId = 0;
                currentMember.TrainerScheduleID = null;
            }
        }
        else
        {
            visibleTrainerSchedules = new();
            selectedTrainerScheduleId = 0;
            currentMember.TrainerScheduleID = null;
        }

        OnTrainerScheduleChanged();
    }

    private void OnTrainerScheduleChanged()
    {
        currentMember.TrainerScheduleID = selectedTrainerScheduleId > 0
            ? selectedTrainerScheduleId
            : null;
    }

    private void OnRenewTrainerChanged()
    {
        UpdateRenewVisibleTrainerSchedules();
        StateHasChanged();
    }

    private void UpdateRenewVisibleTrainerSchedules()
    {
        if (renewTrainerId.HasValue)
        {
            visibleRenewTrainerSchedules = trainerSchedules
                .Where(ts => ts.TrainerID == renewTrainerId.Value)
                .ToList();

            if (!visibleRenewTrainerSchedules.Any(ts => ts.TrainerScheduleID == renewTrainerScheduleId))
            {
                renewTrainerScheduleId = null;
            }
        }
        else
        {
            visibleRenewTrainerSchedules = new();
            renewTrainerScheduleId = null;
        }
    }

    private void OnRenewTrainerScheduleChanged()
    {
        // Intentionally left blank - binding updates renewTrainerScheduleId
    }

    private async Task OpenAddMemberModal()
    {
        isEditMode = false;
        currentMember = new Member
        {
            JoinDate = DateTime.Now,
            Status = "Active",
            MembershipTypeID = 0, // Start with no selection
            TrainerID = null,
            ExpirationDate = null,
            TrainerScheduleID = null
        };
        showValidationError = false;
        validationErrors.Clear();
        qrCodeImage = null;
        showModal = true;
        await LoadTrainersFromDatabase(null);
        await LoadTrainerSchedules();
        selectedTrainerScheduleId = 0;
        visibleTrainerSchedules = new();
        isInitializingTrainerSelection = false;
        OnTrainerSelectionChanged();
        StateHasChanged();
    }

    private async Task EditMember(Member member)
    {
        isEditMode = true;
        
        // Load full member data including StudentIDImage and MembershipType
        var fullMember = await Context.Members
            .Include(m => m.MembershipType)
            .FirstOrDefaultAsync(m => m.MemberID == member.MemberID);
        
        if (fullMember == null)
        {
            ToastService.ShowError("Member not found");
            return;
        }
        
        currentMember = new Member
        {
            MemberID = fullMember.MemberID,
            FirstName = fullMember.FirstName,
            MiddleInitial = fullMember.MiddleInitial,
            LastName = fullMember.LastName,
            ContactNumber = fullMember.ContactNumber,
            Email = fullMember.Email,
            Address = fullMember.Address,
            JoinDate = fullMember.JoinDate,
            ExpirationDate = fullMember.ExpirationDate,
            Status = fullMember.Status,
            MembershipTypeID = fullMember.MembershipTypeID,
            TrainerID = fullMember.TrainerID,
            TrainerScheduleID = fullMember.TrainerScheduleID,
            LeadSource = fullMember.LeadSource,
            StudentIDImage = fullMember.StudentIDImage,
            MembershipType = fullMember.MembershipType
        };
        showValidationError = false;
        validationErrors.Clear();

        // Only generate QR code if not a student member with ID
        if (!IsStudentMemberWithID())
        {
            await GenerateQrCodeForMember();
        }
        
        selectedTrainerScheduleId = fullMember.TrainerScheduleID ?? 0;
        await LoadTrainersFromDatabase(currentMember.TrainerID);
        await LoadTrainerSchedules(selectedTrainerScheduleId == 0 ? null : selectedTrainerScheduleId);
        isInitializingTrainerSelection = true;
        OnTrainerSelectionChanged();
        isInitializingTrainerSelection = false;
        showModal = true;
        StateHasChanged();
    }

    private bool IsStudentMemberWithID()
    {
        if (currentMember?.MembershipType == null)
            return false;
        
        var isStudent = currentMember.MembershipType.TypeName.ToLowerInvariant().Contains("student");
        var hasStudentID = currentMember.StudentIDImage != null && currentMember.StudentIDImage.Length > 0;
        
        return isStudent && hasStudentID;
    }

    private async void ShowQrCode(Member member)
    {
        selectedMember = member;
        var qrImage = await MemberService.GenerateMemberQrCodeAsync(member.MemberID);
        if (qrImage != null)
        {
            selectedMemberQrImage = qrImage;
            showQrModal = true;
            StateHasChanged();
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Failed to generate QR code.");
        }
    }

    private void CloseQrModal()
    {
        showQrModal = false;
        selectedMember = null;
        selectedMemberQrImage = null;
        StateHasChanged();
    }

    private void ShowArchiveConfirmation(Member member)
    {
        selectedMember = member;
        showArchiveConfirmation = true;
        StateHasChanged();
    }

    private void CloseArchiveConfirmation()
    {
        showArchiveConfirmation = false;
        selectedMember = null;
        StateHasChanged();
    }

    private async Task ConfirmArchive()
    {
        if (selectedMember != null)
        {
            try
            {
                var previousScheduleId = selectedMember.TrainerScheduleID;
                selectedMember.IsArchived = true;
                selectedMember.Status = "Inactive"; // Set status to Inactive when archiving
                Context.Members.Update(selectedMember);
                await UpdateTrainerScheduleAvailability(previousScheduleId, null);
                await Context.SaveChangesAsync();
                
                // Log audit action
                var memberName = $"{selectedMember.FirstName} {selectedMember.LastName}";
                await LogAuditAction("Member Archived", "Member", selectedMember.MemberID, memberName, $"Archived member: {memberName}");
                
                await LoadMembersFromDatabase();
                await LoadTrainersFromDatabase();
                CloseArchiveConfirmation();
                // Use warning type for destructive-but-successful actions (red background with check)
                ToastService.ShowWarning("Archived successfully");
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Error archiving member: {ex.Message}");
            }
        }
    }

    private bool ValidateForm()
    {
        validationErrors.Clear();

        if (string.IsNullOrWhiteSpace(currentMember.FirstName))
            validationErrors.Add("FirstName");

        if (string.IsNullOrWhiteSpace(currentMember.LastName))
            validationErrors.Add("LastName");

        if (string.IsNullOrWhiteSpace(currentMember.ContactNumber))
            validationErrors.Add("ContactNumber");
        else
        {
            // Validate contact number is exactly 11 digits
            var digitsOnly = new string(currentMember.ContactNumber.Where(char.IsDigit).ToArray());
            if (digitsOnly.Length != 11)
            {
                validationErrors.Add("ContactNumber");
            }
            else
            {
                currentMember.ContactNumber = digitsOnly;
            }
        }

        if (string.IsNullOrWhiteSpace(currentMember.Email))
            validationErrors.Add("Email");
        else
        {
            // Validate email format - must contain @ symbol and domain
            var email = currentMember.Email.Trim();
            if (!email.Contains("@") || email.IndexOf("@") == 0 || email.IndexOf("@") == email.Length - 1)
            {
                // Email must have @ symbol, and it can't be at the start or end
                validationErrors.Add("Email");
            }
            else
            {
                // Split by @ and check domain part exists
                var parts = email.Split('@');
                if (parts.Length != 2 || string.IsNullOrWhiteSpace(parts[0]) || string.IsNullOrWhiteSpace(parts[1]))
                {
                    validationErrors.Add("Email");
                }
                else
                {
                    // Check if domain part contains at least a dot (e.g., gmail.com)
                    if (!parts[1].Contains("."))
                    {
                        validationErrors.Add("Email");
                    }
                    else
                    {
                        // Final validation using EmailAddressAttribute
                        var emailAttribute = new EmailAddressAttribute();
                        if (!emailAttribute.IsValid(email))
                        {
                            validationErrors.Add("Email");
                        }
                    }
                }
            }
        }

        if (string.IsNullOrWhiteSpace(currentMember.Address))
            validationErrors.Add("Address");

        if (currentMember.JoinDate == DateTime.MinValue)
            validationErrors.Add("JoinDate");

        if (currentMember.MembershipTypeID <= 0)
            validationErrors.Add("MembershipTypeID");

        if (currentMember.TrainerID.HasValue)
        {
            if (selectedTrainerScheduleId <= 0)
            {
                validationErrors.Add("TrainerScheduleID");
            }
        }
        else
        {
            currentMember.TrainerScheduleID = null;
            selectedTrainerScheduleId = 0;
        }

        showValidationError = validationErrors.Any();
        return !showValidationError;
    }

    private bool HasError(string fieldName)
    {
        return validationErrors.Contains(fieldName);
    }

    private string ContactNumberInput
    {
        get => currentMember.ContactNumber;
        set
        {
            // Strip non-numeric characters and limit to 11 digits
            var digits = new string((value ?? string.Empty).Where(char.IsDigit).Take(11).ToArray());
            currentMember.ContactNumber = digits;
        }
    }

    // Helper method to capitalize first letter of each name
    private string CapitalizeName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return name;
        
        name = name.Trim();
        if (name.Length == 0)
            return name;
        
        // Capitalize first letter, lowercase the rest
        return char.ToUpper(name[0]) + (name.Length > 1 ? name.Substring(1).ToLower() : "");
    }

    private async Task SaveMember()
    {
        if (!ValidateForm())
        {
            StateHasChanged();
            return;
        }

        // Capitalize names before saving
        currentMember.FirstName = CapitalizeName(currentMember.FirstName);
        if (!string.IsNullOrWhiteSpace(currentMember.MiddleInitial))
        {
            currentMember.MiddleInitial = CapitalizeName(currentMember.MiddleInitial);
        }
        currentMember.LastName = CapitalizeName(currentMember.LastName);

        try
        {
            if (isEditMode)
            {
                var existingMember = await Context.Members.FindAsync(currentMember.MemberID);
                if (existingMember != null)
                {
                    // Check if anything actually changed; if not, do nothing
                    bool hasChanges =
                        existingMember.FirstName != currentMember.FirstName ||
                        existingMember.MiddleInitial != currentMember.MiddleInitial ||
                        existingMember.LastName != currentMember.LastName ||
                        existingMember.ContactNumber != currentMember.ContactNumber ||
                        existingMember.Email != currentMember.Email ||
                        existingMember.Address != currentMember.Address ||
                        existingMember.JoinDate != currentMember.JoinDate ||
                        existingMember.MembershipTypeID != currentMember.MembershipTypeID ||
                        existingMember.TrainerID != currentMember.TrainerID ||
                        existingMember.TrainerScheduleID != currentMember.TrainerScheduleID ||
                        existingMember.LeadSource != currentMember.LeadSource;

                    if (!hasChanges)
                    {
                        ToastService.ShowInfo("No changes to update.");
                        return;
                    }

                    var previousScheduleId = existingMember.TrainerScheduleID;
                    existingMember.FirstName = currentMember.FirstName;
                    existingMember.MiddleInitial = currentMember.MiddleInitial;
                    existingMember.LastName = currentMember.LastName;
                    existingMember.ContactNumber = currentMember.ContactNumber;
                    existingMember.Email = currentMember.Email;
                    existingMember.Address = currentMember.Address;
                    existingMember.JoinDate = currentMember.JoinDate;
                    existingMember.MembershipTypeID = currentMember.MembershipTypeID;
                    existingMember.TrainerID = currentMember.TrainerID;
                    existingMember.TrainerScheduleID = currentMember.TrainerScheduleID;
                    existingMember.LeadSource = currentMember.LeadSource;
                    
                    // Calculate expiration date based on join date and membership type
                    existingMember.ExpirationDate = CalculateExpirationDate(existingMember.JoinDate, existingMember.MembershipTypeID);
                    
                    UpdateMemberStatus(existingMember);
                    await UpdateTrainerScheduleAvailability(previousScheduleId, existingMember.TrainerScheduleID);

                    await Context.SaveChangesAsync();
                    await Task.Delay(100); // Small delay to ensure UI is ready
                    
                    // Log audit action
                    var memberName = $"{existingMember.FirstName} {existingMember.LastName}";
                    await LogAuditAction("Member Updated", "Member", existingMember.MemberID, memberName, $"Updated member: {memberName}");
                    
                    ToastService.ShowSuccess("Updated successfully");
                    await LoadMembersFromDatabase();
                    CloseModal();
                }
            }
            else
            {
                var newMember = new Member
                {
                    FirstName = currentMember.FirstName,
                    MiddleInitial = currentMember.MiddleInitial,
                    LastName = currentMember.LastName,
                    ContactNumber = currentMember.ContactNumber,
                    Email = currentMember.Email,
                    Address = currentMember.Address,
                    JoinDate = currentMember.JoinDate,
                    MembershipTypeID = currentMember.MembershipTypeID,
                    TrainerID = currentMember.TrainerID,
                    TrainerScheduleID = currentMember.TrainerScheduleID,
                    LeadSource = currentMember.LeadSource
                };
                
                // Calculate expiration date based on join date and membership type
                newMember.ExpirationDate = CalculateExpirationDate(newMember.JoinDate, newMember.MembershipTypeID);
                UpdateMemberStatus(newMember);

                Context.Members.Add(newMember);
                await UpdateTrainerScheduleAvailability(null, newMember.TrainerScheduleID);
                await Context.SaveChangesAsync();

                currentMember.MemberID = newMember.MemberID;
                
                // Log audit action
                var memberName = $"{newMember.FirstName} {newMember.LastName}";
                await LogAuditAction("Member Created", "Member", newMember.MemberID, memberName, $"Created new member: {memberName}");
                
                await GenerateQrCodeForMember();
                await Task.Delay(100); // Small delay to ensure UI is ready
                ToastService.ShowSuccess("Added successfully");
                await LoadMembersFromDatabase();
                CloseModal();
            }

            await LoadTrainersFromDatabase();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving member: {ex.Message}");
        }
    }

    private async Task GenerateQrCodeForMember()
    {
        if (currentMember.MemberID > 0)
        {
            qrCodeImage = await MemberService.GenerateMemberQrCodeAsync(currentMember.MemberID);
            StateHasChanged();
        }
    }

    // ADD THIS MISSING METHOD
    private async Task GenerateNewQrCode()
    {
        try
        {
            if (currentMember.MemberID > 0)
            {
                qrCodeImage = await MemberService.GenerateMemberQrCodeAsync(currentMember.MemberID);
                StateHasChanged();
                await JSRuntime.InvokeVoidAsync("alert", "New QR code generated!");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error generating QR code: {ex.Message}");
        }
    }

    private async Task PrintQrCode()
    {
        try
        {
            var imageData = selectedMemberQrImage ?? qrCodeImage;
            if (imageData != null)
            {
                var success = await JSRuntime.InvokeAsync<bool>("printQRCode", Convert.ToBase64String(imageData));
                if (!success)
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Printing failed. Please try again.");
                }
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error printing QR code: {ex.Message}");
        }
    }

    private async Task DownloadQrCode()
    {
        try
        {
            var imageData = selectedMemberQrImage ?? qrCodeImage;
            if (imageData != null)
            {
                var fileName = $"MemberQR_{selectedMember?.MemberID ?? currentMember.MemberID}_{DateTime.Now:yyyyMMddHHmmss}.png";
                var success = await JSRuntime.InvokeAsync<bool>("downloadFile", Convert.ToBase64String(imageData), fileName, "image/png");

                if (success)
                {
                    await JSRuntime.InvokeVoidAsync("alert", "QR code downloaded successfully!");
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Failed to download QR code.");
                }
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error downloading QR code: {ex.Message}");
        }
    }

    private void CloseModal()
    {
        showModal = false;
        currentMember = new Member
        {
            MembershipTypeID = 1,
            TrainerID = null,
            Status = "Active",
            TrainerScheduleID = null
        };
        showValidationError = false;
        validationErrors.Clear();
        qrCodeImage = null;
        selectedTrainerScheduleId = 0;
        visibleTrainerSchedules = new();
        isInitializingTrainerSelection = false;
        StateHasChanged();
    }

    private void UpdateMemberStatus(Member member)
    {
        if (member.ExpirationDate.HasValue && member.ExpirationDate.Value.Date < DateTime.Today)
        {
            member.Status = "Inactive";
        }
        else
        {
            member.Status = "Active";
        }
    }

    // Check and update expired memberships
    private async Task CheckAndUpdateExpiredMemberships()
    {
        try
        {
            var today = DateTime.Today;
            var expiredMembers = await Context.Members
                .Where(m => m.ExpirationDate.HasValue 
                    && m.ExpirationDate.Value.Date < today 
                    && m.Status != "Inactive")
                .ToListAsync();

            if (expiredMembers.Any())
            {
                foreach (var member in expiredMembers)
                {
                    member.Status = "Inactive";
                }
                await Context.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error updating expired memberships: {ex.Message}");
        }
    }

    // Handle membership type change - recalculate expiration date
    private void OnMembershipTypeChanged()
    {
        if (currentMember.MembershipTypeID > 0 && currentMember.JoinDate != DateTime.MinValue)
        {
            currentMember.ExpirationDate = CalculateExpirationDate(currentMember.JoinDate, currentMember.MembershipTypeID);
            UpdateMemberStatus(currentMember);
        }
        else if (currentMember.MembershipTypeID == 0)
        {
            currentMember.ExpirationDate = null;
            UpdateMemberStatus(currentMember);
        }
        StateHasChanged();
    }

    // Handle join date change - recalculate expiration date
    private void OnJoinDateChanged()
    {
        if (currentMember.MembershipTypeID > 0 && currentMember.JoinDate != DateTime.MinValue)
        {
            currentMember.ExpirationDate = CalculateExpirationDate(currentMember.JoinDate, currentMember.MembershipTypeID);
            UpdateMemberStatus(currentMember);
        }
        StateHasChanged();
    }

    private async Task UpdateTrainerScheduleAvailability(int? previousScheduleId, int? newScheduleId)
    {
        if (previousScheduleId.HasValue && previousScheduleId != newScheduleId)
        {
            await SetTrainerScheduleAvailability(previousScheduleId.Value, true);
        }

        if (newScheduleId.HasValue && newScheduleId != previousScheduleId)
        {
            await SetTrainerScheduleAvailability(newScheduleId.Value, false);
        }
    }

    private async Task SetTrainerScheduleAvailability(int scheduleId, bool isAvailable)
    {
        var schedule = await Context.TrainerSchedules.FindAsync(scheduleId);
        if (schedule != null)
        {
            schedule.IsAvailable = isAvailable;
            Context.TrainerSchedules.Update(schedule);
        }
    }

    private IQueryable<int> GetBookedTrainerScheduleIdsQuery()
    {
        var memberSchedules = Context.Members
            .Where(m => !m.IsArchived && m.TrainerScheduleID.HasValue)
            .Select(m => m.TrainerScheduleID!.Value);

        var walkInSchedules = Context.WalkIns
            .Where(w => !w.IsArchived && w.TrainerScheduleID.HasValue)
            .Select(w => w.TrainerScheduleID!.Value);

        return memberSchedules.Union(walkInSchedules);
    }

    private async Task ReleaseCompletedTrainerSchedulesAsync()
    {
        var coordinator = new TrainerScheduleCoordinator(DbContextFactory);
        await coordinator.ReleaseCompletedScheduleBlocksAsync();
    }

    // Renew Membership Functions
    private async void OpenRenewModal(Member member)
    {
        memberToRenew = member;
        renewMembershipTypeId = member.MembershipTypeID > 0 ? member.MembershipTypeID : 0;
        renewMembershipType = availableMembershipTypes.FirstOrDefault(mt => mt.MembershipTypeID == renewMembershipTypeId);
        renewPaymentMethod = "Cash";
        renewPromotionId = 0;
        selectedRenewPromotion = null;
        renewDiscountAmount = 0;
        renewFinalPrice = renewMembershipType?.Price ?? 0;
        renewError = null;
        renewErrors.Clear();
        renewTrainerId = member.TrainerID;
        renewTrainerScheduleId = member.TrainerScheduleID;
        await LoadRenewTrainersAsync(renewTrainerId);
        var includeScheduleId = renewTrainerScheduleId.HasValue ? renewTrainerScheduleId.Value : (int?)null;
        await LoadTrainerSchedules(includeScheduleId);
        UpdateRenewVisibleTrainerSchedules();
        await LoadActivePromotions();
        showRenewModal = true;
        CalculateRenewPrice();
        StateHasChanged();
    }

    private void CloseRenewModal()
    {
        if (isRenewing) return;
        showRenewModal = false;
        memberToRenew = null;
        renewMembershipTypeId = 0;
        renewMembershipType = null;
        renewPaymentMethod = "Cash";
        renewPromotionId = 0;
        selectedRenewPromotion = null;
        renewDiscountAmount = 0;
        renewFinalPrice = 0;
        renewError = null;
        renewErrors.Clear();
        renewTrainerId = null;
        renewTrainerScheduleId = null;
        availableRenewTrainers = new();
        visibleRenewTrainerSchedules = new();
        StateHasChanged();
    }

    private void OnRenewMembershipTypeChanged()
    {
        renewMembershipType = availableMembershipTypes.FirstOrDefault(mt => mt.MembershipTypeID == renewMembershipTypeId);
        CalculateRenewPrice();
    }

    private void OnRenewPromotionChanged()
    {
        selectedRenewPromotion = activePromotions.FirstOrDefault(p => p.PromoID == renewPromotionId);
        CalculateRenewPrice();
    }

    private void OnRenewPaymentMethodChanged()
    {
        if (renewPaymentMethod != "PayMongo")
        {
            // Reset PayMongo state when switching away
            showVerifyRenewalPaymentButton = false;
            pendingRenewalPaymentIntentId = null;
            pendingRenewalPaymentLinkId = null;
            renewalPayMongoCheckoutUrl = null;
        }
    }

    private void ResetRenewModalState()
    {
        showRenewModal = false;
        memberToRenew = null;
        renewMembershipTypeId = 0;
        renewMembershipType = null;
        renewPaymentMethod = "Cash";
        renewPromotionId = 0;
        selectedRenewPromotion = null;
        renewDiscountAmount = 0;
        renewFinalPrice = 0;
        renewError = null;
        renewErrors.Clear();
        renewTrainerId = null;
        renewTrainerScheduleId = null;
        availableRenewTrainers = new();
        visibleRenewTrainerSchedules = new();
        // Reset PayMongo payment state
        showVerifyRenewalPaymentButton = false;
        pendingRenewalPaymentIntentId = null;
        pendingRenewalPaymentLinkId = null;
        renewalPayMongoCheckoutUrl = null;
        isProcessingRenewalPayment = false;
        isVerifyingRenewalPayment = false;
        // Stop auto-verification timer
        renewalPaymentCheckTimer?.Dispose();
        renewalPaymentCheckTimer = null;
        StateHasChanged();
    }

    private void CalculateRenewPrice()
    {
        if (renewMembershipType == null)
        {
            renewFinalPrice = 0;
            renewDiscountAmount = 0;
            return;
        }

        var originalPrice = renewMembershipType.Price;
        
        if (selectedRenewPromotion != null && selectedRenewPromotion.DiscountRate > 0)
        {
            renewDiscountAmount = originalPrice * (selectedRenewPromotion.DiscountRate / 100);
            renewFinalPrice = originalPrice - renewDiscountAmount;
        }
        else
        {
            renewDiscountAmount = 0;
            renewFinalPrice = originalPrice;
        }
        
        StateHasChanged();
    }

    private bool HasRenewError(string fieldName)
    {
        return renewErrors.Contains(fieldName);
    }

    private bool ValidateRenewForm()
    {
        renewErrors.Clear();
        renewError = null;

        if (renewMembershipTypeId <= 0)
            renewErrors.Add("MembershipTypeID");

        if (string.IsNullOrWhiteSpace(renewPaymentMethod))
            renewErrors.Add("PaymentMethod");

        if (renewTrainerId.HasValue)
        {
            if (!renewTrainerScheduleId.HasValue)
            {
                renewErrors.Add("TrainerScheduleID");
            }
        }
        else
        {
            renewTrainerScheduleId = null;
        }

        return !renewErrors.Any();
    }

    private async Task RenewMembershipAsync()
    {
        if (isRenewing || memberToRenew == null)
            return;

        if (!ValidateRenewForm())
        {
            renewError = "Please fill in all required fields.";
            StateHasChanged();
            return;
        }

        // If PayMongo payment, process payment first
        if (renewPaymentMethod == "PayMongo")
        {
            await ProcessRenewalPayMongoPayment();
            return;
        }

        try
        {
            isRenewing = true;
            renewError = null;
            StateHasChanged();

            // Fetch the member from database
            var member = await Context.Members
                .Include(m => m.MembershipType)
                .FirstOrDefaultAsync(m => m.MemberID == memberToRenew.MemberID);

            if (member == null)
            {
                renewError = "Member not found.";
                isRenewing = false;
                StateHasChanged();
                return;
            }

            var previousScheduleId = member.TrainerScheduleID;

            // Update membership
            member.MembershipTypeID = renewMembershipTypeId;
            member.Status = "Active";
            var newExpirationDate = DateTime.Today.AddDays(renewMembershipType!.DurationInDays);
            member.ExpirationDate = newExpirationDate;
            member.TrainerID = renewTrainerId;
            member.TrainerScheduleID = renewTrainerScheduleId;
            await UpdateTrainerScheduleAvailability(previousScheduleId, member.TrainerScheduleID);
            
            // Mark member as modified
            Context.Members.Update(member);

            // Create payment record
            var payment = new PaymentModel
            {
                MemberID = member.MemberID,
                Amount = renewFinalPrice,
                PaymentDate = DateTime.Now,
                PaymentType = renewPaymentMethod,
                IsOnlinePayment = false
            };
            Context.Payments.Add(payment);

            // Save promotion usage if selected (check if already used first)
            if (selectedRenewPromotion != null && renewPromotionId > 0)
            {
                // Check if member has already used this promotion
                var existingPromo = await Context.MemberPromos
                    .FirstOrDefaultAsync(mp => mp.MemberID == member.MemberID && mp.PromotionID == selectedRenewPromotion.PromoID);
                
                if (existingPromo == null)
                {
                    // Only add if not already used
                    var memberPromo = new MemberPromo
                    {
                        MemberID = member.MemberID,
                        PromotionID = selectedRenewPromotion.PromoID,
                        DateUsed = DateTime.Now
                    };
                    Context.MemberPromos.Add(memberPromo);
                }
                // If already used, just skip adding it (member can't use same promotion twice)
            }

            await Context.SaveChangesAsync();

            // Reload data
            await LoadMembersFromDatabase();
            await LoadTrainersFromDatabase();

            CloseRenewModal();

            // Use toast notification instead of browser alert for successful renewal
            var renewedMessage =
                $"Membership renewed for {member.FirstName} {member.LastName}. " +
                $"New expiration: {newExpirationDate:MM/dd/yyyy}. " +
                $"Amount paid: ₱{renewFinalPrice:N2}.";
            ToastService.ShowSuccess(renewedMessage);
        }
        catch (Exception ex)
        {
            // Get more detailed error information
            var errorMessage = ex.Message;
            if (ex.InnerException != null)
            {
                errorMessage += $" | Inner: {ex.InnerException.Message}";
            }
            
            renewError = $"Error renewing membership: {errorMessage}";
            System.Diagnostics.Debug.WriteLine($"Renewal error: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"Stack trace: {ex.StackTrace}");
            
            // Log full exception details for debugging
            if (ex.InnerException != null)
            {
                System.Diagnostics.Debug.WriteLine($"Inner exception: {ex.InnerException.Message}");
            }
        }
        finally
        {
            isRenewing = false;
            StateHasChanged();
        }
    }

    private async Task ProcessRenewalPayMongoPayment()
    {
        if (memberToRenew == null)
            return;

        isProcessingRenewalPayment = true;
        isRenewing = true;
        StateHasChanged();

        try
        {
            var memberName = $"{memberToRenew.FirstName} {memberToRenew.LastName}".Trim();
            var description = $"Membership renewal for {memberName} - {renewMembershipType?.TypeName ?? "Membership"}";
            var referenceId = $"RENEWAL-{memberToRenew.MemberID}-{DateTime.Now:yyyyMMddHHmmss}";

            var paymentResponse = await PayMongoService.CreatePaymentLinkAsync(
                renewFinalPrice,
                description,
                referenceId
            );

            if (!paymentResponse.Success)
            {
                renewError = $"Failed to create payment link: {paymentResponse.Message}";
                ToastService.ShowError($"Payment error: {paymentResponse.Message}");
                isProcessingRenewalPayment = false;
                isRenewing = false;
                StateHasChanged();
                return;
            }

            // Store payment info temporarily (DO NOT save to database yet)
            pendingRenewalPaymentIntentId = paymentResponse.PaymentIntentId;
            pendingRenewalPaymentLinkId = paymentResponse.PaymentLinkId;
            renewalPayMongoCheckoutUrl = paymentResponse.CheckoutUrl;
            showVerifyRenewalPaymentButton = true;

            // Open PayMongo checkout in new window/tab
            await JSRuntime.InvokeVoidAsync("window.open", renewalPayMongoCheckoutUrl, "_blank");

            ToastService.ShowInfo("Payment page opened. After completing payment, return here - it will verify automatically.");
            
            // Start automatic payment checking (every 2 seconds)
            StartRenewalAutoPaymentVerification();
            
            // Also set up focus event to check immediately when user returns
            await SetupRenewalFocusCheck();
            
            // Check immediately after a short delay
            _ = Task.Run(async () =>
            {
                await Task.Delay(2000);
                await InvokeAsync(async () => await CheckRenewalPaymentStatusAutomatically());
            });
            
            // Keep modal open so user can verify payment
            StateHasChanged();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error processing renewal PayMongo payment: {ex.Message}");
            renewError = $"Error processing payment: {ex.Message}";
            ToastService.ShowError($"Payment error: {ex.Message}");
        }
        finally
        {
            isProcessingRenewalPayment = false;
            isRenewing = false;
            StateHasChanged();
        }
    }

    private void StartRenewalAutoPaymentVerification()
    {
        // Stop any existing timer
        renewalPaymentCheckTimer?.Dispose();
        
        // Start checking payment status every 2 seconds
        renewalPaymentCheckTimer = new System.Threading.Timer(async _ =>
        {
            await CheckRenewalPaymentStatusAutomatically();
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
    }

    private async Task CheckRenewalPaymentStatusAutomatically()
    {
        if (string.IsNullOrEmpty(pendingRenewalPaymentIntentId) || !showVerifyRenewalPaymentButton || isVerifyingRenewalPayment || !showRenewModal)
            return;

        try
        {
            // Check payment status - try link ID first, then intent ID
            var paymentIdToCheck = !string.IsNullOrEmpty(pendingRenewalPaymentLinkId) ? pendingRenewalPaymentLinkId : pendingRenewalPaymentIntentId;
            var paymentStatus = await PayMongoService.CheckPaymentStatusAsync(paymentIdToCheck ?? "");
            System.Diagnostics.Debug.WriteLine($"Auto-check renewal payment status (ID: {paymentIdToCheck}): {paymentStatus.Status}");
            
            // PayMongo uses various status values - check for all possible "paid" statuses
            var statusLower = paymentStatus.Status?.ToLower() ?? "";
            var isPaid = statusLower == "succeeded" || 
                        statusLower == "paid" ||
                        statusLower == "paid_off" ||
                        statusLower == "paidoff";

            if (isPaid)
            {
                System.Diagnostics.Debug.WriteLine("Renewal payment detected as paid, auto-verifying...");
                // Automatically verify and save
                await InvokeAsync(async () =>
                {
                    await VerifyAndSaveRenewalPayment();
                });
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Auto-check renewal payment error: {ex.Message}");
        }
    }

    private async Task SetupRenewalFocusCheck()
    {
        // Set up JavaScript to check payment when window regains focus
        await JSRuntime.InvokeVoidAsync("eval", @"
            (function() {
                if (window.paymongoRenewalAutoVerifySetup) return;
                window.paymongoRenewalAutoVerifySetup = true;
                
                window.addEventListener('focus', function() {
                    setTimeout(function() {
                        window.dispatchEvent(new Event('checkRenewalPaymentStatus'));
                    }, 500);
                });
                
                window.addEventListener('visibilitychange', function() {
                    if (!document.hidden) {
                        setTimeout(function() {
                            window.dispatchEvent(new Event('checkRenewalPaymentStatus'));
                        }, 500);
                    }
                });
            })();
        ");
        
        // Also check immediately when setting up
        await Task.Delay(1000);
        await CheckRenewalPaymentStatusAutomatically();
    }

    private async Task VerifyAndSaveRenewalPayment()
    {
        if (string.IsNullOrEmpty(pendingRenewalPaymentIntentId) || memberToRenew == null)
        {
            ToastService.ShowError("No payment to verify.");
            return;
        }

        isVerifyingRenewalPayment = true;
        StateHasChanged();

        try
        {
            // Check payment status with PayMongo - try link ID first, then intent ID
            var paymentIdToCheck = !string.IsNullOrEmpty(pendingRenewalPaymentLinkId) ? pendingRenewalPaymentLinkId : pendingRenewalPaymentIntentId;
            var paymentStatus = await PayMongoService.CheckPaymentStatusAsync(paymentIdToCheck ?? "");

            // Check if payment is completed
            var statusLower = paymentStatus.Status?.ToLower() ?? "";
            var isPaid = statusLower == "succeeded" || 
                        statusLower == "paid" ||
                        statusLower == "paid_off" ||
                        statusLower == "paidoff";
            
            System.Diagnostics.Debug.WriteLine($"Manual verify renewal - Payment status: {paymentStatus.Status}, IsPaid: {isPaid}");

            if (isPaid)
            {
                // Payment confirmed - now save to database
                var member = await Context.Members
                    .Include(m => m.MembershipType)
                    .FirstOrDefaultAsync(m => m.MemberID == memberToRenew.MemberID);

                if (member == null)
                {
                    renewError = "Member not found.";
                    isVerifyingRenewalPayment = false;
                    StateHasChanged();
                    return;
                }

                var previousScheduleId = member.TrainerScheduleID;

                // Update membership
                member.MembershipTypeID = renewMembershipTypeId;
                member.Status = "Active";
                var newExpirationDate = DateTime.Today.AddDays(renewMembershipType!.DurationInDays);
                member.ExpirationDate = newExpirationDate;
                member.TrainerID = renewTrainerId;
                member.TrainerScheduleID = renewTrainerScheduleId;
                await UpdateTrainerScheduleAvailability(previousScheduleId, member.TrainerScheduleID);
                
                Context.Members.Update(member);

                // Create payment record with PayMongo info
                var payment = new PaymentModel
                {
                    MemberID = member.MemberID,
                    Amount = renewFinalPrice,
                    PaymentDate = DateTime.Now,
                    PaymentType = "PayMongo",
                    PayMongoPaymentId = pendingRenewalPaymentIntentId,
                    PayMongoStatus = "paid",
                    IsOnlinePayment = true
                };
                Context.Payments.Add(payment);

                // Save promotion usage if selected
                if (selectedRenewPromotion != null && renewPromotionId > 0)
                {
                    var existingPromo = await Context.MemberPromos
                        .FirstOrDefaultAsync(mp => mp.MemberID == member.MemberID && mp.PromotionID == selectedRenewPromotion.PromoID);
                    
                    if (existingPromo == null)
                    {
                        var memberPromo = new MemberPromo
                        {
                            MemberID = member.MemberID,
                            PromotionID = selectedRenewPromotion.PromoID,
                            DateUsed = DateTime.Now
                        };
                        Context.MemberPromos.Add(memberPromo);
                    }
                }

                await Context.SaveChangesAsync();

                ToastService.ShowSuccess("Payment verified! Membership renewed successfully.");
                
                // Stop auto-verification timer
                renewalPaymentCheckTimer?.Dispose();
                renewalPaymentCheckTimer = null;
                
                // Reset payment verification state
                showVerifyRenewalPaymentButton = false;
                pendingRenewalPaymentIntentId = null;
                pendingRenewalPaymentLinkId = null;
                renewalPayMongoCheckoutUrl = null;

                // Reload data
                await LoadMembersFromDatabase();
                await LoadTrainersFromDatabase();

                // Close modal
                showRenewModal = false;
                memberToRenew = null;
                renewMembershipTypeId = 0;
                renewMembershipType = null;
                renewPaymentMethod = "Cash";
                renewPromotionId = 0;
                selectedRenewPromotion = null;
                renewDiscountAmount = 0;
                renewFinalPrice = 0;
                renewError = null;
                renewErrors.Clear();
                renewTrainerId = null;
                renewTrainerScheduleId = null;
                availableRenewTrainers = new();
                visibleRenewTrainerSchedules = new();
                // Reset PayMongo payment state
                showVerifyRenewalPaymentButton = false;
                pendingRenewalPaymentIntentId = null;
                pendingRenewalPaymentLinkId = null;
                renewalPayMongoCheckoutUrl = null;
                isProcessingRenewalPayment = false;
                isVerifyingRenewalPayment = false;
                // Stop auto-verification timer
                renewalPaymentCheckTimer?.Dispose();
                renewalPaymentCheckTimer = null;
                StateHasChanged();
            }
            else
            {
                // Payment not completed
                var statusMessage = paymentStatus.Status?.ToLower() ?? "unknown";
                if (statusMessage == "pending" || statusMessage == "awaiting_payment_method")
                {
                    ToastService.ShowWarning("Payment is still pending. Please complete the payment first, then verify again.");
                }
                else
                {
                    ToastService.ShowError($"Payment not completed. Status: {paymentStatus.Status ?? "Unknown"}. Please complete the payment or cancel.");
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error verifying renewal payment: {ex.Message}");
            ToastService.ShowError($"Error verifying payment: {ex.Message}");
        }
        finally
        {
            isVerifyingRenewalPayment = false;
            StateHasChanged();
        }
    }

    private async Task LogAuditAction(string action, string entityType, int? entityID, string entityName, string description, string status = "Success", string errorMessage = "")
    {
        try
        {
            var username = await AuthService.GetCurrentUsername();
            var userId = await AuthService.GetCurrentUserId();

            var auditLog = new AuditLog
            {
                Action = action,
                EntityType = entityType,
                EntityID = entityID,
                EntityName = entityName,
                PerformedBy = username,
                PerformedByUserID = userId,
                Description = description,
                Timestamp = DateTime.Now,
                Status = status,
                ErrorMessage = errorMessage
            };

            Context.AuditLogs.Add(auditLog);
            await Context.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error logging audit action: {ex.Message}");
        }
    }
}

<style>
    /* Student ID Image Styles */
    .student-id-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        object-fit: contain;
        background: #f9f9f9;
        padding: 10px;
    }

    .no-student-id {
        padding: 40px 20px;
        text-align: center;
        color: #999;
        font-style: italic;
        background: #f9f9f9;
        border-radius: 8px;
        border: 2px dashed #ddd;
    }
</style>