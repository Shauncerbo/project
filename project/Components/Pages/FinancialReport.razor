@page "/reports/financial"
@layout MainLayout
@using project.Data
@using project.Models
@using PaymentModel = project.Models.Payment
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Context
@inject IJSRuntime JSRuntime

<div class="financial-report">
    <div class="reports-header">
        <h1>Financial Report</h1>
        <div class="date-filter">
            <label>Period:</label>
            <select @bind="selectedPeriod" @bind:after="OnPeriodChanged" class="period-select">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
                <option value="custom">Custom Range</option>
            </select>
            @if (selectedPeriod == "custom")
            {
                <input type="date" @bind="customStartDate" @bind:after="OnPeriodChanged" class="date-input" />
                <span>to</span>
                <input type="date" @bind="customEndDate" @bind:after="OnPeriodChanged" class="date-input" />
            }
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-message">Loading financial reports...</div>
    }
    else
    {
        <!-- Print Header -->
        <div class="print-header financial-print-header">
            <div class="print-header-top">
                <div class="print-gym-name">PowerHouse Gym</div>
                <div class="print-date-time">@DateTime.Now.ToString("MMM dd, yyyy hh:mm tt")</div>
            </div>
            <div class="print-footer">Printed by: Admin</div>
        </div>

        <div id="financial-reports-content">
            <!-- Quick Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card income">
                    <div class="stat-info">
                        <div class="stat-text">
                            <h3>Total Income</h3>
                            <div class="stat-breakdown">
                                <span>Members: ₱@(memberIncome.ToString("N2"))</span>
                                <span>Walk-ins: ₱@(walkinIncome.ToString("N2"))</span>
                            </div>
                        </div>
                        <div class="stat-amount">₱@(totalIncome.ToString("N2"))</div>
                    </div>
                </div>

                <div class="stat-card clv">
                    <div class="stat-info">
                        <div class="stat-text">
                            <h3>Avg. Lifetime Value</h3>
                            <div class="stat-breakdown">
                                <span>Per Member</span>
                            </div>
                        </div>
                        <div class="stat-amount">₱@(averageCLV.ToString("N2"))</div>
                    </div>
                </div>
            </div>

            <!-- Business Performance Overview - Revenue -->
            <div class="reports-section">
                <div class="section-header">
                    <h2>Business Performance Overview</h2>
                </div>
                <div class="performance-overview">
                    <div class="performance-card">
                        <div class="performance-header">
                            <h3>Revenue Movement</h3>
                            <span class="performance-indicator @(revenueDirection == "Growing" ? "success" : revenueDirection == "Declining" ? "danger" : "warning")">
                                @if (revenueDirection == "Growing")
                                {
                                    <span>↑</span>
                                }
                                else if (revenueDirection == "Declining")
                                {
                                    <span>↓</span>
                                }
                                else
                                {
                                    <span>→</span>
                                }
                                @revenueDirection
                            </span>
                        </div>
                        <div class="performance-content">
                            <div class="performance-metric">
                                <span>Current Period:</span>
                                <span class="amount">₱@(currentPeriodRevenue.ToString("N2"))</span>
                            </div>
                            <div class="performance-metric">
                                <span>Previous Period:</span>
                                <span>₱@(previousPeriodRevenue.ToString("N2"))</span>
                            </div>
                            <div class="performance-metric">
                                <span>Change:</span>
                                <span class="@(revenueChangePercent >= 0 ? "success" : "danger")">
                                    @(revenueChangePercent >= 0 ? "+" : "")@(revenueChangePercent.ToString("F1"))%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Reports Section -->
            <div class="reports-section" id="financial-reports-section">
                <div class="section-header">
                    <h2>Financial Reports</h2>
                    <div class="export-buttons">
                        <button class="export-btn print-btn" @onclick="PrintFinancialReports" title="Print Financial Reports">
                            <span></span> Print
                        </button>
                    </div>
                </div>

                <div class="reports-grid">
                    <!-- Revenue by Payment Method -->
                    <div class="report-card">
                        <h3>Revenue by Payment Method</h3>
                        <div class="report-content">
                            <div class="report-item">
                                <span>Cash:</span>
                                <span class="amount">₱@(cashRevenue.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Payment Online (PayMongo):</span>
                                <span class="amount">₱@(ewalletRevenue.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Total:</span>
                                <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Cash %:</span>
                                <span>@(cashPercentage.ToString("F1"))%</span>
                            </div>
                            <div class="report-item">
                                <span>Payment Online (PayMongo) %:</span>
                                <span>@(ewalletPercentage.ToString("F1"))%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue by Membership Type -->
                    <div class="report-card">
                        <h3>Revenue by Membership Type</h3>
                        <div class="report-content">
                            @foreach (var mt in revenueByMembershipType)
                            {
                                <div class="report-item">
                                    <span>@mt.TypeName:</span>
                                    <span class="amount">₱@(mt.Revenue.ToString("N2"))</span>
                                </div>
                            }
                            <div class="report-item">
                                <span>Total:</span>
                                <span class="amount total">₱@(revenueByMembershipType.Sum(m => m.Revenue).ToString("N2"))</span>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue by Source -->
                    <div class="report-card" id="revenue-by-source">
                        <h3>Revenue by Source</h3>
                        <div class="report-content">
                            <div class="report-item">
                                <span>Member Subscriptions:</span>
                                <span class="amount">₱@(memberIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Walk-ins:</span>
                                <span class="amount">₱@(walkinIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Total Revenue:</span>
                                <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Members %:</span>
                                <span>@(memberPercentage.ToString("F1"))%</span>
                            </div>
                            <div class="report-item">
                                <span>Walk-ins %:</span>
                                <span>@(walkinPercentage.ToString("F1"))%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Total Revenue -->
                    <div class="report-card">
                        <h3>Total Revenue</h3>
                        <div class="report-content">
                            <div class="report-item">
                                <span>Total Revenue:</span>
                                <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Member Subscriptions:</span>
                                <span class="amount">₱@(memberIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Walk-ins:</span>
                                <span class="amount">₱@(walkinIncome.ToString("N2"))</span>
                            </div>
                        </div>
                    </div>

                    <!-- ROI Trend Report -->
                    <div class="report-card full-width">
                        <h3>ROI Trend Report</h3>
                        <div class="report-content">
                            @if (roiLabels.Any())
                            {
                                <div class="chart-container" style="position: relative; height: 350px; margin-bottom: 20px;">
                                    <canvas id="roiChart"></canvas>
                                </div>
                                <div class="roi-summary">
                                    <div class="roi-summary-item">
                                        <span>Current ROI:</span>
                                        <span class="@(roiData.Any() && roiData.Last() >= 0 ? "success" : "danger")">
                                            @(roiData.Any() ? roiData.Last().ToString("F1") : "0.0")%
                                        </span>
                                    </div>
                                    <div class="roi-summary-item">
                                        <span>Average ROI:</span>
                                        <span class="@(roiData.Any() && roiData.Average() >= 0 ? "success" : "danger")">
                                            @(roiData.Any() ? roiData.Average().ToString("F1") : "0.0")%
                                        </span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="no-data">No ROI data available for the selected period</div>
                            }
                        </div>
                    </div>

                    <!-- Daily/Weekly/Monthly Income Report -->
                    <div class="report-card full-width">
                        <h3>Daily / Weekly / Monthly Income Report</h3>
                        <div class="report-content">
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e1e8ed;">
                                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                    <label style="font-weight: 600; color: #234060;">Filter Period:</label>
                                    <select @bind="incomeReportPeriod" @bind:after="OnIncomeReportPeriodChanged" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="year">This Year</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                    @if (incomeReportPeriod == "custom")
                                    {
                                        <input type="date" @bind="incomeReportStartDate" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" />
                                        <span style="color: #666;">to</span>
                                        <input type="date" @bind="incomeReportEndDate" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" />
                                        <button @onclick="RefreshIncomeReport" style="padding: 8px 16px; background: #234060; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                            Apply Filter
                                        </button>
                                    }
                                </div>
                            </div>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 10px; color: #234060;">Daily Income</h4>
                                    <div class="reports-table-wrapper" style="max-height: 300px; overflow-y: auto;">
                                        <table class="members-table reports-table">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Transactions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (!dailyIncome.Any())
                                                {
                                                    <tr>
                                                        <td colspan="3" class="no-data">No daily income data</td>
                                                    </tr>
                                                }
                                                else
                                                {
                                                    @foreach (var day in dailyIncome)
                                                    {
                                                        <tr>
                                                            <td>@day.Period</td>
                                                            <td class="amount">₱@(day.Amount.ToString("N2"))</td>
                                                            <td>@day.PaymentCount</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 10px; color: #234060;">Weekly Income</h4>
                                    <div class="reports-table-wrapper" style="max-height: 300px; overflow-y: auto;">
                                        <table class="members-table reports-table">
                                            <thead>
                                                <tr>
                                                    <th>Week</th>
                                                    <th>Amount</th>
                                                    <th>Transactions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (!weeklyIncome.Any())
                                                {
                                                    <tr>
                                                        <td colspan="3" class="no-data">No weekly income data</td>
                                                    </tr>
                                                }
                                                else
                                                {
                                                    @foreach (var week in weeklyIncome)
                                                    {
                                                        <tr>
                                                            <td>@week.Period</td>
                                                            <td class="amount">₱@(week.Amount.ToString("N2"))</td>
                                                            <td>@week.PaymentCount</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 10px; color: #234060;">Monthly Income</h4>
                                    <div class="reports-table-wrapper" style="max-height: 300px; overflow-y: auto;">
                                        <table class="members-table reports-table">
                                            <thead>
                                                <tr>
                                                    <th>Month</th>
                                                    <th>Amount</th>
                                                    <th>Transactions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (!monthlyIncome.Any())
                                                {
                                                    <tr>
                                                        <td colspan="3" class="no-data">No monthly income data</td>
                                                    </tr>
                                                }
                                                else
                                                {
                                                    @foreach (var month in monthlyIncome)
                                                    {
                                                        <tr>
                                                            <td>@month.Period</td>
                                                            <td class="amount">₱@(month.Amount.ToString("N2"))</td>
                                                            <td>@month.PaymentCount</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Statement -->
                    <div class="report-card full-width" style="background: #f8f9fa; border: 2px solid #234060;">
                        <h3 style="color: #234060; border-bottom: 2px solid #234060; padding-bottom: 10px; margin-bottom: 20px;">
                            Financial Statement (Balance Sheet)
                            @if (Math.Abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01m)
                            {
                                <span style="color: #5cb85c; font-size: 0.9rem; margin-left: 10px;">✓ BALANCED</span>
                            }
                            else
                            {
                                <span style="color: #dc3545; font-size: 0.9rem; margin-left: 10px;">✗ UNBALANCED</span>
                            }
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <!-- Assets Section -->
                            <div>
                                <h4 style="color: #234060; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600;">ASSETS</h4>
                                <div class="report-content">
                                    <div class="report-item">
                                        <span>Cash:</span>
                                        <span class="amount @(totalCash >= 0 ? "success" : "danger")">₱@(totalCash.ToString("N2"))</span>
                                    </div>
                                    <div class="report-item">
                                        <span>Equipment & Assets:</span>
                                        <span class="amount">₱@(totalEquipmentValue.ToString("N2"))</span>
                                    </div>
                                    <div class="report-item" style="border-top: 2px solid #234060; padding-top: 10px; margin-top: 10px;">
                                        <span><strong>Total Assets:</strong></span>
                                        <span class="amount total"><strong>₱@(totalAssets.ToString("N2"))</strong></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Liabilities & Equity Section -->
                            <div>
                                <!-- Liabilities -->
                                <h4 style="color: #234060; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600;">LIABILITIES</h4>
                                <div class="report-content" style="margin-bottom: 20px;">
                                    <div class="report-item">
                                        <span>Total Liabilities:</span>
                                        <span class="amount" style="color: #dc3545;">₱@(totalLiabilities.ToString("N2"))</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666; font-style: italic; margin-top: 5px;">
                                        Manage liabilities in <a href="/finance" style="color: #234060;">Capital & Investments</a>
                                    </div>
                                </div>

                                <!-- Equity -->
                                <h4 style="color: #234060; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600;">EQUITY</h4>
                                <div class="report-content">
                                    <div class="report-item">
                                        <span>Owner's Capital:</span>
                                        <span class="amount">₱@(totalOwnersCapital.ToString("N2"))</span>
                                    </div>
                                    <div class="report-item">
                                        <span>Total Revenue:</span>
                                        <span class="amount success">₱@(totalAllTimeRevenue.ToString("N2"))</span>
                                    </div>
                                    <div class="report-item">
                                        <span>Less: Total Expenses (Paid):</span>
                                        <span class="amount" style="color: #dc3545;">(₱@(totalExpenses.ToString("N2")))</span>
                                    </div>
                                    <div class="report-item" style="padding-left: 20px;">
                                        <span><em>Retained Earnings (Revenue - Expenses):</em></span>
                                        <span class="amount @(retainedEarnings >= 0 ? "success" : "danger")">₱@(retainedEarnings.ToString("N2"))</span>
                                    </div>
                                    <div class="report-item" style="border-top: 2px solid #234060; padding-top: 10px; margin-top: 10px;">
                                        <span><strong>Total Equity:</strong></span>
                                        <span class="amount total"><strong>₱@(totalEquity.ToString("N2"))</strong></span>
                                    </div>
                                </div>

                                <!-- Total Liabilities + Equity -->
                                <div class="report-content" style="margin-top: 15px;">
                                    <div class="report-item" style="border-top: 3px double #234060; padding-top: 10px;">
                                        <span><strong>Total Liabilities + Equity:</strong></span>
                                        <span class="amount total"><strong>₱@((totalLiabilities + totalEquity).ToString("N2"))</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Income Summary -->
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e8ed;">
                            <h4 style="color: #234060; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600;">INCOME STATEMENT SUMMARY</h4>
                            <div class="report-content">
                                <div class="report-item">
                                    <span>Total Revenue (All-time):</span>
                                    <span class="amount success">₱@(totalAllTimeRevenue.ToString("N2"))</span>
                                </div>
                                <div class="report-item">
                                    <span>Total Expenses (Paid Liabilities):</span>
                                    <span class="amount" style="color: #dc3545;">(₱@(totalExpenses.ToString("N2")))</span>
                                </div>
                                <div class="report-item" style="border-top: 2px solid #234060; padding-top: 10px; margin-top: 10px;">
                                    <span><strong>Net Income (Retained Earnings):</strong></span>
                                    <span class="amount @(retainedEarnings >= 0 ? "success" : "danger")"><strong>₱@(retainedEarnings.ToString("N2"))</strong></span>
                                </div>
                            </div>
                        </div>

                        <!-- Accounting Equation Note -->
                        <div style="margin-top: 20px; padding: 15px; background: @(Math.Abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01m ? "#e8f5e9" : "#ffebee"); border-left: 4px solid @(Math.Abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01m ? "#5cb85c" : "#dc3545"); border-radius: 4px;">
                            <p style="margin: 0; font-size: 0.9rem; color: @(Math.Abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01m ? "#2e7d32" : "#c62828");">
                                <strong>Accounting Equation:</strong> Assets (₱@(totalAssets.ToString("N2"))) = Liabilities (₱@(totalLiabilities.ToString("N2"))) + Equity (₱@(totalEquity.ToString("N2")))
                            </p>
                            <p style="margin: 5px 0 0 0; font-size: 0.85rem; color: @(Math.Abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01m ? "#388e3c" : "#d32f2f");">
                                ₱@(totalAssets.ToString("N2")) = ₱@((totalLiabilities + totalEquity).ToString("N2"))
                                @if (Math.Abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01m)
                                {
                                    <span>✓</span>
                                }
                                else
                                {
                                    <span>(Difference: ₱@(Math.Abs(totalAssets - (totalLiabilities + totalEquity)).ToString("N2")))</span>
                                }
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@* Include all the styles and code from the original Reports.razor *@
<style>
    /* Copy all styles from original Reports.razor - this is a simplified version */
    .financial-report {
        padding: 20px;
    }

    .reports-header {
        background: white;
        padding: 25px 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .reports-header h1 {
        color: #000000;
        margin: 0;
        font-size: 24px;
        font-weight: 600;
    }

    .date-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .date-filter label {
        font-weight: 600;
        color: #000000;
    }

    .period-select, .date-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
    }

    .loading-message {
        text-align: center;
        padding: 50px;
        font-size: 18px;
        color: #000000;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: box-shadow 0.2s ease;
        min-height: 120px;
    }

    .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        gap: 15px;
    }

    .stat-text {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
    }

    .stat-info h3 {
        margin: 0 0 10px 0;
        color: #000000;
        font-size: 1rem;
        font-weight: 600;
        min-height: 24px;
    }

    .stat-amount {
        font-size: 1.8rem;
        font-weight: bold;
        text-align: right;
        white-space: nowrap;
        flex-shrink: 0;
        color: #000000;
        line-height: 1.2;
        margin-top: 0;
    }

    .stat-breakdown {
        font-size: 0.8rem;
        color: #000000;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .reports-section {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-header h2 {
        margin: 0;
        color: #000000;
        font-size: 20px;
        font-weight: 600;
    }

    .export-buttons {
        display: flex;
        gap: 10px;
    }

    .export-btn {
        background: #234060;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s;
    }

    .export-btn:hover {
        background: #1a3450;
        transform: translateY(-1px);
    }

    .print-btn {
        background: #0066cc;
    }

    .print-btn:hover {
        background: #0052a3;
    }

    .print-header {
        display: none;
    }

    @@media print {
        @@page {
            margin: 1cm;
            size: A4;
        }

        /* Hide non-printable elements */
        .reports-header,
        .section-header .export-buttons,
        .date-filter,
        button,
        .no-print {
            display: none !important;
        }

        /* Show and style print header */
        .print-header {
            display: block !important;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #234060;
            page-break-after: avoid;
        }

        .print-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .print-gym-name {
            font-size: 28px;
            font-weight: bold;
            color: #234060;
            letter-spacing: 1px;
        }

        .print-date-time {
            font-size: 12px;
            color: #666;
        }

        .print-footer {
            font-size: 11px;
            color: #666;
            text-align: left;
            font-style: italic;
        }

        /* Section headers */
        .section-header {
            display: block !important;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #234060;
            page-break-after: avoid;
        }

        .section-header h2 {
            color: #234060 !important;
            font-size: 18px !important;
            margin: 0 !important;
        }

        /* Stats grid - make it fit better on print */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .stat-card {
            background: white !important;
            border: 1px solid #ddd;
            box-shadow: none !important;
            padding: 15px;
            page-break-inside: avoid;
        }

        .stat-info h3 {
            font-size: 14px !important;
            color: #234060 !important;
        }

        .stat-amount {
            font-size: 20px !important;
            color: #234060 !important;
        }

        .stat-breakdown {
            font-size: 11px !important;
            color: #666 !important;
        }

        /* Performance cards */
        .performance-overview {
            page-break-inside: avoid;
            margin-bottom: 20px;
        }

        .performance-card {
            border: 1px solid #ddd;
            box-shadow: none !important;
            page-break-inside: avoid;
        }

        /* Reports grid */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            page-break-inside: avoid;
        }

        .report-card {
            background: white !important;
            border: 1px solid #ddd;
            padding: 15px;
            page-break-inside: avoid;
            box-shadow: none !important;
        }

        .report-card.full-width {
            grid-column: 1 / -1;
            page-break-before: auto;
            page-break-inside: avoid;
        }

        .report-card h3 {
            font-size: 14px !important;
            color: #234060 !important;
            margin-bottom: 12px !important;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }

        .report-content {
            font-size: 12px;
        }

        .report-item {
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .amount {
            font-weight: 600;
            color: #000 !important;
        }

        .amount.total {
            font-size: 14px !important;
        }

        /* Financial Statement special styling */
        .report-card[style*="background: #f8f9fa"] {
            background: white !important;
            border: 2px solid #234060 !important;
            padding: 20px !important;
        }

        .report-card[style*="background: #f8f9fa"] h3 {
            font-size: 16px !important;
            border-bottom: 2px solid #234060 !important;
        }

        .report-card[style*="background: #f8f9fa"] h4 {
            font-size: 13px !important;
            color: #234060 !important;
            font-weight: 600 !important;
        }

        /* Tables */
        .reports-table-wrapper {
            max-height: none !important;
            overflow: visible !important;
        }

        .reports-table,
        .members-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }

        .reports-table th,
        .members-table th {
            background: #234060 !important;
            color: white !important;
            padding: 8px;
            font-size: 11px;
            border: 1px solid #ddd;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .reports-table td,
        .members-table td {
            padding: 6px 8px;
            border: 1px solid #ddd;
            font-size: 11px;
        }

        .reports-table tbody tr:nth-child(even),
        .members-table tbody tr:nth-child(even) {
            background: #f9f9f9 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Growth items */
        .growth-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .growth-item {
            border: 1px solid #ddd;
            padding: 15px;
            page-break-inside: avoid;
        }

        .growth-value {
            font-size: 24px !important;
            color: #234060 !important;
        }

        /* Color adjustments for print */
        .success {
            color: #2c7a2c !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .danger {
            color: #c62828 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .warning {
            color: #d68910 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Performance indicators */
        .performance-indicator {
            font-size: 11px !important;
            padding: 3px 8px !important;
        }

        .performance-indicator.success {
            background: #e8f5e9 !important;
            color: #2c7a2c !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .performance-indicator.danger {
            background: #ffebee !important;
            color: #c62828 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .performance-indicator.warning {
            background: #fff3e0 !important;
            color: #d68910 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Accounting equation box */
        div[style*="background: #e8f5e9"],
        div[style*="background: #ffebee"] {
            border: 1px solid #ddd !important;
            page-break-inside: avoid;
        }

        /* Income report filters - hide in print */
        div[style*="background: #f8fafc"][style*="Filter Period"] {
            display: none !important;
        }

        /* Daily/Weekly/Monthly tables container */
        div[style*="display: flex"][style*="gap: 20px"] > div {
            flex: 1;
            page-break-inside: avoid;
        }

        /* Page breaks */
        .reports-section {
            page-break-inside: avoid;
            margin-bottom: 20px;
        }

        /* Ensure financial statement stays together */
        #financial-reports-section {
            page-break-before: auto;
        }

        /* Remove box shadows and fancy effects */
        * {
            box-shadow: none !important;
            text-shadow: none !important;
        }

        /* Ensure backgrounds print */
        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }

    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .report-card {
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 20px;
        background: #fafbfc;
    }

    .report-card.full-width {
        grid-column: 1 / -1;
    }

    .report-card h3 {
        margin: 0 0 15px 0;
        color: #000000;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .report-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .report-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #ecf0f1;
        color: #000000;
    }

    .report-item:last-child {
        border-bottom: none;
    }

    .amount {
        font-weight: 600;
        color: #000000;
    }

    .amount.total {
        font-size: 1.1rem;
        color: #000000;
    }

    .success {
        color: #000000;
        font-weight: bold;
    }

    .warning {
        color: #000000;
        font-weight: bold;
    }

    .danger {
        color: #000000;
        font-weight: bold;
    }

    .performance-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .performance-card {
        background: white;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .performance-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f4f8;
    }

    .performance-header h3 {
        margin: 0;
        color: #000000;
        font-size: 1rem;
        font-weight: 600;
    }

    .performance-indicator {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .performance-indicator.success {
        color: #2e7d32;
    }

    .performance-indicator.danger {
        background: transparent;
        color: #000000;
    }

    .performance-indicator.warning {
        background: transparent;
        color: #000000;
    }

    .performance-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .performance-metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f4f8;
        color: #000000;
    }

    .performance-metric:last-child {
        border-bottom: none;
    }

    .growth-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 10px;
    }

    .growth-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #e1e8ed;
        text-align: center;
    }

    .growth-label {
        font-size: 0.9rem;
        color: #000000;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .growth-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #000000;
    }

    .growth-detail {
        display: flex;
        flex-direction: column;
        gap: 5px;
        font-size: 0.85rem;
        color: #000000;
    }

    .kpi-trend-container {
        margin-top: 10px;
    }

    .kpi-trend-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .kpi-trend-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e1e8ed;
    }

    .kpi-trend-label {
        min-width: 150px;
        font-weight: 600;
        color: #000000;
    }

    .kpi-trend-bar {
        flex: 1;
        height: 30px;
        background: #e1e8ed;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    .kpi-trend-fill {
        height: 100%;
        background: linear-gradient(90deg, #234060 0%, #3498db 100%);
        border-radius: 15px;
        transition: width 0.3s ease;
    }

    .kpi-trend-value {
        min-width: 120px;
        text-align: right;
        font-weight: bold;
        font-size: 1.1rem;
        color: #000000;
    }

    .kpi-change {
        font-size: 0.85rem;
        margin-left: 5px;
    }

    .kpi-summary {
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e1e8ed;
    }

    .kpi-summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #000000;
    }

    .chart-container {
        margin: 20px 0;
    }

    .roi-summary {
        display: flex;
        gap: 30px;
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e1e8ed;
    }

    .roi-summary-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .roi-summary-item span:first-child {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
    }

    .roi-summary-item span:last-child {
        font-size: 1.3rem;
        font-weight: 700;
    }

    .reports-table-wrapper {
        overflow-x: auto;
        margin-top: 8px;
    }

    .reports-table {
        width: 100%;
        border-collapse: collapse;
    }

    .reports-table thead {
        background: #234060;
        color: #ffffff;
    }

    .reports-table th,
    .reports-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
        text-align: left;
    }

    .reports-table tbody tr:hover {
        background: #f8f9fa;
    }

    .no-data {
        text-align: center;
        padding: 16px 0;
        color: #777;
        font-style: italic;
    }

    .members-table {
        width: 100%;
        border-collapse: collapse;
    }
</style>

@code {
    private string selectedPeriod = "month";
    private DateTime? customStartDate = DateTime.Today.AddDays(-30);
    private DateTime? customEndDate = DateTime.Today;
    private bool isLoading = true;

    private string incomeReportPeriod = "month";
    private DateTime? incomeReportStartDate = DateTime.Today.AddDays(-30);
    private DateTime? incomeReportEndDate = DateTime.Today;

    private decimal totalIncome = 0;
    private decimal memberIncome = 0;
    private decimal walkinIncome = 0;
    private decimal cashRevenue = 0;
    private decimal ewalletRevenue = 0;
    private decimal cashPercentage = 0;
    private decimal ewalletPercentage = 0;
    private decimal memberPercentage = 0;
    private decimal walkinPercentage = 0;

    private decimal averageCLV = 0;
    private decimal totalCLV = 0;
    private decimal top10PercentCLV = 0;
    private decimal averageRevenuePerMember = 0;

    private int promotionsUsed = 0;
    private decimal revenueFromPromotions = 0;
    private decimal totalDiscountGiven = 0;
    private decimal netRevenueAfterDiscount = 0;
    private double marketingROI = 0;

    private List<MembershipTypeRevenue> revenueByMembershipType = new();
    private List<KPITrend> kpiTrends = new();
    private string overallBusinessHealth = "Stable";

    private string revenueDirection = "Stable";
    private decimal currentPeriodRevenue = 0;
    private decimal previousPeriodRevenue = 0;
    private double revenueChangePercent = 0;
    private double revenueGrowthPercent = 0;

    private List<PeriodIncome> dailyIncome = new();
    private List<PeriodIncome> weeklyIncome = new();
    private List<PeriodIncome> monthlyIncome = new();

    // ROI Trend Variables
    private List<string> roiLabels = new();
    private List<double> roiData = new();
    private bool roiChartInitialized = false;

    // Financial Statement Variables
    private decimal totalEquipmentValue = 0;
    private decimal totalOwnersCapital = 0;
    private decimal totalAllTimeRevenue = 0;
    private decimal totalCash = 0;
    private decimal totalLiabilities = 0;
    private decimal totalExpenses = 0;
    private decimal retainedEarnings = 0;
    private decimal totalAssets = 0;
    private decimal totalEquity = 0;

    private class MembershipTypeRevenue
    {
        public string TypeName { get; set; } = string.Empty;
        public decimal Revenue { get; set; }
    }

    private class KPITrend
    {
        public string Label { get; set; } = string.Empty;
        public decimal CurrentValue { get; set; }
        public decimal PreviousValue { get; set; }
        public double ChangePercent { get; set; }
        public double NormalizedValue { get; set; }
    }

    private class PeriodIncome
    {
        public string Period { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public int PaymentCount { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadReportData();
    }

    private async Task OnPeriodChanged()
    {
        await LoadReportData();
    }

    private async Task OnIncomeReportPeriodChanged()
    {
        await RefreshIncomeReport();
    }

    private async Task RefreshIncomeReport()
    {
        var (startDate, endDate) = GetIncomeReportDateRange();
        await LoadPeriodIncomeReports(startDate, endDate);
        StateHasChanged();
    }

    private (DateTime start, DateTime end) GetIncomeReportDateRange()
    {
        var today = DateTime.Today;
        return incomeReportPeriod switch
        {
            "today" => (today, today.AddDays(1).AddSeconds(-1)),
            "week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(1).AddSeconds(-1)),
            "month" => (new DateTime(today.Year, today.Month, 1), today.AddDays(1).AddSeconds(-1)),
            "year" => (new DateTime(today.Year, 1, 1), today.AddDays(1).AddSeconds(-1)),
            "custom" => (incomeReportStartDate ?? today.AddDays(-30), incomeReportEndDate ?? today),
            _ => (today.AddDays(-30), today)
        };
    }

    private (DateTime start, DateTime end) GetDateRange()
    {
        var today = DateTime.Today;
        return selectedPeriod switch
        {
            "today" => (today, today.AddDays(1).AddSeconds(-1)),
            "week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(1).AddSeconds(-1)),
            "month" => (new DateTime(today.Year, today.Month, 1), today.AddDays(1).AddSeconds(-1)),
            "year" => (new DateTime(today.Year, 1, 1), today.AddDays(1).AddSeconds(-1)),
            "custom" => (customStartDate ?? today.AddDays(-30), customEndDate ?? today),
            _ => (today.AddDays(-30), today)
        };
    }

    private async Task LoadReportData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var (startDate, endDate) = GetDateRange();

            await LoadRevenueByPaymentMethod(startDate, endDate);
            await LoadRevenueByMembershipType(startDate, endDate);
            await LoadRevenueBySource(startDate, endDate);
            await LoadBusinessPerformanceOverview(startDate, endDate);
            await LoadROITrendData(startDate, endDate);
            await LoadKPITrendChart(startDate, endDate);
            await LoadCustomerLifetimeValue();
            await LoadMarketingROI(startDate, endDate);
            await LoadPeriodIncomeReports(GetIncomeReportDateRange().start, GetIncomeReportDateRange().end);
            await LoadFinancialStatement();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading reports: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadRevenueByPaymentMethod(DateTime startDate, DateTime endDate)
    {
        var memberPayments = await Context.Payments
            .Include(p => p.Member)
            .Where(p => p.PaymentDate >= startDate && 
                        p.PaymentDate <= endDate && 
                        p.Member != null && 
                        !p.Member.IsArchived)
            .ToListAsync();

        cashRevenue = memberPayments.Where(p => p.PaymentType == "Cash").Sum(p => p.Amount);
        ewalletRevenue = memberPayments.Where(p => p.PaymentType == "PayMongo" || p.PaymentType == "Ewallet").Sum(p => p.Amount);

        var walkinPayments = await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .ToListAsync();

        cashRevenue += walkinPayments.Where(w => w.PaymentMethod == "Cash").Sum(w => w.PaymentAmount);
        ewalletRevenue += walkinPayments.Where(w => w.PaymentMethod == "PayMongo" || w.PaymentMethod == "Ewallet").Sum(w => w.PaymentAmount);

        totalIncome = cashRevenue + ewalletRevenue;
        cashPercentage = totalIncome > 0 ? (cashRevenue / totalIncome) * 100 : 0;
        ewalletPercentage = totalIncome > 0 ? (ewalletRevenue / totalIncome) * 100 : 0;
    }

    private async Task LoadRevenueByMembershipType(DateTime startDate, DateTime endDate)
    {
        var payments = await Context.Payments
            .Include(p => p.Member)
            .ThenInclude(m => m!.MembershipType)
            .Where(p => p.PaymentDate >= startDate && 
                        p.PaymentDate <= endDate && 
                        p.Member != null && 
                        !p.Member.IsArchived)
            .ToListAsync();

        revenueByMembershipType = payments
            .Where(p => p.Member?.MembershipType != null)
            .GroupBy(p => p.Member!.MembershipType!.TypeName)
            .Select(g => new MembershipTypeRevenue
            {
                TypeName = g.Key,
                Revenue = g.Sum(p => p.Amount)
            })
            .OrderByDescending(m => m.Revenue)
            .ToList();
    }

    private async Task LoadRevenueBySource(DateTime startDate, DateTime endDate)
    {
        memberIncome = await Context.Payments
            .Include(p => p.Member)
            .Where(p => p.PaymentDate >= startDate && 
                        p.PaymentDate <= endDate && 
                        p.Member != null && 
                        !p.Member.IsArchived)
            .SumAsync(p => p.Amount);

        walkinIncome = await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        totalIncome = memberIncome + walkinIncome;
        memberPercentage = totalIncome > 0 ? (memberIncome / totalIncome) * 100 : 0;
        walkinPercentage = totalIncome > 0 ? (walkinIncome / totalIncome) * 100 : 0;
    }

    private async Task LoadBusinessPerformanceOverview(DateTime startDate, DateTime endDate)
    {
        var periodLength = (endDate - startDate).TotalDays;
        var previousStartDate = startDate.AddDays(-periodLength - 1);
        var previousEndDate = startDate.AddSeconds(-1);

        currentPeriodRevenue = await Context.Payments
            .Include(p => p.Member)
            .Where(p => p.PaymentDate >= startDate && 
                        p.PaymentDate <= endDate && 
                        p.Member != null && 
                        !p.Member.IsArchived)
            .SumAsync(p => p.Amount);
        currentPeriodRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        previousPeriodRevenue = await Context.Payments
            .Include(p => p.Member)
            .Where(p => p.PaymentDate >= previousStartDate && 
                        p.PaymentDate <= previousEndDate && 
                        p.Member != null && 
                        !p.Member.IsArchived)
            .SumAsync(p => p.Amount);
        previousPeriodRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= previousStartDate && w.VisitDate <= previousEndDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        revenueChangePercent = previousPeriodRevenue > 0 
            ? (double)((currentPeriodRevenue - previousPeriodRevenue) / previousPeriodRevenue) * 100 
            : (currentPeriodRevenue > 0 ? 100 : 0);
        revenueDirection = revenueChangePercent > 5 ? "Growing" : revenueChangePercent < -5 ? "Declining" : "Stable";
    }

    private async Task LoadROITrendData(DateTime startDate, DateTime endDate)
    {
        try
        {
            roiLabels.Clear();
            roiData.Clear();

            // Determine number of periods based on date range
            var totalDays = (endDate - startDate).TotalDays;
            int numberOfPeriods;
            string periodFormat;

            if (totalDays <= 7)
            {
                // Daily periods for week or less
                numberOfPeriods = (int)totalDays;
                periodFormat = "MMM dd";
            }
            else if (totalDays <= 90)
            {
                // Weekly periods for up to 3 months
                numberOfPeriods = Math.Min(12, (int)(totalDays / 7));
                periodFormat = "MMM dd";
            }
            else
            {
                // Monthly periods for longer ranges
                numberOfPeriods = Math.Min(12, (int)(totalDays / 30));
                periodFormat = "MMM yyyy";
            }

            // Get all-time investments (Owner's Capital + Equipment) - these are cumulative
            var allCapitals = await Context.Capitals.AsNoTracking().ToListAsync();
            var allInvestments = await Context.Investments.AsNoTracking().ToListAsync();
            var totalInvestment = allCapitals.Sum(c => c.Amount) + allInvestments.Sum(i => i.Price * i.Quantity);

            // Calculate ROI for each period
            for (int i = 0; i < numberOfPeriods; i++)
            {
                DateTime periodStart, periodEnd;
                string periodLabel;

                if (totalDays <= 7)
                {
                    // Daily
                    periodStart = startDate.AddDays(i);
                    periodEnd = periodStart.AddDays(1).AddSeconds(-1);
                    periodLabel = periodStart.ToString(periodFormat);
                }
                else if (totalDays <= 90)
                {
                    // Weekly
                    var weekStart = startDate.AddDays(i * 7);
                    periodStart = weekStart;
                    periodEnd = weekStart.AddDays(7).AddSeconds(-1);
                    if (periodEnd > endDate) periodEnd = endDate;
                    periodLabel = $"{periodStart.ToString(periodFormat)} - {periodEnd.ToString(periodFormat)}";
                }
                else
                {
                    // Monthly
                    periodStart = startDate.AddMonths(i);
                    periodEnd = periodStart.AddMonths(1).AddSeconds(-1);
                    if (periodEnd > endDate) periodEnd = endDate;
                    periodLabel = periodStart.ToString(periodFormat);
                }

                // Calculate revenue for this period
                var periodRevenue = await Context.Payments
                    .Where(p => p.PaymentDate >= periodStart && p.PaymentDate <= periodEnd)
                    .SumAsync(p => p.Amount);
                periodRevenue += await Context.WalkIns
                    .Where(w => w.VisitDate >= periodStart && w.VisitDate <= periodEnd && !w.IsArchived)
                    .SumAsync(w => w.PaymentAmount);

                // Calculate ROI: ((Revenue - Investment) / Investment) * 100
                // For each period, we use cumulative investment (all-time) vs period revenue
                // This shows how each period's revenue contributes to overall ROI
                double periodROI = 0;
                if (totalInvestment > 0)
                {
                    // ROI for this period relative to total investment
                    periodROI = (double)((periodRevenue / totalInvestment) * 100);
                }
                else if (periodRevenue > 0)
                {
                    // If no investment yet, ROI is infinite/undefined, set to 0 or a high value
                    periodROI = 0;
                }

                roiLabels.Add(periodLabel);
                roiData.Add(periodROI);
            }

            // Reset chart initialization flag so chart will be re-initialized
            roiChartInitialized = false;
            StateHasChanged();
            
            // Initialize chart after a short delay to ensure DOM is updated
            await Task.Delay(200);
            await InitializeROIChart();
        }
        catch (Exception ex)
        {
            roiLabels.Clear();
            roiData.Clear();
            System.Diagnostics.Debug.WriteLine($"Error loading ROI trend data: {ex.Message}");
        }
    }

    private async Task LoadKPITrendChart(DateTime startDate, DateTime endDate)
    {
        var periodLength = (endDate - startDate).TotalDays;
        var previousStartDate = startDate.AddDays(-periodLength - 1);
        var previousEndDate = startDate.AddSeconds(-1);

        kpiTrends = new List<KPITrend>();

        var currentRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);
        currentRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        var previousRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= previousStartDate && p.PaymentDate <= previousEndDate)
            .SumAsync(p => p.Amount);
        previousRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= previousStartDate && w.VisitDate <= previousEndDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        var revenueChange = previousRevenue > 0 
            ? ((currentRevenue - previousRevenue) / previousRevenue) * 100 
            : (currentRevenue > 0 ? 100 : 0);

        kpiTrends.Add(new KPITrend
        {
            Label = "Revenue",
            CurrentValue = currentRevenue,
            PreviousValue = previousRevenue,
            ChangePercent = (double)revenueChange,
            NormalizedValue = Math.Min(100, Math.Max(0, (double)(currentRevenue / Math.Max(1, previousRevenue)) * 50))
        });

        var healthyKPIs = kpiTrends.Count(k => k.ChangePercent >= 0);
        overallBusinessHealth = healthyKPIs >= 1 ? "Healthy" : "At Risk";
    }

    private async Task LoadCustomerLifetimeValue()
    {
        var members = await Context.Members
            .Include(m => m.Payments)
            .Where(m => !m.IsArchived && m.Status == "Active")
            .ToListAsync();

        if (!members.Any())
        {
            averageCLV = 0;
            totalCLV = 0;
            averageRevenuePerMember = 0;
            return;
        }

        var memberCLVs = members.Select(m => new
        {
            MemberID = m.MemberID,
            TotalRevenue = m.Payments.Sum(p => p.Amount)
        }).ToList();

        totalCLV = memberCLVs.Sum(m => m.TotalRevenue);
        averageCLV = memberCLVs.Any() ? memberCLVs.Average(m => m.TotalRevenue) : 0;
        averageRevenuePerMember = averageCLV;

        var sortedCLVs = memberCLVs.OrderByDescending(m => m.TotalRevenue).ToList();
        var top10PercentCount = Math.Max(1, (int)(sortedCLVs.Count * 0.1));
        top10PercentCLV = sortedCLVs.Take(top10PercentCount).Any() 
            ? sortedCLVs.Take(top10PercentCount).Average(m => m.TotalRevenue) 
            : 0;
    }

    private async Task LoadMarketingROI(DateTime startDate, DateTime endDate)
    {
        try
        {
            var memberPromos = await Context.MemberPromos
                .Include(mp => mp.Promotion)
                .Include(mp => mp.Member)
                .ThenInclude(m => m!.Payments)
                .Where(mp => mp.DateUsed.HasValue && mp.DateUsed >= startDate && mp.DateUsed <= endDate)
                .ToListAsync();

            promotionsUsed = memberPromos.Count;

            revenueFromPromotions = memberPromos
                .Where(mp => mp.Member != null)
                .Sum(mp => mp.Member!.Payments
                    .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
                    .Sum(p => p.Amount));

            totalDiscountGiven = memberPromos
                .Where(mp => mp.Promotion != null && mp.Member != null)
                .Sum(mp =>
                {
                    var memberPayments = mp.Member!.Payments
                        .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
                        .Sum(p => p.Amount);
                    return memberPayments * (mp.Promotion!.DiscountRate / 100);
                });

            netRevenueAfterDiscount = revenueFromPromotions - totalDiscountGiven;

            // Marketing ROI = ((Revenue - Cost) / Cost) * 100
            // Where Cost = Discount Given (the "investment" in marketing)
            marketingROI = totalDiscountGiven > 0 
                ? (double)(((revenueFromPromotions - totalDiscountGiven) / totalDiscountGiven)) * 100 
                : revenueFromPromotions > 0 ? 100 : 0;
        }
        catch (Exception)
        {
            promotionsUsed = 0;
            revenueFromPromotions = 0;
            totalDiscountGiven = 0;
            netRevenueAfterDiscount = 0;
            marketingROI = 0;
        }
    }

    private async Task LoadPeriodIncomeReports(DateTime startDate, DateTime endDate)
    {
        var dailyPayments = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .ToListAsync();
        var dailyWalkIns = await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .ToListAsync();

        dailyIncome = dailyPayments
            .GroupBy(p => p.PaymentDate.Date)
            .Select(g => new { Date = g.Key, Amount = g.Sum(p => p.Amount), Count = g.Count() })
            .Concat(dailyWalkIns
                .GroupBy(w => w.VisitDate.Date)
                .Select(g => new { Date = g.Key, Amount = g.Sum(w => w.PaymentAmount), Count = g.Count() }))
            .GroupBy(x => x.Date)
            .Select(g => new PeriodIncome
            {
                Period = g.Key.ToString("MMM dd, yyyy"),
                Amount = g.Sum(x => x.Amount),
                PaymentCount = g.Sum(x => x.Count)
            })
            .OrderByDescending(p => DateTime.ParseExact(p.Period, "MMM dd, yyyy", System.Globalization.CultureInfo.InvariantCulture))
            .ToList();

        weeklyIncome = dailyPayments
            .GroupBy(p => GetWeekOfYear(p.PaymentDate))
            .Select(g => new { Week = g.Key, Amount = g.Sum(p => p.Amount), Count = g.Count() })
            .Concat(dailyWalkIns
                .GroupBy(w => GetWeekOfYear(w.VisitDate))
                .Select(g => new { Week = g.Key, Amount = g.Sum(w => w.PaymentAmount), Count = g.Count() }))
            .GroupBy(x => x.Week)
            .Select(g => new PeriodIncome
            {
                Period = $"Week {g.Key}",
                Amount = g.Sum(x => x.Amount),
                PaymentCount = g.Sum(x => x.Count)
            })
            .OrderByDescending(p => int.Parse(p.Period.Replace("Week ", "")))
            .ToList();

        monthlyIncome = dailyPayments
            .GroupBy(p => new { p.PaymentDate.Year, p.PaymentDate.Month })
            .Select(g => new { Date = new DateTime(g.Key.Year, g.Key.Month, 1), Amount = g.Sum(p => p.Amount), Count = g.Count() })
            .Concat(dailyWalkIns
                .GroupBy(w => new { w.VisitDate.Year, w.VisitDate.Month })
                .Select(g => new { Date = new DateTime(g.Key.Year, g.Key.Month, 1), Amount = g.Sum(w => w.PaymentAmount), Count = g.Count() }))
            .GroupBy(x => x.Date)
            .Select(g => new PeriodIncome
            {
                Period = g.Key.ToString("MMM yyyy"),
                Amount = g.Sum(x => x.Amount),
                PaymentCount = g.Sum(x => x.Count)
            })
            .OrderByDescending(p => DateTime.ParseExact(p.Period, "MMM yyyy", System.Globalization.CultureInfo.InvariantCulture))
            .ToList();
    }

    private int GetWeekOfYear(DateTime date)
    {
        var culture = System.Globalization.CultureInfo.CurrentCulture;
        var calendar = culture.Calendar;
        return calendar.GetWeekOfYear(date, culture.DateTimeFormat.CalendarWeekRule, culture.DateTimeFormat.FirstDayOfWeek);
    }

    private async Task LoadFinancialStatement()
    {
        try
        {
            // 1. Load Equipment Value (Fixed Assets)
            var investments = await Context.Investments.AsNoTracking().ToListAsync();
            totalEquipmentValue = investments.Sum(i => i.Price * i.Quantity);

            // 2. Load Owner's Capital (Money invested by owner)
            var capitals = await Context.Capitals.AsNoTracking().ToListAsync();
            totalOwnersCapital = capitals.Sum(c => c.Amount);

            // 3. Load Total All-Time Revenue (Income earned)
            var allPayments = await Context.Payments.AsNoTracking().ToListAsync();
            var allWalkIns = await Context.WalkIns.AsNoTracking().Where(w => !w.IsArchived).ToListAsync();
            totalAllTimeRevenue = allPayments.Sum(p => p.Amount) + allWalkIns.Sum(w => w.PaymentAmount);

            // 4. Load Total Liabilities (Unpaid debts/loans)
            var unpaidLiabilities = await Context.Liabilities.AsNoTracking().Where(l => !l.IsArchived && !l.IsPaid).ToListAsync();
            totalLiabilities = unpaidLiabilities.Sum(l => l.Amount);

            // 5. Load Total Expenses (Paid liabilities - money already spent)
            var paidLiabilities = await Context.Liabilities.AsNoTracking().Where(l => !l.IsArchived && l.IsPaid).ToListAsync();
            totalExpenses = paidLiabilities.Sum(l => l.Amount);

            // 6. Calculate Retained Earnings (Revenue - Expenses)
            retainedEarnings = totalAllTimeRevenue - totalExpenses;

            // 7. Calculate Cash (Capital + Revenue - Equipment - Expenses)
            // Cash = Money invested + Money earned - Money spent on equipment - Money spent on expenses
            totalCash = totalOwnersCapital + totalAllTimeRevenue - totalEquipmentValue - totalExpenses;

            // 8. Calculate Total Assets (Cash + Equipment)
            totalAssets = totalCash + totalEquipmentValue;

            // 9. Calculate Total Equity (Owner's Capital + Retained Earnings)
            totalEquity = totalOwnersCapital + retainedEarnings;

            // Accounting Equation: Assets = Liabilities + Equity
            // This should balance when all entries are correct
        }
        catch (Exception ex)
        {
            // Set defaults on error
            totalEquipmentValue = 0;
            totalOwnersCapital = 0;
            totalAllTimeRevenue = 0;
            totalCash = 0;
            totalLiabilities = 0;
            totalExpenses = 0;
            retainedEarnings = 0;
            totalAssets = 0;
            totalEquity = 0;
        }
    }

    private async Task PrintFinancialReports()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function() {
                    window.print();
                })();
            ");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error printing: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Wait a bit longer on first render for Chart.js to be fully loaded
            await Task.Delay(500);
        }
        
        if (roiLabels.Any() && roiData.Any() && !roiChartInitialized)
        {
            await InitializeROIChart();
        }
        
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task InitializeROIChart()
    {
        if (!roiLabels.Any() || !roiData.Any())
        {
            return;
        }

        try
        {
            await Task.Delay(300); // Small delay to ensure DOM is ready
            await JSRuntime.InvokeVoidAsync("initROIChart", roiLabels.ToArray(), roiData.ToArray());
            roiChartInitialized = true;
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error initializing ROI chart: {ex.Message}");
            // Try alternative method
            try
            {
                await Task.Delay(200);
                await JSRuntime.InvokeVoidAsync("dashboardCharts.initROIChart", roiLabels.ToArray(), roiData.ToArray());
                roiChartInitialized = true;
            }
            catch (Exception ex2)
            {
                System.Diagnostics.Debug.WriteLine($"Error with alternative method: {ex2.Message}");
            }
        }
    }
}

