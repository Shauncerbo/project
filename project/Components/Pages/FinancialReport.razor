@page "/reports/financial"
@layout MainLayout
@using project.Data
@using project.Models
@using PaymentModel = project.Models.Payment
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Context
@inject IJSRuntime JSRuntime

<div class="financial-report">
    <div class="reports-header">
        <h1>Financial Report</h1>
        <div class="date-filter">
            <label>Period:</label>
            <select @bind="selectedPeriod" @bind:after="OnPeriodChanged" class="period-select">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
                <option value="custom">Custom Range</option>
            </select>
            @if (selectedPeriod == "custom")
            {
                <input type="date" @bind="customStartDate" @bind:after="OnPeriodChanged" class="date-input" />
                <span>to</span>
                <input type="date" @bind="customEndDate" @bind:after="OnPeriodChanged" class="date-input" />
            }
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-message">Loading financial reports...</div>
    }
    else
    {
        <!-- Print Header -->
        <div class="print-header financial-print-header">
            <div class="print-header-top">
                <div class="print-gym-name">PowerHouse Gym</div>
                <div class="print-date-time">@DateTime.Now.ToString("MMM dd, yyyy hh:mm tt")</div>
            </div>
            <div class="print-footer">Printed by: Admin</div>
        </div>

        <div id="financial-reports-content">
            <!-- Quick Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card income">
                    <div class="stat-info">
                        <div class="stat-text">
                            <h3>Total Income</h3>
                            <div class="stat-breakdown">
                                <span>Members: ₱@(memberIncome.ToString("N2"))</span>
                                <span>Walk-ins: ₱@(walkinIncome.ToString("N2"))</span>
                            </div>
                        </div>
                        <div class="stat-amount">₱@(totalIncome.ToString("N2"))</div>
                    </div>
                </div>

                <div class="stat-card clv">
                    <div class="stat-info">
                        <div class="stat-text">
                            <h3>Avg. Lifetime Value</h3>
                            <div class="stat-breakdown">
                                <span>Per Member</span>
                            </div>
                        </div>
                        <div class="stat-amount">₱@(averageCLV.ToString("N2"))</div>
                    </div>
                </div>
            </div>

            <!-- Business Performance Overview - Revenue -->
            <div class="reports-section">
                <div class="section-header">
                    <h2>Business Performance Overview</h2>
                </div>
                <div class="performance-overview">
                    <div class="performance-card">
                        <div class="performance-header">
                            <h3>Revenue Movement</h3>
                            <span class="performance-indicator @(revenueDirection == "Growing" ? "success" : revenueDirection == "Declining" ? "danger" : "warning")">
                                @if (revenueDirection == "Growing")
                                {
                                    <span>↑</span>
                                }
                                else if (revenueDirection == "Declining")
                                {
                                    <span>↓</span>
                                }
                                else
                                {
                                    <span>→</span>
                                }
                                @revenueDirection
                            </span>
                        </div>
                        <div class="performance-content">
                            <div class="performance-metric">
                                <span>Current Period:</span>
                                <span class="amount">₱@(currentPeriodRevenue.ToString("N2"))</span>
                            </div>
                            <div class="performance-metric">
                                <span>Previous Period:</span>
                                <span>₱@(previousPeriodRevenue.ToString("N2"))</span>
                            </div>
                            <div class="performance-metric">
                                <span>Change:</span>
                                <span class="@(revenueChangePercent >= 0 ? "success" : "danger")">
                                    @(revenueChangePercent >= 0 ? "+" : "")@(revenueChangePercent.ToString("F1"))%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Reports Section -->
            <div class="reports-section" id="financial-reports-section">
                <div class="section-header">
                    <h2>Financial Reports</h2>
                    <div class="export-buttons">
                        <button class="export-btn print-btn" @onclick="PrintFinancialReports" title="Print Financial Reports">
                            <span></span> Print
                        </button>
                    </div>
                </div>

                <div class="reports-grid">
                    <!-- Revenue by Payment Method -->
                    <div class="report-card">
                        <h3>Revenue by Payment Method</h3>
                        <div class="report-content">
                            <div class="report-item">
                                <span>Cash:</span>
                                <span class="amount">₱@(cashRevenue.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Payment Online (PayMongo):</span>
                                <span class="amount">₱@(ewalletRevenue.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Total:</span>
                                <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Cash %:</span>
                                <span>@(cashPercentage.ToString("F1"))%</span>
                            </div>
                            <div class="report-item">
                                <span>Payment Online (PayMongo) %:</span>
                                <span>@(ewalletPercentage.ToString("F1"))%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue by Membership Type -->
                    <div class="report-card">
                        <h3>Revenue by Membership Type</h3>
                        <div class="report-content">
                            @foreach (var mt in revenueByMembershipType)
                            {
                                <div class="report-item">
                                    <span>@mt.TypeName:</span>
                                    <span class="amount">₱@(mt.Revenue.ToString("N2"))</span>
                                </div>
                            }
                            <div class="report-item">
                                <span>Total:</span>
                                <span class="amount total">₱@(revenueByMembershipType.Sum(m => m.Revenue).ToString("N2"))</span>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue by Source -->
                    <div class="report-card" id="revenue-by-source">
                        <h3>Revenue by Source</h3>
                        <div class="report-content">
                            <div class="report-item">
                                <span>Member Subscriptions:</span>
                                <span class="amount">₱@(memberIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Walk-ins:</span>
                                <span class="amount">₱@(walkinIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Total Revenue:</span>
                                <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Members %:</span>
                                <span>@(memberPercentage.ToString("F1"))%</span>
                            </div>
                            <div class="report-item">
                                <span>Walk-ins %:</span>
                                <span>@(walkinPercentage.ToString("F1"))%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Total Revenue -->
                    <div class="report-card">
                        <h3>Total Revenue</h3>
                        <div class="report-content">
                            <div class="report-item">
                                <span>Total Revenue:</span>
                                <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Member Subscriptions:</span>
                                <span class="amount">₱@(memberIncome.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Walk-ins:</span>
                                <span class="amount">₱@(walkinIncome.ToString("N2"))</span>
                            </div>
                        </div>
                    </div>

                    <!-- Growth Trend Report -->
                    <div class="report-card full-width">
                        <h3>Growth Trend Report</h3>
                        <div class="report-content">
                            <div class="growth-grid">
                                <div class="growth-item">
                                    <div class="growth-label">Revenue Growth</div>
                                    <div class="growth-value @(revenueGrowthPercent >= 0 ? "success" : "danger")">
                                        @(revenueGrowthPercent >= 0 ? "+" : "")@(revenueGrowthPercent.ToString("F1"))%
                                    </div>
                                    <div class="growth-detail">
                                        <span>Current: ₱@(currentPeriodRevenue.ToString("N2"))</span>
                                        <span>Previous: ₱@(previousPeriodRevenue.ToString("N2"))</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KPI Trend Chart -->
                    <div class="report-card full-width">
                        <h3>KPI Trend Chart</h3>
                        <div class="report-content">
                            <div class="kpi-trend-container">
                                <div class="kpi-trend-grid">
                                    @foreach (var kpi in kpiTrends)
                                    {
                                        <div class="kpi-trend-item">
                                            <div class="kpi-trend-label">@kpi.Label</div>
                                            <div class="kpi-trend-bar">
                                                <div class="kpi-trend-fill" style="width: @(Math.Min(100, Math.Max(0, kpi.NormalizedValue)))%"></div>
                                            </div>
                                            <div class="kpi-trend-value @(kpi.ChangePercent >= 0 ? "success" : "danger")">
                                                @kpi.CurrentValue
                                                @if (kpi.ChangePercent != 0)
                                                {
                                                    <span class="kpi-change">(@(kpi.ChangePercent >= 0 ? "+" : "")@(kpi.ChangePercent.ToString("F1"))%)</span>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="kpi-summary">
                                    <div class="kpi-summary-item">
                                        <span>Business Health:</span>
                                        <span class="@(overallBusinessHealth == "Healthy" ? "success" : overallBusinessHealth == "At Risk" ? "danger" : "warning")">@overallBusinessHealth</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Lifetime Value -->
                    <div class="report-card" id="customer-lifetime-value">
                        <h3>Customer Lifetime Value</h3>
                        <div class="report-content">
                            <div class="report-item">
                                <span>Average CLV:</span>
                                <span class="amount">₱@(averageCLV.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Total CLV:</span>
                                <span class="amount">₱@(totalCLV.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Top 10% CLV:</span>
                                <span class="amount">₱@(top10PercentCLV.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Avg. Revenue/Member:</span>
                                <span class="amount">₱@(averageRevenuePerMember.ToString("N2"))</span>
                            </div>
                        </div>
                    </div>

                    <!-- Marketing ROI -->
                    <div class="report-card">
                        <h3>Marketing ROI</h3>
                        <div class="report-content">
                            <div class="report-item">
                                <span>Promotions Used:</span>
                                <span>@promotionsUsed</span>
                            </div>
                            <div class="report-item">
                                <span>Revenue from Promos:</span>
                                <span class="amount">₱@(revenueFromPromotions.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Total Discount Given:</span>
                                <span class="amount">₱@(totalDiscountGiven.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>Net Revenue (After Discount):</span>
                                <span class="amount">₱@(netRevenueAfterDiscount.ToString("N2"))</span>
                            </div>
                            <div class="report-item">
                                <span>ROI:</span>
                                <span class="@(marketingROI >= 100 ? "success" : "warning")">@(marketingROI.ToString("F1"))%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Daily/Weekly/Monthly Income Report -->
                    <div class="report-card full-width">
                        <h3>Daily / Weekly / Monthly Income Report</h3>
                        <div class="report-content">
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e1e8ed;">
                                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                    <label style="font-weight: 600; color: #234060;">Filter Period:</label>
                                    <select @bind="incomeReportPeriod" @bind:after="OnIncomeReportPeriodChanged" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="year">This Year</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                    @if (incomeReportPeriod == "custom")
                                    {
                                        <input type="date" @bind="incomeReportStartDate" @bind:after="OnIncomeReportPeriodChanged" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" />
                                        <span style="color: #666;">to</span>
                                        <input type="date" @bind="incomeReportEndDate" @bind:after="OnIncomeReportPeriodChanged" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" />
                                    }
                                    <button @onclick="RefreshIncomeReport" style="padding: 8px 16px; background: #234060; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                        Apply Filter
                                    </button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 10px; color: #234060;">Daily Income</h4>
                                    <div class="reports-table-wrapper" style="max-height: 300px; overflow-y: auto;">
                                        <table class="members-table reports-table">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Amount</th>
                                                    <th>Transactions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (!dailyIncome.Any())
                                                {
                                                    <tr>
                                                        <td colspan="3" class="no-data">No daily income data</td>
                                                    </tr>
                                                }
                                                else
                                                {
                                                    @foreach (var day in dailyIncome)
                                                    {
                                                        <tr>
                                                            <td>@day.Period</td>
                                                            <td class="amount">₱@(day.Amount.ToString("N2"))</td>
                                                            <td>@day.PaymentCount</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 10px; color: #234060;">Weekly Income</h4>
                                    <div class="reports-table-wrapper" style="max-height: 300px; overflow-y: auto;">
                                        <table class="members-table reports-table">
                                            <thead>
                                                <tr>
                                                    <th>Week</th>
                                                    <th>Amount</th>
                                                    <th>Transactions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (!weeklyIncome.Any())
                                                {
                                                    <tr>
                                                        <td colspan="3" class="no-data">No weekly income data</td>
                                                    </tr>
                                                }
                                                else
                                                {
                                                    @foreach (var week in weeklyIncome)
                                                    {
                                                        <tr>
                                                            <td>@week.Period</td>
                                                            <td class="amount">₱@(week.Amount.ToString("N2"))</td>
                                                            <td>@week.PaymentCount</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 10px; color: #234060;">Monthly Income</h4>
                                    <div class="reports-table-wrapper" style="max-height: 300px; overflow-y: auto;">
                                        <table class="members-table reports-table">
                                            <thead>
                                                <tr>
                                                    <th>Month</th>
                                                    <th>Amount</th>
                                                    <th>Transactions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (!monthlyIncome.Any())
                                                {
                                                    <tr>
                                                        <td colspan="3" class="no-data">No monthly income data</td>
                                                    </tr>
                                                }
                                                else
                                                {
                                                    @foreach (var month in monthlyIncome)
                                                    {
                                                        <tr>
                                                            <td>@month.Period</td>
                                                            <td class="amount">₱@(month.Amount.ToString("N2"))</td>
                                                            <td>@month.PaymentCount</td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@* Include all the styles and code from the original Reports.razor *@
<style>
    /* Copy all styles from original Reports.razor - this is a simplified version */
    .financial-report {
        padding: 20px;
    }

    .reports-header {
        background: white;
        padding: 25px 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .reports-header h1 {
        color: #000000;
        margin: 0;
        font-size: 24px;
        font-weight: 600;
    }

    .date-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .date-filter label {
        font-weight: 600;
        color: #000000;
    }

    .period-select, .date-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
    }

    .loading-message {
        text-align: center;
        padding: 50px;
        font-size: 18px;
        color: #000000;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        min-height: 120px;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        gap: 15px;
    }

    .stat-text {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
    }

    .stat-info h3 {
        margin: 0 0 10px 0;
        color: #000000;
        font-size: 1rem;
        font-weight: 600;
        min-height: 24px;
    }

    .stat-amount {
        font-size: 1.8rem;
        font-weight: bold;
        text-align: right;
        white-space: nowrap;
        flex-shrink: 0;
        color: #000000;
        line-height: 1.2;
        margin-top: 0;
    }

    .stat-breakdown {
        font-size: 0.8rem;
        color: #000000;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .reports-section {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-header h2 {
        margin: 0;
        color: #000000;
        font-size: 20px;
        font-weight: 600;
    }

    .export-buttons {
        display: flex;
        gap: 10px;
    }

    .export-btn {
        background: #234060;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s;
    }

    .export-btn:hover {
        background: #1a3450;
        transform: translateY(-1px);
    }

    .print-btn {
        background: #27ae60;
    }

    .print-btn:hover {
        background: #229954;
    }

    .print-header {
        display: none;
    }

    @@media print {
        @@page {
            margin: 0.5cm;
        }

        .reports-header,
        .section-header,
        .export-buttons,
        .date-filter {
            display: none !important;
        }

        .print-header {
            display: block !important;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }

        .print-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .print-gym-name {
            font-size: 24px;
            font-weight: bold;
            color: #000;
        }

        .print-date-time {
            font-size: 14px;
            color: #000;
        }

        .print-footer {
            font-size: 12px;
            color: #666;
            text-align: left;
        }
    }

    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .report-card {
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 20px;
        background: #fafbfc;
    }

    .report-card.full-width {
        grid-column: 1 / -1;
    }

    .report-card h3 {
        margin: 0 0 15px 0;
        color: #000000;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .report-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .report-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #ecf0f1;
        color: #000000;
    }

    .report-item:last-child {
        border-bottom: none;
    }

    .amount {
        font-weight: 600;
        color: #000000;
    }

    .amount.total {
        font-size: 1.1rem;
        color: #000000;
    }

    .success {
        color: #000000;
        font-weight: bold;
    }

    .warning {
        color: #000000;
        font-weight: bold;
    }

    .danger {
        color: #000000;
        font-weight: bold;
    }

    .performance-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .performance-card {
        background: white;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .performance-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f4f8;
    }

    .performance-header h3 {
        margin: 0;
        color: #000000;
        font-size: 1rem;
        font-weight: 600;
    }

    .performance-indicator {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .performance-indicator.success {
        background: transparent;
        color: #000000;
    }

    .performance-indicator.danger {
        background: transparent;
        color: #000000;
    }

    .performance-indicator.warning {
        background: transparent;
        color: #000000;
    }

    .performance-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .performance-metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f4f8;
        color: #000000;
    }

    .performance-metric:last-child {
        border-bottom: none;
    }

    .growth-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 10px;
    }

    .growth-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #e1e8ed;
        text-align: center;
    }

    .growth-label {
        font-size: 0.9rem;
        color: #000000;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .growth-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #000000;
    }

    .growth-detail {
        display: flex;
        flex-direction: column;
        gap: 5px;
        font-size: 0.85rem;
        color: #000000;
    }

    .kpi-trend-container {
        margin-top: 10px;
    }

    .kpi-trend-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .kpi-trend-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e1e8ed;
    }

    .kpi-trend-label {
        min-width: 150px;
        font-weight: 600;
        color: #000000;
    }

    .kpi-trend-bar {
        flex: 1;
        height: 30px;
        background: #e1e8ed;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    .kpi-trend-fill {
        height: 100%;
        background: linear-gradient(90deg, #234060 0%, #3498db 100%);
        border-radius: 15px;
        transition: width 0.3s ease;
    }

    .kpi-trend-value {
        min-width: 120px;
        text-align: right;
        font-weight: bold;
        font-size: 1.1rem;
        color: #000000;
    }

    .kpi-change {
        font-size: 0.85rem;
        margin-left: 5px;
    }

    .kpi-summary {
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e1e8ed;
    }

    .kpi-summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #000000;
    }

    .reports-table-wrapper {
        overflow-x: auto;
        margin-top: 8px;
    }

    .reports-table {
        width: 100%;
        border-collapse: collapse;
    }

    .reports-table thead {
        background: #234060;
        color: #ffffff;
    }

    .reports-table th,
    .reports-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
        text-align: left;
    }

    .reports-table tbody tr:hover {
        background: #f8f9fa;
    }

    .no-data {
        text-align: center;
        padding: 16px 0;
        color: #777;
        font-style: italic;
    }

    .members-table {
        width: 100%;
        border-collapse: collapse;
    }
</style>

@code {
    private string selectedPeriod = "month";
    private DateTime? customStartDate = DateTime.Today.AddDays(-30);
    private DateTime? customEndDate = DateTime.Today;
    private bool isLoading = true;

    private string incomeReportPeriod = "month";
    private DateTime? incomeReportStartDate = DateTime.Today.AddDays(-30);
    private DateTime? incomeReportEndDate = DateTime.Today;

    private decimal totalIncome = 0;
    private decimal memberIncome = 0;
    private decimal walkinIncome = 0;
    private decimal cashRevenue = 0;
    private decimal ewalletRevenue = 0;
    private decimal cashPercentage = 0;
    private decimal ewalletPercentage = 0;
    private decimal memberPercentage = 0;
    private decimal walkinPercentage = 0;

    private decimal averageCLV = 0;
    private decimal totalCLV = 0;
    private decimal top10PercentCLV = 0;
    private decimal averageRevenuePerMember = 0;

    private int promotionsUsed = 0;
    private decimal revenueFromPromotions = 0;
    private decimal totalDiscountGiven = 0;
    private decimal netRevenueAfterDiscount = 0;
    private double marketingROI = 0;

    private List<MembershipTypeRevenue> revenueByMembershipType = new();
    private List<KPITrend> kpiTrends = new();
    private string overallBusinessHealth = "Stable";

    private string revenueDirection = "Stable";
    private decimal currentPeriodRevenue = 0;
    private decimal previousPeriodRevenue = 0;
    private double revenueChangePercent = 0;
    private double revenueGrowthPercent = 0;

    private List<PeriodIncome> dailyIncome = new();
    private List<PeriodIncome> weeklyIncome = new();
    private List<PeriodIncome> monthlyIncome = new();

    private class MembershipTypeRevenue
    {
        public string TypeName { get; set; } = string.Empty;
        public decimal Revenue { get; set; }
    }

    private class KPITrend
    {
        public string Label { get; set; } = string.Empty;
        public decimal CurrentValue { get; set; }
        public decimal PreviousValue { get; set; }
        public double ChangePercent { get; set; }
        public double NormalizedValue { get; set; }
    }

    private class PeriodIncome
    {
        public string Period { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public int PaymentCount { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadReportData();
    }

    private async Task OnPeriodChanged()
    {
        await LoadReportData();
    }

    private async Task OnIncomeReportPeriodChanged()
    {
        await RefreshIncomeReport();
    }

    private async Task RefreshIncomeReport()
    {
        var (startDate, endDate) = GetIncomeReportDateRange();
        await LoadPeriodIncomeReports(startDate, endDate);
        StateHasChanged();
    }

    private (DateTime start, DateTime end) GetIncomeReportDateRange()
    {
        var today = DateTime.Today;
        return incomeReportPeriod switch
        {
            "today" => (today, today.AddDays(1).AddSeconds(-1)),
            "week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(1).AddSeconds(-1)),
            "month" => (new DateTime(today.Year, today.Month, 1), today.AddDays(1).AddSeconds(-1)),
            "year" => (new DateTime(today.Year, 1, 1), today.AddDays(1).AddSeconds(-1)),
            "custom" => (incomeReportStartDate ?? today.AddDays(-30), incomeReportEndDate ?? today),
            _ => (today.AddDays(-30), today)
        };
    }

    private (DateTime start, DateTime end) GetDateRange()
    {
        var today = DateTime.Today;
        return selectedPeriod switch
        {
            "today" => (today, today.AddDays(1).AddSeconds(-1)),
            "week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(1).AddSeconds(-1)),
            "month" => (new DateTime(today.Year, today.Month, 1), today.AddDays(1).AddSeconds(-1)),
            "year" => (new DateTime(today.Year, 1, 1), today.AddDays(1).AddSeconds(-1)),
            "custom" => (customStartDate ?? today.AddDays(-30), customEndDate ?? today),
            _ => (today.AddDays(-30), today)
        };
    }

    private async Task LoadReportData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var (startDate, endDate) = GetDateRange();

            await LoadRevenueByPaymentMethod(startDate, endDate);
            await LoadRevenueByMembershipType(startDate, endDate);
            await LoadRevenueBySource(startDate, endDate);
            await LoadBusinessPerformanceOverview(startDate, endDate);
            await LoadGrowthTrendReport(startDate, endDate);
            await LoadKPITrendChart(startDate, endDate);
            await LoadCustomerLifetimeValue();
            await LoadMarketingROI(startDate, endDate);
            await LoadPeriodIncomeReports(GetIncomeReportDateRange().start, GetIncomeReportDateRange().end);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading reports: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadRevenueByPaymentMethod(DateTime startDate, DateTime endDate)
    {
        var memberPayments = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .ToListAsync();

        cashRevenue = memberPayments.Where(p => p.PaymentType == "Cash").Sum(p => p.Amount);
        ewalletRevenue = memberPayments.Where(p => p.PaymentType == "PayMongo" || p.PaymentType == "Ewallet").Sum(p => p.Amount);

        var walkinPayments = await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .ToListAsync();

        cashRevenue += walkinPayments.Where(w => w.PaymentMethod == "Cash").Sum(w => w.PaymentAmount);
        ewalletRevenue += walkinPayments.Where(w => w.PaymentMethod == "PayMongo" || w.PaymentMethod == "Ewallet").Sum(w => w.PaymentAmount);

        totalIncome = cashRevenue + ewalletRevenue;
        cashPercentage = totalIncome > 0 ? (cashRevenue / totalIncome) * 100 : 0;
        ewalletPercentage = totalIncome > 0 ? (ewalletRevenue / totalIncome) * 100 : 0;
    }

    private async Task LoadRevenueByMembershipType(DateTime startDate, DateTime endDate)
    {
        var payments = await Context.Payments
            .Include(p => p.Member)
            .ThenInclude(m => m!.MembershipType)
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .ToListAsync();

        revenueByMembershipType = payments
            .Where(p => p.Member?.MembershipType != null)
            .GroupBy(p => p.Member!.MembershipType!.TypeName)
            .Select(g => new MembershipTypeRevenue
            {
                TypeName = g.Key,
                Revenue = g.Sum(p => p.Amount)
            })
            .OrderByDescending(m => m.Revenue)
            .ToList();
    }

    private async Task LoadRevenueBySource(DateTime startDate, DateTime endDate)
    {
        memberIncome = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);

        walkinIncome = await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        totalIncome = memberIncome + walkinIncome;
        memberPercentage = totalIncome > 0 ? (memberIncome / totalIncome) * 100 : 0;
        walkinPercentage = totalIncome > 0 ? (walkinIncome / totalIncome) * 100 : 0;
    }

    private async Task LoadBusinessPerformanceOverview(DateTime startDate, DateTime endDate)
    {
        var periodLength = (endDate - startDate).TotalDays;
        var previousStartDate = startDate.AddDays(-periodLength - 1);
        var previousEndDate = startDate.AddSeconds(-1);

        currentPeriodRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);
        currentPeriodRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        previousPeriodRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= previousStartDate && p.PaymentDate <= previousEndDate)
            .SumAsync(p => p.Amount);
        previousPeriodRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= previousStartDate && w.VisitDate <= previousEndDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        revenueChangePercent = previousPeriodRevenue > 0 
            ? (double)((currentPeriodRevenue - previousPeriodRevenue) / previousPeriodRevenue) * 100 
            : (currentPeriodRevenue > 0 ? 100 : 0);
        revenueDirection = revenueChangePercent > 5 ? "Growing" : revenueChangePercent < -5 ? "Declining" : "Stable";
    }

    private async Task LoadGrowthTrendReport(DateTime startDate, DateTime endDate)
    {
        var periodLength = (endDate - startDate).TotalDays;
        var previousStartDate = startDate.AddDays(-periodLength - 1);
        var previousEndDate = startDate.AddSeconds(-1);

        var currentRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);
        currentRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        var previousRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= previousStartDate && p.PaymentDate <= previousEndDate)
            .SumAsync(p => p.Amount);
        previousRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= previousStartDate && w.VisitDate <= previousEndDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        revenueGrowthPercent = previousRevenue > 0 
            ? (double)((currentRevenue - previousRevenue) / previousRevenue) * 100 
            : (currentRevenue > 0 ? 100 : 0);
    }

    private async Task LoadKPITrendChart(DateTime startDate, DateTime endDate)
    {
        var periodLength = (endDate - startDate).TotalDays;
        var previousStartDate = startDate.AddDays(-periodLength - 1);
        var previousEndDate = startDate.AddSeconds(-1);

        kpiTrends = new List<KPITrend>();

        var currentRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);
        currentRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        var previousRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= previousStartDate && p.PaymentDate <= previousEndDate)
            .SumAsync(p => p.Amount);
        previousRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= previousStartDate && w.VisitDate <= previousEndDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        var revenueChange = previousRevenue > 0 
            ? ((currentRevenue - previousRevenue) / previousRevenue) * 100 
            : (currentRevenue > 0 ? 100 : 0);

        kpiTrends.Add(new KPITrend
        {
            Label = "Revenue",
            CurrentValue = currentRevenue,
            PreviousValue = previousRevenue,
            ChangePercent = (double)revenueChange,
            NormalizedValue = Math.Min(100, Math.Max(0, (double)(currentRevenue / Math.Max(1, previousRevenue)) * 50))
        });

        var healthyKPIs = kpiTrends.Count(k => k.ChangePercent >= 0);
        overallBusinessHealth = healthyKPIs >= 1 ? "Healthy" : "At Risk";
    }

    private async Task LoadCustomerLifetimeValue()
    {
        var members = await Context.Members
            .Include(m => m.Payments)
            .Where(m => !m.IsArchived)
            .ToListAsync();

        if (!members.Any())
        {
            averageCLV = 0;
            totalCLV = 0;
            averageRevenuePerMember = 0;
            return;
        }

        var memberCLVs = members.Select(m => new
        {
            MemberID = m.MemberID,
            TotalRevenue = m.Payments.Sum(p => p.Amount)
        }).ToList();

        totalCLV = memberCLVs.Sum(m => m.TotalRevenue);
        averageCLV = memberCLVs.Any() ? memberCLVs.Average(m => m.TotalRevenue) : 0;
        averageRevenuePerMember = averageCLV;

        var sortedCLVs = memberCLVs.OrderByDescending(m => m.TotalRevenue).ToList();
        var top10PercentCount = Math.Max(1, (int)(sortedCLVs.Count * 0.1));
        top10PercentCLV = sortedCLVs.Take(top10PercentCount).Any() 
            ? sortedCLVs.Take(top10PercentCount).Average(m => m.TotalRevenue) 
            : 0;
    }

    private async Task LoadMarketingROI(DateTime startDate, DateTime endDate)
    {
        try
        {
            var memberPromos = await Context.MemberPromos
                .Include(mp => mp.Promotion)
                .Include(mp => mp.Member)
                .ThenInclude(m => m!.Payments)
                .Where(mp => mp.DateUsed.HasValue && mp.DateUsed >= startDate && mp.DateUsed <= endDate)
                .ToListAsync();

            promotionsUsed = memberPromos.Count;

            revenueFromPromotions = memberPromos
                .Where(mp => mp.Member != null)
                .Sum(mp => mp.Member!.Payments
                    .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
                    .Sum(p => p.Amount));

            totalDiscountGiven = memberPromos
                .Where(mp => mp.Promotion != null && mp.Member != null)
                .Sum(mp =>
                {
                    var memberPayments = mp.Member!.Payments
                        .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
                        .Sum(p => p.Amount);
                    return memberPayments * (mp.Promotion!.DiscountRate / 100);
                });

            netRevenueAfterDiscount = revenueFromPromotions - totalDiscountGiven;

            marketingROI = totalDiscountGiven > 0 
                ? (double)((netRevenueAfterDiscount / totalDiscountGiven) * 100) 
                : revenueFromPromotions > 0 ? 100 : 0;
        }
        catch (Exception)
        {
            promotionsUsed = 0;
            revenueFromPromotions = 0;
            totalDiscountGiven = 0;
            netRevenueAfterDiscount = 0;
            marketingROI = 0;
        }
    }

    private async Task LoadPeriodIncomeReports(DateTime startDate, DateTime endDate)
    {
        var dailyPayments = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .ToListAsync();
        var dailyWalkIns = await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .ToListAsync();

        dailyIncome = dailyPayments
            .GroupBy(p => p.PaymentDate.Date)
            .Select(g => new PeriodIncome
            {
                Period = g.Key.ToString("MMM dd, yyyy"),
                Amount = g.Sum(p => p.Amount),
                PaymentCount = g.Count()
            })
            .Concat(dailyWalkIns
                .GroupBy(w => w.VisitDate.Date)
                .Select(g => new PeriodIncome
                {
                    Period = g.Key.ToString("MMM dd, yyyy"),
                    Amount = g.Sum(w => w.PaymentAmount),
                    PaymentCount = g.Count()
                }))
            .GroupBy(p => p.Period)
            .Select(g => new PeriodIncome
            {
                Period = g.Key,
                Amount = g.Sum(p => p.Amount),
                PaymentCount = g.Sum(p => p.PaymentCount)
            })
            .OrderBy(p => p.Period)
            .ToList();

        weeklyIncome = dailyPayments
            .GroupBy(p => GetWeekOfYear(p.PaymentDate))
            .Select(g => new PeriodIncome
            {
                Period = $"Week {g.Key}",
                Amount = g.Sum(p => p.Amount),
                PaymentCount = g.Count()
            })
            .Concat(dailyWalkIns
                .GroupBy(w => GetWeekOfYear(w.VisitDate))
                .Select(g => new PeriodIncome
                {
                    Period = $"Week {g.Key}",
                    Amount = g.Sum(w => w.PaymentAmount),
                    PaymentCount = g.Count()
                }))
            .GroupBy(p => p.Period)
            .Select(g => new PeriodIncome
            {
                Period = g.Key,
                Amount = g.Sum(p => p.Amount),
                PaymentCount = g.Sum(p => p.PaymentCount)
            })
            .OrderBy(p => p.Period)
            .ToList();

        monthlyIncome = dailyPayments
            .GroupBy(p => new { p.PaymentDate.Year, p.PaymentDate.Month })
            .Select(g => new PeriodIncome
            {
                Period = new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MMM yyyy"),
                Amount = g.Sum(p => p.Amount),
                PaymentCount = g.Count()
            })
            .Concat(dailyWalkIns
                .GroupBy(w => new { w.VisitDate.Year, w.VisitDate.Month })
                .Select(g => new PeriodIncome
                {
                    Period = new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MMM yyyy"),
                    Amount = g.Sum(w => w.PaymentAmount),
                    PaymentCount = g.Count()
                }))
            .GroupBy(p => p.Period)
            .Select(g => new PeriodIncome
            {
                Period = g.Key,
                Amount = g.Sum(p => p.Amount),
                PaymentCount = g.Sum(p => p.PaymentCount)
            })
            .OrderBy(p => p.Period)
            .ToList();
    }

    private int GetWeekOfYear(DateTime date)
    {
        var culture = System.Globalization.CultureInfo.CurrentCulture;
        var calendar = culture.Calendar;
        return calendar.GetWeekOfYear(date, culture.DateTimeFormat.CalendarWeekRule, culture.DateTimeFormat.FirstDayOfWeek);
    }

    private async Task PrintFinancialReports()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function() {
                    window.print();
                })();
            ");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error printing: {ex.Message}");
        }
    }
}

