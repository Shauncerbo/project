@page "/dashboard"
@layout MainLayout
@using project.Services
@using project.Data
@using Microsoft.EntityFrameworkCore
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject AppDbContext Context
@inject IJSRuntime JSRuntime
@inject project.Services.IToastService ToastService
@using project.Models

<div class="container-fluid px-0">
    <div class="dashboard-page">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="header-text">
                    <h1>@GetDashboardTitle() Dashboard</h1>
                    <p>Welcome @currentUsername! | @GetDashboardDescription()</p>
                </div>
                <div class="header-actions">
                    <!-- User badge (clickable to change password) -->
                    <div class="user-badge clickable" @onclick="OpenPasswordModal" title="Click to change password">
                        <div class="user-circle">
                            @currentUsername?.FirstOrDefault().ToString().ToUpper()
                        </div>
                        <span class="user-role-text">@currentUserRole</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Overview -->
        @if (currentUserRole?.ToLower() == "admin")
        {
            <div class="row g-3 mb-4">
                <div class="col-xxl-3 col-xl-3 col-lg-6 col-md-6 col-sm-6 col-12">
                    <div class="stat-card role-card" data-role="admin" @onclick="NavigateToMembers">
                        <div class="stat-card-header">
                        <h3>MANAGE MEMBERS</h3>
                        <p class="stat-number @GetStatNumberClass(totalActiveMembers)">@totalActiveMembers</p>
                        </div>
                        <span class="stat-note">Active members in the system</span>
                    </div>
                </div>
                <div class="col-xxl-3 col-xl-3 col-lg-6 col-md-6 col-sm-6 col-12">
                    <div class="stat-card role-card" data-role="admin" @onclick="NavigateToAttendance">
                        <div class="stat-card-header">
                        <h3>CHECK-INS TODAY</h3>
                        <p class="stat-number @GetStatNumberClass(todaysCheckIns)">@todaysCheckIns</p>
                        </div>
                        <span class="stat-note">Verified scans for @DateTime.Today.ToString("MMM dd")</span>
                    </div>
                </div>
                <div class="col-xxl-3 col-xl-3 col-lg-6 col-md-6 col-sm-6 col-12">
                    <div class="stat-card role-card revenue-card" data-role="admin" @onclick="NavigateToFinancialReport">
                        <div class="stat-card-header revenue-header">
                        <h3>TOTAL REVENUE</h3>
                        </div>
                        <p class="stat-number revenue-number @GetStatNumberClass(totalRevenue)">@FormatRevenue(totalRevenue)</p>
                        <span class="stat-note">This month revenue</span>
                    </div>
                </div>
                <div class="col-xxl-3 col-xl-3 col-lg-6 col-md-6 col-sm-6 col-12">
                    <div class="stat-card role-card revenue-card" data-role="admin" @onclick="NavigateToPayments">
                        <div class="stat-card-header revenue-header">
                        <h3>TODAY'S PAYMENTS</h3>
                        </div>
                        <p class="stat-number revenue-number @GetStatNumberClass(todaysRevenue)">@FormatRevenue(todaysRevenue)</p>
                        <span class="stat-note">Revenue for @DateTime.Today.ToString("MMM dd")</span>
                    </div>
                </div>
            </div>
        }

        <!-- Role-Based Features (for non-admin roles) -->
        @if (currentUserRole?.ToLower() != "admin")
        {
            <div class="row g-3 mb-4">
                @if (currentUserRole?.ToLower() == "staff")
                {
                    <div class="col-xxl-3 col-xl-3 col-lg-6 col-md-6 col-sm-6 col-12">
                        <div class="stat-card role-card" data-role="staff" @onclick="NavigateToMembers">
                            <div class="stat-card-header">
                            <h3>MANAGE MEMBERS</h3>
                            <p class="stat-number @GetStatNumberClass(totalActiveMembers)">@totalActiveMembers</p>
                            </div>
                            <span class="stat-note">Active members</span>
                        </div>
                    </div>
                }

                @if (currentUserRole?.ToLower() == "staff" || currentUserRole?.ToLower() == "trainer")
                {
                    <div class="col-xxl-3 col-xl-3 col-lg-6 col-md-6 col-sm-6 col-12">
                        <!-- Use role-specific border color based on the actual role -->
                        <div class="stat-card role-card" data-role="@currentUserRole?.ToLower()" @onclick="NavigateToAttendance">
                            <div class="stat-card-header">
                            <h3>CHECK-INS TODAY</h3>
                            <p class="stat-number @GetStatNumberClass(todaysCheckIns)">@todaysCheckIns</p>
                            </div>
                            <span class="stat-note">Verified scans for @DateTime.Today.ToString("MMM dd")</span>
                        </div>
                    </div>
                }

                @if (currentUserRole?.ToLower() == "staff")
                {
                    <div class="col-xxl-3 col-xl-3 col-lg-6 col-md-6 col-sm-6 col-12">
                        <div class="stat-card role-card revenue-card" data-role="staff" @onclick="NavigateToPayments">
                            <div class="stat-card-header revenue-header">
                            <h3>TODAY'S PAYMENTS</h3>
                            </div>
                            <p class="stat-number revenue-number @GetStatNumberClass(todaysRevenue)">@FormatRevenue(todaysRevenue)</p>
                            <span class="stat-note">Revenue for today</span>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Charts / Summaries Section (admin only, no external JS) -->
        @if (currentUserRole?.ToLower() == "admin")
        {
            <div class="row g-3 mb-4">
                <div class="col-xxl-8 col-xl-8 col-lg-12">
                    <div class="chart-card">
                        <h3>Revenue Trend (Last 7 Days)</h3>
                        @if (revenueLabels.Any())
                        {
                            <!-- Chart.js Line Chart -->
                            <div class="chart-container" style="position: relative; height: 300px; margin-bottom: 20px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                            <table class="summary-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th class="text-right">Revenue (₱)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < revenueLabels.Count; i++)
                                    {
                                        <tr>
                                            <td>@revenueLabels[i]</td>
                                            <td class="text-right">@revenueData[i].ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="empty-summary">No revenue data found for the last 7 days.</div>
                        }
                    </div>
                </div>
                <div class="col-xxl-4 col-xl-4 col-lg-12">
                    <!-- Role-Based Quick Actions -->
                    <div class="recent-activity quick-actions-sidebar">
                        <h2>@GetDashboardTitle() Quick Actions</h2>
                        <div class="activity-list">
                            @if (currentUserRole?.ToLower() == "admin" || currentUserRole?.ToLower() == "staff")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToMembers">
                                    <span class="activity-badge">[MANAGE]</span>
                                    <span class="activity-text">Manage Members @(currentUserRole?.ToLower() == "admin" ? "(Add/Edit/Delete)" : "(Add/Edit Only)")</span>
                                </div>
                            }

                            @if (currentUserRole?.ToLower() == "admin" || currentUserRole?.ToLower() == "staff" || currentUserRole?.ToLower() == "trainer")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToAttendance">
                                    <span class="activity-badge">[@(currentUserRole?.ToLower() == "trainer" ? "VIEW" : "VERIFY")]</span>
                                    <span class="activity-text">@(currentUserRole?.ToLower() == "trainer" ? "View Member Verification" : "Verify Member")</span>
                                                </div>
                            }

                            @if (currentUserRole?.ToLower() == "admin" || currentUserRole?.ToLower() == "staff")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToPayments">
                                    <span class="activity-badge">[PAYMENTS]</span>
                                    <span class="activity-text">@(currentUserRole?.ToLower() == "admin" ? "Manage Financial Reports" : "Process Payments")</span>
                                            </div>
                            }

                            @if (currentUserRole?.ToLower() == "admin")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToWalkIns">
                                    <span class="activity-badge">[WALK-IN]</span>
                                    <span class="activity-text">Review Walk-in Visitors</span>
                                        </div>
                                    }

                            @if (currentUserRole?.ToLower() == "admin")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToFinancialReport">
                                    <span class="activity-badge">[REPORTS]</span>
                                    <span class="activity-text">View Financial & Marketing Reports</span>
                                </div>
                            }

                            @if (currentUserRole?.ToLower() == "admin")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToTrainers">
                                    <span class="activity-badge">[TRAINERS]</span>
                                    <span class="activity-text">Manage Trainers</span>
                            </div>
                            }

                            @if (currentUserRole?.ToLower() == "admin")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToPromotions">
                                    <span class="activity-badge">[PROMOTIONS]</span>
                                    <span class="activity-text">Manage Promotions</span>
                                </div>
                            }

                            @if (currentUserRole?.ToLower() == "admin")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToMembershipTypes">
                                    <span class="activity-badge">[MEMBERSHIPS]</span>
                                    <span class="activity-text">Manage Membership Types</span>
                                </div>
                            }

                            @if (currentUserRole?.ToLower() == "admin" || currentUserRole?.ToLower() == "staff")
                            {
                                <div class="activity-item role-action" @onclick="NavigateToSettings">
                                    <span class="activity-badge">[SETTINGS]</span>
                                    <span class="activity-text">Account & System Settings</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-xxl-6 col-xl-6 col-lg-12">
                    <div class="chart-card">
                        <h3>Check-ins Trend (Last 7 Days)</h3>
                        @if (checkinsLabels.Any())
                        {
                            <!-- Chart.js Bar Chart -->
                            <div class="chart-container" style="position: relative; height: 300px; margin-bottom: 20px;">
                                <canvas id="checkinsChart"></canvas>
                            </div>
                            <table class="summary-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th class="text-right">Check-ins</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < checkinsLabels.Count; i++)
                                    {
                                        <tr>
                                            <td>@checkinsLabels[i]</td>
                                            <td class="text-right">@checkinsData[i]</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="empty-summary">No attendance records for the last 7 days.</div>
                        }
                    </div>
                </div>
                <div class="col-xxl-6 col-xl-6 col-lg-12">
                    <div class="chart-card">
                        <h3>Member Growth (Last 6 Months)</h3>
                        @if (memberGrowthLabels.Any())
                        {
                            <!-- Chart.js Bar Chart -->
                            <div class="chart-container" style="position: relative; height: 300px; margin-bottom: 20px;">
                                <canvas id="memberGrowthChart"></canvas>
                            </div>
                            <table class="summary-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th class="text-right">New Members</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < memberGrowthLabels.Count; i++)
                                    {
                                        <tr>
                                            <td>@memberGrowthLabels[i]</td>
                                            <td class="text-right">@memberGrowthData[i]</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="empty-summary">No new member records for the last 6 months.</div>
                        }
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-12">
                    <div class="chart-card">
                        <h3>Membership Types Distribution</h3>
                        @if (membershipTypeNames.Any())
                        {
                            <!-- Chart.js Bar Chart -->
                            <div class="chart-container" style="position: relative; height: 300px; margin-bottom: 20px;">
                                <canvas id="membershipTypesChart"></canvas>
                    </div>
                            <table class="summary-table">
                                <thead>
                                    <tr>
                                        <th>Membership Type</th>
                                        <th class="text-right">Members</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < membershipTypeNames.Count; i++)
                                    {
                                        <tr>
                                            <td>@membershipTypeNames[i]</td>
                                            <td class="text-right">@membershipTypeCounts[i]</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="empty-summary">No active members by membership type yet.</div>
                        }
                    </div>
                    </div>
                    </div>
                }
    </div>
</div>

<!-- Change Password Modal -->
@if (showPasswordModal)
{
    <div class="modal-overlay" @onclick="ClosePasswordModal">
        <div class="modal-card" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Change Password</h2>
            </div>
            <div class="modal-body">
                <p>Change password for: <strong>@currentUsername</strong></p>
                @if (!string.IsNullOrEmpty(passwordModalError))
                {
                    <div class="account-error">@passwordModalError</div>
                }
                <div class="form-group">
                    <label class="required">New Password</label>
                    <input type="password" class="form-control" @bind="passwordInput" placeholder="Enter new password" />
                </div>
                <div class="form-group">
                    <label class="required">Confirm Password</label>
                    <input type="password" class="form-control" @bind="passwordConfirm" placeholder="Confirm new password" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="ClosePasswordModal">Cancel</button>
                <button class="btn-primary" @onclick="SavePasswordChange" disabled="@isSavingPassword">
                    @(isSavingPassword ? "Saving..." : "Update Password")
                </button>
            </div>
        </div>
    </div>
}


<style>
    .container-fluid {
        width: 100%;
        margin: 0;
        padding: 0;
    }

    .dashboard-page {
        max-width: 100%;
        padding: 30px;
        margin: 0 auto;
        position: relative;
        background: #ffffff;
        min-height: 100vh;
    }

    /* Header */
    .dashboard-header {
        background: white;
        padding: 25px 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
    }

    .header-text {
        flex: 1;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        padding: 16px;
        border-radius: 16px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        min-width: 100px;
        transition: all 0.3s ease;
    }

    .user-badge:hover {
        background: #e9ecef;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }

    .user-badge.clickable {
        cursor: pointer;
    }

    .user-badge.clickable:hover {
        background: #e3f2fd;
        border-color: #3498DB;
    }

    .user-circle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #234060;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .user-role-text {
        font-size: 0.85rem;
        color: #234060;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    /* Statistics Grid */
    .row.g-3 {
        margin: 30px 0;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        height: 100%;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
        gap: 10px;
    }

    .role-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Role-specific border colors */
        .role-card[data-role="admin"] {
            border-left: 4px solid #234060;
        }

        .role-card[data-role="trainer"] {
            border-left: 4px solid #27ae60;
        }

        /* Staff uses the same navy accent as admin for consistent card color */
        .role-card[data-role="staff"] {
            border-left: 4px solid #234060;
        }

        .stat-card h3 {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            text-align: left;
            white-space: nowrap;
            flex-shrink: 0;
        }

    .stat-number {
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
        color: #234060;
        text-align: right;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .stat-number.single-digit {
        text-align: right;
        display: block;
    }

    .stat-note {
        margin-top: 8px;
        font-size: 0.85rem;
        color: #6c757d;
        text-align: center;
    }

    /* Revenue card specific styles - number below text */
    .revenue-card .revenue-header {
        margin-bottom: 8px;
    }

    .revenue-card .revenue-number {
        text-align: center;
        margin-bottom: 8px;
    }

    .revenue-card .stat-note {
        margin-top: 8px;
    }

    .stat-alert {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 8px;
        font-weight: 600;
    }

        .stat-alert.positive {
            background: #d4edda;
            color: #155724;
        }

        .stat-alert.warning {
            background: #fff3cd;
            color: #856404;
        }

        .stat-alert.info {
            background: #d1ecf1;
            color: #0c5460;
        }

    /* Recent Activity */
    .recent-activity {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-top: 30px;
    }

    .recent-activity.quick-actions-sidebar {
        margin-top: 0;
        padding: 20px;
        height: 100%;
    }

        .recent-activity h2 {
            margin: 0 0 20px 0;
            color: #234060;
            border-bottom: 2px solid #f0f4f8;
            padding-bottom: 10px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .quick-actions-sidebar h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
        }

    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .quick-actions-sidebar .activity-list {
        gap: 10px;
    }

    .activity-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        background: #f8fafc;
        border-radius: 6px;
        transition: background-color 0.2s ease;
    }

    .quick-actions-sidebar .activity-item {
        padding: 8px 12px;
    }

    .role-action {
        cursor: pointer;
        transition: all 0.2s ease;
    }

        .role-action:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        /* Role-specific action colors */
        .role-action[data-role="admin"] {
            border-left: 3px solid #234060;
        }

        .role-action[data-role="trainer"] {
            border-left: 3px solid #27ae60;
        }

        .role-action[data-role="staff"] {
            border-left: 3px solid #3498db;
        }

    .activity-badge {
        background: #234060;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-right: 15px;
        font-family: monospace;
        font-weight: 500;
        min-width: 60px;
        text-align: center;
    }

    .quick-actions-sidebar .activity-badge {
        font-size: 0.7rem;
        padding: 3px 6px;
        min-width: 50px;
        margin-right: 10px;
    }

    .activity-text {
        color: #333;
        font-weight: 500;
        font-size: 0.95rem;
    }

    .quick-actions-sidebar .activity-text {
        font-size: 0.85rem;
    }

    /* Password Change Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        padding: 20px;
    }

    .modal-card {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 420px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        animation: fadeIn 0.2s ease;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #234060;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .modal-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 6px;
        color: #333;
    }

    .form-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-group input:focus {
        outline: none;
        border-color: #234060;
        box-shadow: 0 0 0 3px rgba(35, 64, 96, 0.1);
    }

    .modal-error {
        background: #fdecea;
        color: #b0382f;
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 12px;
        font-size: 14px;
    }

    .close-btn {
        background: transparent;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #333;
    }

    .modal-subtitle {
        color: #666;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 14px;
    }

    .btn-primary {
        background: #234060;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-primary:hover:not([disabled]) {
        background: #1a3450;
        transform: translateY(-1px);
    }

    .btn-primary[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #f1f3f7;
        color: #234060;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-secondary:hover {
        background: #e0e4e9;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Chart Cards / Summary Panels */
    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        height: 100%;
        min-height: 350px;
    }

    .chart-card h3 {
        margin: 0 0 20px 0;
        color: #234060;
        font-size: 1.1rem;
        font-weight: 600;
        border-bottom: 2px solid #f0f4f8;
        padding-bottom: 10px;
    }

    .summary-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .summary-table th,
    .summary-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #eef2f7;
    }

    .summary-table th {
        text-align: left;
        color: #6c757d;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-table td.text-right {
        text-align: right;
        font-weight: 600;
        color: #234060;
    }

    .empty-summary {
        font-size: 0.9rem;
        color: #999;
        font-style: italic;
    }

    /* CSS-based Charts */
    .css-chart-container {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    /* Line Chart Styles */
    .line-chart {
        position: relative;
        height: 200px;
        width: 100%;
        margin-bottom: 40px;
        padding-bottom: 30px;
    }

    .line-chart-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }

    .line-chart-labels {
        position: relative;
        width: 100%;
        height: 100%;
        z-index: 2;
    }

    .line-chart-point {
        position: absolute;
        transform: translateX(-50%);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .line-chart-point:hover {
        transform: translateX(-50%) scale(1.2);
    }

    .line-chart-point:hover .point-value {
        display: block;
    }

    .point-dot {
        width: 8px;
        height: 8px;
        background: #1a365d;
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        margin: 0 auto;
    }

    .point-value {
        display: none;
        position: absolute;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        background: #1a365d;
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        text-align: center;
        min-width: 80px;
    }

    .point-date {
        font-size: 10px;
        opacity: 0.9;
        margin-bottom: 2px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding-bottom: 2px;
    }

    .point-amount {
        font-size: 12px;
    }

    .point-value::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: #1a365d;
    }

    /* X-axis date labels */
    .line-chart-xaxis {
        position: absolute;
        bottom: -25px;
        left: 0;
        right: 0;
        height: 20px;
        display: flex;
        justify-content: space-between;
    }

    .xaxis-label {
        position: absolute;
        transform: translateX(-50%);
        font-size: 11px;
        color: #666;
        font-weight: 500;
        white-space: nowrap;
    }

    /* Bar Chart Styles */
    .bar-chart {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .bar-chart-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .bar-label {
        min-width: 120px;
        font-size: 13px;
        font-weight: 600;
        color: #333;
    }

    .bar-label-small {
        min-width: 80px;
        font-size: 12px;
        font-weight: 500;
        color: #666;
    }

    .bar-wrapper {
        flex: 1;
        height: 28px;
        background: #e5e7eb;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
    }

    .bar-fill {
        height: 100%;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 8px;
        transition: width 0.6s ease;
        min-width: 30px;
    }

    .bar-value {
        color: white;
        font-size: 12px;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* Vertical Bar Chart Styles */
    .vertical-bar-chart {
        width: 100%;
        padding: 15px 0;
    }

    .vertical-bars-wrapper {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        gap: 15px;
        height: 200px;
        padding: 0 10px;
    }

    .vertical-bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        max-width: 80px;
    }

    .vertical-bar-wrapper {
        flex: 1;
        width: 100%;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        position: relative;
        min-height: 150px;
    }

    .vertical-bar-fill {
        width: 100%;
        min-height: 20px;
        border-radius: 4px 4px 0 0;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 8px;
        position: relative;
        transition: height 0.6s ease;
    }

    .vertical-bar-value {
        color: white;
        font-size: 12px;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .vertical-bar-label {
        margin-top: 8px;
        font-size: 12px;
        font-weight: 500;
        color: #666;
        text-align: center;
        word-break: break-word;
    }

    /* Data tables styling - clean presentation */
    .chart-card .summary-table {
        margin-top: 20px;
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .header-content {
            flex-direction: column;
            gap: 15px;
        }

        .header-actions {
            width: 100%;
            justify-content: space-between;
        }

        .modal-card {
            max-width: 95%;
        }
    }

    /* Password Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        padding: 20px;
        box-sizing: border-box;
    }

    .modal-card {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 420px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        animation: fadeIn 0.2s ease;
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 22px;
        color: #333;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        flex-shrink: 0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 8px;
        color: #333;
    }

    .required::after {
        content: " *";
        color: #e74c3c;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #234060;
        box-shadow: 0 0 0 3px rgba(35, 64, 96, 0.1);
    }

    .account-error {
        background: #fdecea;
        color: #b0382f;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
    }

    .btn-secondary {
        background: #f1f3f7;
        color: #234060;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-secondary:hover {
        background: #e0e4e8;
    }

    .btn-primary {
        background: #3498DB;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-primary:hover:not([disabled]) {
        background: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .btn-primary[disabled] {
        opacity: 0.7;
        cursor: not-allowed;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

@code {
    private string currentUsername = "";
    private string currentUserRole = "";
    private int? currentUserId = null;
    private int totalActiveMembers = 0;
    private int todaysCheckIns = 0;
    private decimal totalRevenue = 0;
    private decimal todaysRevenue = 0;
    private int totalTrainers = 0;

    // Password modal variables
    private bool showPasswordModal = false;
    private string passwordInput = "";
    private string passwordConfirm = "";
    private string passwordModalError = "";
    private bool isSavingPassword = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is authenticated
        if (!await AuthService.IsUserAuthenticated())
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        // Get current user info
        currentUserRole = await AuthService.GetCurrentUserRole();
        currentUsername = await AuthService.GetCurrentUsername();
        currentUserId = await AuthService.GetCurrentUserId();

        Console.WriteLine($"User {currentUsername} with role {currentUserRole} logged in");

        // Load both metrics and chart data together to ensure consistency
        await LoadDashboardMetrics();
        
        // Load chart data for admin users immediately (not just on first render)
        if (currentUserRole?.ToLower() == "admin")
        {
            await LoadChartData();
            // Chart will be initialized in OnAfterRenderAsync
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when navigating back to the dashboard
        if (await AuthService.IsUserAuthenticated())
        {
            await LoadDashboardMetrics();
            
            // Reload chart data for admin users
            if (currentUserRole?.ToLower() == "admin")
            {
                await LoadChartData();
                // Reinitialize charts after data is loaded
                await Task.Delay(100);
                if (revenueLabels.Any() && revenueData.Any())
                {
                    await InitializeRevenueChart();
                }
                if (checkinsLabels.Any() && checkinsData.Any())
                {
                    await InitializeCheckinsChart();
                }
                if (memberGrowthLabels.Any() && memberGrowthData.Any())
                {
                    await InitializeMemberGrowthChart();
                }
                if (membershipTypeNames.Any() && membershipTypeCounts.Any())
                {
                    await InitializeMembershipTypesChart();
                }
            }
        }
    }

    private string GetDashboardTitle()
    {
        return currentUserRole?.ToLower() switch
        {
            "admin" => "Admin",
            "trainer" => "Trainer",
            "staff" => "Staff",
            _ => "Dashboard"
        };
    }

    private string GetDashboardDescription()
    {
        return currentUserRole?.ToLower() switch
        {
            "admin" => "Full system access and management",
            "trainer" => "Manage your assigned members",
            "staff" => "Front desk operations",
            _ => "General dashboard access"
        };
    }

    private string GetRoleColor()
    {
        return currentUserRole?.ToLower() switch
        {
            "admin" => "#e74c3c",
            "trainer" => "#27ae60",
            "staff" => "#3498db",
            _ => "#234060"
        };
    }

    // Navigation methods
    private void NavigateToMembers() => NavigationManager.NavigateTo("/members");
    private void NavigateToAttendance() => NavigationManager.NavigateTo("/attendance");
    private void NavigateToPayments() => NavigationManager.NavigateTo("/payment");
    private void NavigateToFinancialReport() => NavigationManager.NavigateTo("/reports/financial");
    private void NavigateToWalkIns() => NavigationManager.NavigateTo("/walkins");
    private void NavigateToTrainers() => NavigationManager.NavigateTo("/trainers");
    private void NavigateToPromotions() => NavigationManager.NavigateTo("/promotions");
    private void NavigateToMembershipTypes() => NavigationManager.NavigateTo("/membershiptype");
    private void NavigateToSettings() => NavigationManager.NavigateTo("/settings");

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Initialize Chart.js charts after render
        if (currentUserRole?.ToLower() == "admin")
        {
            // Wait a bit longer for canvas to be in DOM
            await Task.Delay(800);
            
            if (revenueLabels.Any() && revenueData.Any())
            {
                await InitializeRevenueChart();
            }
            
            if (checkinsLabels.Any() && checkinsData.Any())
            {
                await InitializeCheckinsChart();
            }
            
            if (memberGrowthLabels.Any() && memberGrowthData.Any())
            {
                await InitializeMemberGrowthChart();
            }
            
            if (membershipTypeNames.Any() && membershipTypeCounts.Any())
            {
                await InitializeMembershipTypesChart();
            }
        }
    }

    private async Task InitializeRevenueChart()
    {
        try
        {
            Console.WriteLine($"Initializing revenue chart - Labels: {revenueLabels.Count}, Data: {revenueData.Count}");
            
            // Check if canvas exists
            var canvasExists = await JSRuntime.InvokeAsync<bool>("eval", 
                "document.getElementById('revenueChart') !== null");
            Console.WriteLine($"Canvas element exists: {canvasExists}");
            
            if (!canvasExists)
            {
                Console.WriteLine("Canvas not found, waiting and retrying...");
                await Task.Delay(500);
                canvasExists = await JSRuntime.InvokeAsync<bool>("eval", 
                    "document.getElementById('revenueChart') !== null");
                Console.WriteLine($"Canvas element exists after retry: {canvasExists}");
            }
            
            // Check if Chart.js is available
            var chartJsAvailable = await JSRuntime.InvokeAsync<bool>("eval", 
                "typeof window.Chart !== 'undefined' || typeof Chart !== 'undefined'");
            Console.WriteLine($"Chart.js available: {chartJsAvailable}");
            
            if (!chartJsAvailable)
            {
                Console.WriteLine("Chart.js not available, waiting...");
                await Task.Delay(1000);
                chartJsAvailable = await JSRuntime.InvokeAsync<bool>("eval", 
                    "typeof window.Chart !== 'undefined' || typeof Chart !== 'undefined'");
                Console.WriteLine($"Chart.js available after wait: {chartJsAvailable}");
            }
            
            // Use the existing JavaScript helper function
            // Check if dashboardCharts exists
            var dashboardChartsExists = await JSRuntime.InvokeAsync<bool>("eval", 
                "typeof window.dashboardCharts !== 'undefined' && typeof window.dashboardCharts.initRevenue === 'function'");
            Console.WriteLine($"dashboardCharts.initRevenue function exists: {dashboardChartsExists}");
            
            if (!dashboardChartsExists)
            {
                Console.WriteLine("dashboardCharts not found, trying direct Chart.js initialization...");
                // Try direct Chart.js initialization as fallback
                await InitializeChartDirectly();
                return;
            }
            
            if (revenueLabels.Any() && revenueData.Any())
            {
                var labelsArray = revenueLabels.ToArray();
                var dataArray = revenueData.Select(d => (double)d).ToArray();
                
                Console.WriteLine($"Calling dashboardCharts.initRevenue with {labelsArray.Length} labels");
                await JSRuntime.InvokeVoidAsync("dashboardCharts.initRevenue", labelsArray, dataArray);
                Console.WriteLine("Revenue chart initialization call completed");
            }
            else
            {
                Console.WriteLine("No data available for chart");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing revenue chart: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            // Try fallback direct initialization
            try
            {
                await InitializeChartDirectly();
            }
            catch (Exception ex2)
            {
                Console.WriteLine($"Fallback initialization also failed: {ex2.Message}");
            }
        }
    }

    private async Task InitializeChartDirectly()
    {
        try
        {
            var labelsJson = System.Text.Json.JsonSerializer.Serialize(revenueLabels);
            var dataJson = System.Text.Json.JsonSerializer.Serialize(revenueData.Select(d => (double)d).ToArray());

            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    const ctx = document.getElementById('revenueChart');
                    if (!ctx) {{
                        console.error('Canvas revenueChart not found');
                        return;
                    }}
                    
                    if (window.revenueChartInstance) {{
                        try {{
                            window.revenueChartInstance.destroy();
                        }} catch(e) {{
                            console.log('Error destroying chart:', e);
                        }}
                    }}
                    
                    const ChartConstructor = window.Chart || Chart;
                    if (!ChartConstructor) {{
                        console.error('Chart.js not available');
                        return;
                    }}
                    
                    const labels = {labelsJson};
                    const data = {dataJson};
                    
                    try {{
                        window.revenueChartInstance = new ChartConstructor(ctx, {{
                            type: 'line',
                            data: {{
                                labels: labels,
                                datasets: [{{
                                    label: 'Revenue',
                                    data: data,
                                    borderColor: '#234060',
                                    backgroundColor: 'rgba(35, 64, 96, 0.15)',
                                    borderWidth: 2.5,
                                    fill: true,
                                    tension: 0.3,
                                    pointRadius: 4,
                                    pointBackgroundColor: '#234060',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2
                                }}]
                            }},
                            options: {{
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {{
                                    legend: {{
                                        display: false
                                    }},
                                    tooltip: {{
                                        callbacks: {{
                                            label: function(context) {{
                                                return '₱' + context.parsed.y.toLocaleString('en-US', {{minimumFractionDigits: 2, maximumFractionDigits: 2}});
                                            }}
                                        }}
                                    }}
                                }},
                                scales: {{
                                    y: {{
                                        beginAtZero: true,
                                        ticks: {{
                                            callback: function(value) {{
                                                return '₱' + value.toLocaleString('en-US');
                                            }}
                                        }}
                                    }}
                                }}
                            }}
                        }});
                        console.log('Revenue chart created successfully');
                    }} catch(e) {{
                        console.error('Error creating chart:', e);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in direct chart initialization: {ex.Message}");
        }
    }

    private async Task InitializeCheckinsChart()
    {
        try
        {
            Console.WriteLine($"Initializing checkins chart - Labels: {checkinsLabels.Count}, Data: {checkinsData.Count}");
            await Task.Delay(200);
            
            var labelsJson = System.Text.Json.JsonSerializer.Serialize(checkinsLabels);
            var dataJson = System.Text.Json.JsonSerializer.Serialize(checkinsData.ToArray());

            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    const ctx = document.getElementById('checkinsChart');
                    if (!ctx) {{
                        console.error('Canvas checkinsChart not found');
                        return;
                    }}
                    
                    if (window.checkinsChartInstance) {{
                        try {{
                            window.checkinsChartInstance.destroy();
                        }} catch(e) {{
                            console.log('Error destroying chart:', e);
                        }}
                    }}
                    
                    const ChartConstructor = window.Chart || Chart;
                    if (!ChartConstructor) {{
                        console.error('Chart.js not available');
                        return;
                    }}
                    
                    const labels = {labelsJson};
                    const data = {dataJson};
                    
                    try {{
                        window.checkinsChartInstance = new ChartConstructor(ctx, {{
                            type: 'bar',
                            data: {{
                                labels: labels,
                                datasets: [{{
                                    label: 'Check-ins',
                                    data: data,
                                    backgroundColor: '#1a365d',
                                    borderColor: '#1a365d',
                                    borderWidth: 1
                                }}]
                            }},
                            options: {{
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {{
                                    legend: {{
                                        display: false
                                    }}
                                }},
                                scales: {{
                                    y: {{
                                        beginAtZero: true,
                                        ticks: {{
                                            precision: 0
                                        }}
                                    }}
                                }}
                            }}
                        }});
                        console.log('Check-ins chart created successfully');
                    }} catch(e) {{
                        console.error('Error creating check-ins chart:', e);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing checkins chart: {ex.Message}");
        }
    }

    private async Task InitializeMemberGrowthChart()
    {
        try
        {
            Console.WriteLine($"Initializing member growth chart - Labels: {memberGrowthLabels.Count}, Data: {memberGrowthData.Count}");
            await Task.Delay(200);
            
            var labelsJson = System.Text.Json.JsonSerializer.Serialize(memberGrowthLabels);
            var dataJson = System.Text.Json.JsonSerializer.Serialize(memberGrowthData.ToArray());

            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    const ctx = document.getElementById('memberGrowthChart');
                    if (!ctx) {{
                        console.error('Canvas memberGrowthChart not found');
                        return;
                    }}
                    
                    if (window.memberGrowthChartInstance) {{
                        try {{
                            window.memberGrowthChartInstance.destroy();
                        }} catch(e) {{
                            console.log('Error destroying chart:', e);
                        }}
                    }}
                    
                    const ChartConstructor = window.Chart || Chart;
                    if (!ChartConstructor) {{
                        console.error('Chart.js not available');
                        return;
                    }}
                    
                    const labels = {labelsJson};
                    const data = {dataJson};
                    
                    try {{
                        window.memberGrowthChartInstance = new ChartConstructor(ctx, {{
                            type: 'bar',
                            data: {{
                                labels: labels,
                                datasets: [{{
                                    label: 'New Members',
                                    data: data,
                                    backgroundColor: '#1a365d',
                                    borderColor: '#1a365d',
                                    borderWidth: 1
                                }}]
                            }},
                            options: {{
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {{
                                    legend: {{
                                        display: false
                                    }}
                                }},
                                scales: {{
                                    y: {{
                                        beginAtZero: true,
                                        ticks: {{
                                            precision: 0
                                        }}
                                    }}
                                }}
                            }}
                        }});
                        console.log('Member growth chart created successfully');
                    }} catch(e) {{
                        console.error('Error creating member growth chart:', e);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing member growth chart: {ex.Message}");
        }
    }

    private async Task InitializeMembershipTypesChart()
    {
        try
        {
            Console.WriteLine($"Initializing membership types chart - Labels: {membershipTypeNames.Count}, Data: {membershipTypeCounts.Count}");
            await Task.Delay(200);
            
            var labelsJson = System.Text.Json.JsonSerializer.Serialize(membershipTypeNames);
            var dataJson = System.Text.Json.JsonSerializer.Serialize(membershipTypeCounts.ToArray());

            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    const ctx = document.getElementById('membershipTypesChart');
                    if (!ctx) {{
                        console.error('Canvas membershipTypesChart not found');
                        return;
                    }}
                    
                    if (window.membershipTypesChartInstance) {{
                        try {{
                            window.membershipTypesChartInstance.destroy();
                        }} catch(e) {{
                            console.log('Error destroying chart:', e);
                        }}
                    }}
                    
                    const ChartConstructor = window.Chart || Chart;
                    if (!ChartConstructor) {{
                        console.error('Chart.js not available');
                        return;
                    }}
                    
                    const labels = {labelsJson};
                    const data = {dataJson};
                    
                    try {{
                        window.membershipTypesChartInstance = new ChartConstructor(ctx, {{
                            type: 'bar',
                            data: {{
                                labels: labels,
                                datasets: [{{
                                    label: 'Members',
                                    data: data,
                                    backgroundColor: '#1a365d',
                                    borderColor: '#1a365d',
                                    borderWidth: 1
                                }}]
                            }},
                            options: {{
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {{
                                    legend: {{
                                        display: false
                                    }}
                                }},
                                scales: {{
                                    y: {{
                                        beginAtZero: true,
                                        ticks: {{
                                            precision: 0
                                        }}
                                    }}
                                }}
                            }}
                        }});
                        console.log('Membership types chart created successfully');
                    }} catch(e) {{
                        console.error('Error creating membership types chart:', e);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing membership types chart: {ex.Message}");
        }
    }

    private async Task LoadDashboardMetrics()
    {
        try
        {
            // Load active members count
            // Active = not archived AND not expired (or no expiration date)
            var today = DateTime.Today;
            totalActiveMembers = await Context.Members
                .CountAsync(m =>
                    !m.IsArchived &&
                    (!m.ExpirationDate.HasValue || m.ExpirationDate.Value.Date >= today));

            // Load today's check-ins
            var tomorrow = today.AddDays(1);

            todaysCheckIns = await Context.Attendances
                .CountAsync(a => a.CheckinTime >= today && a.CheckinTime < tomorrow);

            // Load this month's revenue from both Payments and WalkIns
            var monthStart = new DateTime(today.Year, today.Month, 1);
            var monthEnd = monthStart.AddMonths(1);
            
            var monthPaymentsRevenue = await Context.Payments
                .Where(p => p.PaymentDate >= monthStart && p.PaymentDate < monthEnd)
                .SumAsync(p => (decimal?)p.Amount) ?? 0;

            var monthWalkinsRevenue = await Context.WalkIns
                .Where(w => w.VisitDate >= monthStart && w.VisitDate < monthEnd && !w.IsArchived)
                .SumAsync(w => (decimal?)w.PaymentAmount) ?? 0;

            totalRevenue = monthPaymentsRevenue + monthWalkinsRevenue;

            // Load today's revenue from both Payments and WalkIns
            var paymentsRevenue = await Context.Payments
                .Where(p => p.PaymentDate >= today && p.PaymentDate < tomorrow)
                .SumAsync(p => (decimal?)p.Amount) ?? 0;

            var walkinsRevenue = await Context.WalkIns
                .Where(w => w.VisitDate >= today && w.VisitDate < tomorrow && !w.IsArchived)
                .SumAsync(w => (decimal?)w.PaymentAmount) ?? 0;

            todaysRevenue = paymentsRevenue + walkinsRevenue;

            // Load total trainers count
            totalTrainers = await Context.Trainers
                .CountAsync();
            
            Console.WriteLine($"Dashboard metrics loaded - Members: {totalActiveMembers}, CheckIns: {todaysCheckIns}, Revenue: {totalRevenue}, Today: {todaysRevenue}, Trainers: {totalTrainers}");
            
            // Force UI update
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard metrics error: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            // Set defaults if there's an error
            totalActiveMembers = 0;
            todaysCheckIns = 0;
            totalRevenue = 0;
            todaysRevenue = 0;
            totalTrainers = 0;
            StateHasChanged();
        }
    }

    private string GetStatNumberClass(int value)
    {
        // Check if value is a single digit (0-9)
        return (value >= 0 && value <= 9) ? "single-digit" : "";
    }

    private string GetStatNumberClass(decimal value)
    {
        // For decimal values, check if the integer part is a single digit (0-9)
        // Also check if the value is less than 10 (before formatting)
        int intValue = (int)Math.Floor(value);
        return (intValue >= 0 && intValue <= 9) ? "single-digit" : "";
    }

    private string FormatRevenue(decimal amount)
    {
        // If amount is 0, display just "0" without peso sign or decimals
        if (amount == 0)
        {
            return "0";
        }
        // Otherwise, display with peso sign and 2 decimal places
        return $"₱{amount.ToString("N2")}";
    }


    // Chart data variables
    private List<decimal> revenueData = new();
    private List<string> revenueLabels = new();
    private List<int> checkinsData = new();
    private List<string> checkinsLabels = new();
    private List<int> memberGrowthData = new();
    private List<string> memberGrowthLabels = new();
    private List<int> membershipTypeCounts = new();
    private List<string> membershipTypeNames = new();

    // === Chart data for summaries (used for tables and line graphs) ===
    private async Task LoadChartData()
    {
        try
        {
            var today = DateTime.Today;
            
            // Load revenue data for last 7 days (same logic as LoadDashboardMetrics)
            revenueData.Clear();
            revenueLabels.Clear();
            for (int i = 6; i >= 0; i--)
            {
                var date = today.AddDays(-i);
                var nextDate = date.AddDays(1);
                
                var dayPayments = await Context.Payments
                    .Where(p => p.PaymentDate >= date && p.PaymentDate < nextDate)
                    .SumAsync(p => (decimal?)p.Amount) ?? 0;
                
                var dayWalkins = await Context.WalkIns
                    .Where(w => w.VisitDate >= date && w.VisitDate < nextDate && !w.IsArchived)
                    .SumAsync(w => (decimal?)w.PaymentAmount) ?? 0;
                
                revenueData.Add(dayPayments + dayWalkins);
                revenueLabels.Add(date.ToString("MMM dd"));
            }
            
            Console.WriteLine($"Chart data loaded - Revenue labels: {revenueLabels.Count}, Revenue data points: {revenueData.Count}");

            // Load check-ins data for last 7 days
            checkinsData.Clear();
            checkinsLabels.Clear();
            for (int i = 6; i >= 0; i--)
            {
                var date = today.AddDays(-i);
                var nextDate = date.AddDays(1);
                
                var count = await Context.Attendances
                    .CountAsync(a => a.CheckinTime >= date && a.CheckinTime < nextDate);
                
                checkinsData.Add(count);
                checkinsLabels.Add(date.ToString("MMM dd"));
            }

            // Load member growth for last 6 months
            memberGrowthData.Clear();
            memberGrowthLabels.Clear();
            for (int i = 5; i >= 0; i--)
            {
                var monthStart = new DateTime(today.Year, today.Month, 1).AddMonths(-i);
                var monthEnd = monthStart.AddMonths(1);
                
                var count = await Context.Members
                    .CountAsync(m => m.JoinDate >= monthStart && m.JoinDate < monthEnd && !m.IsArchived);
                
                memberGrowthData.Add(count);
                memberGrowthLabels.Add(monthStart.ToString("MMM yyyy"));
            }

            // Load membership type distribution
            membershipTypeCounts.Clear();
            membershipTypeNames.Clear();
            var membershipTypes = await Context.MembershipTypes
                .Where(mt => !mt.IsArchived)
                .ToListAsync();
            
            foreach (var mt in membershipTypes)
            {
                var count = await Context.Members
                    .CountAsync(m => m.MembershipTypeID == mt.MembershipTypeID && !m.IsArchived);
                
                if (count > 0)
                {
                    membershipTypeCounts.Add(count);
                    membershipTypeNames.Add(mt.TypeName);
                }
            }

            // Build chart points for revenue and check-ins (for SVG line graphs)
            BuildLinePoints(
                revenueData.Select(d => (double)d).ToList(),
                revenueLabels,
                revenueChartPoints,
                100,
                45);

            BuildLinePoints(
                checkinsData.Select(d => (double)d).ToList(),
                checkinsLabels,
                checkinsChartPoints,
                100,
                45);

            StateHasChanged();
            
            // Initialize charts after data is loaded and UI is updated
            // Wait longer for DOM to update and Chart.js to load
            await Task.Delay(1000);
            if (currentUserRole?.ToLower() == "admin")
            {
                if (revenueLabels.Any() && revenueData.Any())
                {
                    await InitializeRevenueChart();
                }
                
                if (checkinsLabels.Any() && checkinsData.Any())
                {
                    await InitializeCheckinsChart();
                }
                
                if (memberGrowthLabels.Any() && memberGrowthData.Any())
                {
                    await InitializeMemberGrowthChart();
                }
                
                if (membershipTypeNames.Any() && membershipTypeCounts.Any())
                {
                    await InitializeMembershipTypesChart();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chart data: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            // Clear data on error to show empty state
            revenueData.Clear();
            revenueLabels.Clear();
            checkinsData.Clear();
            checkinsLabels.Clear();
            memberGrowthData.Clear();
            memberGrowthLabels.Clear();
            membershipTypeCounts.Clear();
            membershipTypeNames.Clear();
            StateHasChanged();
        }
    }

    // Helper method for line chart SVG points
    private string GetLineChartPoints(List<decimal> values)
    {
        if (values == null || values.Count == 0)
            return "";

        var max = values.Max();
        if (max <= 0) max = 1;

        var points = new List<string>();
        for (int i = 0; i < values.Count; i++)
        {
            var x = values.Count == 1 ? 0 : (i * 100.0 / (values.Count - 1));
            var normalized = (double)(values[i] / max);
            var y = 100 - (normalized * 90) - 5; // Leave 5% padding at bottom, 5% at top
            points.Add($"{x:F1},{y:F1}");
        }
        return string.Join(" ", points);
    }

    // Helper method for filled area under line chart
    private string GetLineChartAreaPoints(List<decimal> values)
    {
        if (values == null || values.Count == 0)
            return "";

        var max = values.Max();
        if (max <= 0) max = 1;

        var points = new List<string>();
        
        // Start at bottom left
        points.Add("0,100");
        
        // Add line points
        for (int i = 0; i < values.Count; i++)
        {
            var x = values.Count == 1 ? 0 : (i * 100.0 / (values.Count - 1));
            var normalized = (double)(values[i] / max);
            var y = 100 - (normalized * 90) - 5;
            points.Add($"{x:F1},{y:F1}");
        }
        
        // End at bottom right
        var lastX = values.Count == 1 ? 0 : 100;
        points.Add($"{lastX:F1},100");
        
        return string.Join(" ", points);
    }

    // Helper method for bar chart colors
    private string GetBarColor(int index)
    {
        // All bars use navy blue for clean UI
        return "#1a365d";
    }

    // === Inline SVG chart helpers (offline, no JS) ===
    private class ChartPoint
    {
        public double X { get; set; }
        public double Y { get; set; }
        public double Value { get; set; }
        public string Label { get; set; } = string.Empty;
    }

    private List<ChartPoint> revenueChartPoints = new();
    private List<ChartPoint> checkinsChartPoints = new();

    private void BuildLinePoints(
        List<double> values,
        List<string> labels,
        List<ChartPoint> target,
        double width,
        double height)
    {
        target.Clear();
        if (values == null || values.Count == 0)
            return;

        var max = values.Max();
        if (max <= 0)
            max = 1; // avoid divide-by-zero; keep line at bottom

        var stepX = values.Count == 1 ? 0 : width / (values.Count - 1);

        for (int i = 0; i < values.Count; i++)
        {
            var x = stepX * i;
            var normalized = values[i] / max;
            var y = height - (normalized * height) + 5; // padding from top
            if (y > height) y = height;

            var label = (labels != null && labels.Count > i) ? labels[i] : string.Empty;

            target.Add(new ChartPoint
            {
                X = x,
                Y = y,
                Value = values[i],
                Label = label
            });
        }
    }

    private async Task InitializeCharts()
    {
        await LoadChartData();
        
        Console.WriteLine($"Chart data loaded - Revenue: {revenueLabels.Count} labels, Checkins: {checkinsLabels.Count} labels");
        
        try
        {
            // Check if Chart.js is available
            var chartJsAvailable = await JSRuntime.InvokeAsync<bool>("isChartJsAvailable");
            
            if (!chartJsAvailable)
            {
                Console.WriteLine("WARNING: Chart.js is not loaded. Charts will not render.");
                Console.WriteLine("Please ensure wwwroot/js/chart.umd.min.js exists and is included in index.html");
                return;
            }
            
            Console.WriteLine("Chart.js is available, waiting for DOM...");
            
            // Wait longer for DOM to be fully ready
            await Task.Delay(500);
            
            Console.WriteLine("Initializing charts with data...");
            
            // Initialize charts using JavaScript interop
            await JSRuntime.InvokeVoidAsync("initializeDashboardCharts",
                revenueLabels.ToArray(),
                revenueData.Select(d => (double)d).ToArray(),
                checkinsLabels.ToArray(),
                checkinsData.ToArray(),
                memberGrowthLabels.ToArray(),
                memberGrowthData.ToArray(),
                membershipTypeNames.ToArray(),
                membershipTypeCounts.ToArray()
            );
            
            Console.WriteLine("Chart initialization call completed");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing charts: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    // Password Change Methods
    private void OpenPasswordModal()
    {
        passwordInput = "";
        passwordConfirm = "";
        passwordModalError = "";
        isSavingPassword = false;
        showPasswordModal = true;
        StateHasChanged();
    }

    private void ClosePasswordModal()
    {
        showPasswordModal = false;
        passwordInput = "";
        passwordConfirm = "";
        passwordModalError = "";
        isSavingPassword = false;
    }

    private async Task SavePasswordChange()
    {
        if (isSavingPassword || !currentUserId.HasValue)
            return;

        passwordModalError = "";

        if (string.IsNullOrWhiteSpace(passwordInput) || string.IsNullOrWhiteSpace(passwordConfirm))
        {
            passwordModalError = "Please enter and confirm the new password.";
            return;
        }

        if (passwordInput.Length < 4)
        {
            passwordModalError = "Password must be at least 4 characters.";
            return;
        }

        if (passwordInput != passwordConfirm)
        {
            passwordModalError = "Passwords do not match.";
            return;
        }

        isSavingPassword = true;
        StateHasChanged();

        try
        {
            var user = await Context.Users.FindAsync(currentUserId.Value);
            if (user == null)
            {
                passwordModalError = "User account not found.";
                ToastService.ShowError("User account not found.");
                return;
            }

            user.Password = passwordInput.Trim();
            user.LastPasswordChange = DateTime.Now;
            Context.Users.Update(user);
            await Context.SaveChangesAsync();
            
            await LogAuditAction("Password Changed", "User", user.UserID, user.Username, $"Password changed for account: {user.Username}");
            ToastService.ShowSuccess("Password updated successfully.");
            ClosePasswordModal();
        }
        catch (Exception ex)
        {
            passwordModalError = $"Error updating password: {ex.Message}";
            ToastService.ShowError($"Error updating password: {ex.Message}");
        }
        finally
        {
            isSavingPassword = false;
            StateHasChanged();
        }
    }

    private async Task LogAuditAction(string action, string entityType, int? entityID, string entityName, string description, string status = "Success", string errorMessage = "")
    {
        try
        {
            var auditLog = new AuditLog
            {
                Action = action,
                EntityType = entityType,
                EntityID = entityID,
                EntityName = entityName,
                PerformedBy = currentUsername ?? "",
                PerformedByUserID = currentUserId,
                Description = description,
                Timestamp = DateTime.Now,
                Status = status,
                ErrorMessage = errorMessage
            };

            Context.AuditLogs.Add(auditLog);
            await Context.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error logging audit action: {ex.Message}");
        }
    }
}