@page "/reports"
@layout MainLayout
@using project.Data
@using project.Models
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Context
@inject IJSRuntime JSRuntime

<div class="reports-page">
    <div class="reports-header">
        <h1>Marketing & Finance Integrated Reports</h1>
        <div class="date-filter">
            <label>Period:</label>
            <select @bind="selectedPeriod" @bind:after="OnPeriodChanged" class="period-select">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
                <option value="custom">Custom Range</option>
            </select>
            @if (selectedPeriod == "custom")
            {
                <input type="date" @bind="customStartDate" @bind:after="OnPeriodChanged" class="date-input" />
                <span>to</span>
                <input type="date" @bind="customEndDate" @bind:after="OnPeriodChanged" class="date-input" />
            }
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-message" id="loading-message">Loading reports...</div>
    }
    else
    {
        <div id="reports-content">
    <!-- Quick Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card income">
            <div class="stat-info">
                <h3>Total Income</h3>
                    <div class="stat-amount">₱@(totalIncome.ToString("N2"))</div>
                <div class="stat-breakdown">
                        <span>Members: ₱@(memberIncome.ToString("N2"))</span>
                        <span>Walk-ins: ₱@(walkinIncome.ToString("N2"))</span>
                </div>
            </div>
        </div>

        <div class="stat-card members">
            <div class="stat-info">
                    <h3>Active Members</h3>
                    <div class="stat-number">@activeMembers</div>
                <div class="stat-breakdown">
                        <span>New: @newMembers</span>
                        <span>Expiring: @expiringMembers</span>
                </div>
            </div>
        </div>

        <div class="stat-card attendance">
            <div class="stat-info">
                    <h3>Total Attendance</h3>
                    <div class="stat-number">@totalAttendance</div>
                <div class="stat-breakdown">
                        <span>Peak Day: @peakAttendanceDay</span>
                </div>
            </div>
        </div>

            <div class="stat-card clv">
            <div class="stat-info">
                    <h3>Avg. Lifetime Value</h3>
                    <div class="stat-amount">₱@(averageCLV.ToString("N2"))</div>
                <div class="stat-breakdown">
                        <span>Per Member</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Performance Overview -->
    <div class="reports-section">
        <div class="section-header">
            <h2>Business Performance Overview</h2>
        </div>
        <div class="performance-overview">
            <div class="performance-card">
                <div class="performance-header">
                    <h3>Revenue Movement</h3>
                    <span class="performance-indicator @(revenueDirection == "Growing" ? "success" : revenueDirection == "Declining" ? "danger" : "warning")">
                        @if (revenueDirection == "Growing")
                        {
                            <span>↑</span>
                        }
                        else if (revenueDirection == "Declining")
                        {
                            <span>↓</span>
                        }
                        else
                        {
                            <span>→</span>
                        }
                        @revenueDirection
                    </span>
                </div>
                <div class="performance-content">
                    <div class="performance-metric">
                        <span>Current Period:</span>
                        <span class="amount">₱@(currentPeriodRevenue.ToString("N2"))</span>
                    </div>
                    <div class="performance-metric">
                        <span>Previous Period:</span>
                        <span>₱@(previousPeriodRevenue.ToString("N2"))</span>
                    </div>
                    <div class="performance-metric">
                        <span>Change:</span>
                        <span class="@(revenueChangePercent >= 0 ? "success" : "danger")">
                            @(revenueChangePercent >= 0 ? "+" : "")@(revenueChangePercent.ToString("F1"))%
                        </span>
                    </div>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-header">
                    <h3>New Members</h3>
                    <span class="performance-indicator @(newMembersDirection == "Growing" ? "success" : newMembersDirection == "Declining" ? "danger" : "warning")">
                        @if (newMembersDirection == "Growing")
                        {
                            <span>↑</span>
                        }
                        else if (newMembersDirection == "Declining")
                        {
                            <span>↓</span>
                        }
                        else
                        {
                            <span>→</span>
                        }
                        @newMembersDirection
                    </span>
                </div>
                <div class="performance-content">
                    <div class="performance-metric">
                        <span>Current Period:</span>
                        <span class="amount">@currentPeriodNewMembers</span>
                    </div>
                    <div class="performance-metric">
                        <span>Previous Period:</span>
                        <span>@previousPeriodNewMembers</span>
                    </div>
                    <div class="performance-metric">
                        <span>Change:</span>
                        <span class="@(newMembersChangePercent >= 0 ? "success" : "danger")">
                            @(newMembersChangePercent >= 0 ? "+" : "")@(newMembersChangePercent.ToString("F1"))%
                        </span>
                    </div>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-header">
                    <h3>Attendance Trends</h3>
                    <span class="performance-indicator @(attendanceDirection == "Growing" ? "success" : attendanceDirection == "Declining" ? "danger" : "warning")">
                        @if (attendanceDirection == "Growing")
                        {
                            <span>↑</span>
                        }
                        else if (attendanceDirection == "Declining")
                        {
                            <span>↓</span>
                        }
                        else
                        {
                            <span>→</span>
                        }
                        @attendanceDirection
                    </span>
                </div>
                <div class="performance-content">
                    <div class="performance-metric">
                        <span>Current Period:</span>
                        <span class="amount">@currentPeriodAttendance</span>
                    </div>
                    <div class="performance-metric">
                        <span>Previous Period:</span>
                        <span>@previousPeriodAttendance</span>
                    </div>
                    <div class="performance-metric">
                        <span>Change:</span>
                        <span class="@(attendanceChangePercent >= 0 ? "success" : "danger")">
                            @(attendanceChangePercent >= 0 ? "+" : "")@(attendanceChangePercent.ToString("F1"))%
                        </span>
                    </div>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-header">
                    <h3>Renewal Activity</h3>
                    <span class="performance-indicator @(renewalDirection == "Growing" ? "success" : renewalDirection == "Declining" ? "danger" : "warning")">
                        @if (renewalDirection == "Growing")
                        {
                            <span>↑</span>
                        }
                        else if (renewalDirection == "Declining")
                        {
                            <span>↓</span>
                        }
                        else
                        {
                            <span>→</span>
                        }
                        @renewalDirection
                    </span>
                </div>
                <div class="performance-content">
                    <div class="performance-metric">
                        <span>Renewal Rate:</span>
                        <span class="amount">@(renewalRate.ToString("F1"))%</span>
                    </div>
                    <div class="performance-metric">
                        <span>Churn Rate:</span>
                        <span class="@(churnRate < 10 ? "success" : churnRate < 20 ? "warning" : "danger")">@(churnRate.ToString("F1"))%</span>
                    </div>
                    <div class="performance-metric">
                        <span>Overall Status:</span>
                        <span class="@(overallPerformance == "Improving" ? "success" : overallPerformance == "Dropping" ? "danger" : "warning")">@overallPerformance</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Reports Section -->
    <div class="reports-section">
        <div class="section-header">
            <h2>Detailed Reports</h2>
            <div class="export-buttons">
                <button class="export-btn" @onclick="ExportToPDF" title="Export to PDF">
                    <span>📄</span> Export PDF
                </button>
                <button class="export-btn print-btn" @onclick="PrintReports" title="Print Reports">
                    <span>🖨️</span> Print
                </button>
            </div>
        </div>

        <div class="reports-grid">
                <!-- Report 1: Revenue by Payment Method -->
            <div class="report-card">
                    <h3> Revenue by Payment Method</h3>
                <div class="report-content">
                    <div class="report-item">
                            <span>Cash:</span>
                            <span class="amount">₱@(cashRevenue.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Ewallet:</span>
                            <span class="amount">₱@(ewalletRevenue.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Total:</span>
                            <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Cash %:</span>
                            <span>@(cashPercentage.ToString("F1"))%</span>
                        </div>
                        <div class="report-item">
                            <span>Ewallet %:</span>
                            <span>@(ewalletPercentage.ToString("F1"))%</span>
                        </div>
                    </div>
                </div>

                <!-- Report 2: Revenue by Membership Type -->
                <div class="report-card">
                    <h3> Revenue by Membership Type</h3>
                    <div class="report-content">
                        @foreach (var mt in revenueByMembershipType)
                        {
                            <div class="report-item">
                                <span>@mt.TypeName:</span>
                                <span class="amount">₱@(mt.Revenue.ToString("N2"))</span>
                            </div>
                        }
                        <div class="report-item">
                            <span>Total:</span>
                            <span class="amount total">₱@(revenueByMembershipType.Sum(m => m.Revenue).ToString("N2"))</span>
                        </div>
                    </div>
                </div>

                <!-- Report 3: Revenue by Source -->
                <div class="report-card">
                    <h3> Revenue by Source</h3>
                    <div class="report-content">
                        <div class="report-item">
                            <span>Member Subscriptions:</span>
                            <span class="amount">₱@(memberIncome.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Walk-ins:</span>
                            <span class="amount">₱@(walkinIncome.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Total Revenue:</span>
                            <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Members %:</span>
                            <span>@(memberPercentage.ToString("F1"))%</span>
                    </div>
                    <div class="report-item">
                            <span>Walk-ins %:</span>
                            <span>@(walkinPercentage.ToString("F1"))%</span>
                        </div>
                    </div>
                </div>

                <!-- Report 4: Payment Collection Report -->
                <div class="report-card">
                    <h3> Payment Collection Report</h3>
                    <div class="report-content">
                        <div class="report-item">
                            <span>Collected:</span>
                            <span class="amount success">₱@(collectedPayments.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Pending:</span>
                            <span class="amount warning">₱@(pendingPayments.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Collection Rate:</span>
                            <span class="@(collectionRate >= 80 ? "success" : collectionRate >= 60 ? "warning" : "danger")">@(collectionRate.ToString("F1"))%</span>
                    </div>
                    <div class="report-item">
                            <span>Overdue:</span>
                            <span class="danger">@overdueCount members</span>
                        </div>
                    </div>
                </div>

                <!-- Total Revenue -->
                <div class="report-card">
                    <h3>Total Revenue</h3>
                    <div class="report-content">
                        <div class="report-item">
                            <span>Total Revenue:</span>
                            <span class="amount total">₱@(totalIncome.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Member Subscriptions:</span>
                            <span class="amount">₱@(memberIncome.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Walk-ins:</span>
                            <span class="amount">₱@(walkinIncome.ToString("N2"))</span>
                        </div>
                    </div>
                </div>

                <!-- Growth Trend Report -->
                <div class="report-card full-width">
                    <h3>Growth Trend Report</h3>
                    <div class="report-content">
                        <div class="growth-grid">
                            <div class="growth-item">
                                <div class="growth-label">Revenue Growth</div>
                                <div class="growth-value @(revenueGrowthPercent >= 0 ? "success" : "danger")">
                                    @(revenueGrowthPercent >= 0 ? "+" : "")@(revenueGrowthPercent.ToString("F1"))%
                                </div>
                                <div class="growth-detail">
                                    <span>Current: ₱@(currentPeriodRevenue.ToString("N2"))</span>
                                    <span>Previous: ₱@(previousPeriodRevenue.ToString("N2"))</span>
                                </div>
                            </div>
                            <div class="growth-item">
                                <div class="growth-label">Active Members Growth</div>
                                <div class="growth-value @(activeMembersGrowthPercent >= 0 ? "success" : "danger")">
                                    @(activeMembersGrowthPercent >= 0 ? "+" : "")@(activeMembersGrowthPercent.ToString("F1"))%
                                </div>
                                <div class="growth-detail">
                                    <span>Current: @currentPeriodActiveMembers</span>
                                    <span>Previous: @previousPeriodActiveMembers</span>
                                </div>
                            </div>
                            <div class="growth-item">
                                <div class="growth-label">Attendance Growth</div>
                                <div class="growth-value @(attendanceGrowthPercent >= 0 ? "success" : "danger")">
                                    @(attendanceGrowthPercent >= 0 ? "+" : "")@(attendanceGrowthPercent.ToString("F1"))%
                                </div>
                                <div class="growth-detail">
                                    <span>Current: @currentPeriodAttendance</span>
                                    <span>Previous: @previousPeriodAttendance</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Trend Chart -->
                <div class="report-card full-width">
                    <h3>KPI Trend Chart</h3>
                    <div class="report-content">
                        <div class="kpi-trend-container">
                            <div class="kpi-trend-grid">
                                @foreach (var kpi in kpiTrends)
                                {
                                    <div class="kpi-trend-item">
                                        <div class="kpi-trend-label">@kpi.Label</div>
                                        <div class="kpi-trend-bar">
                                            <div class="kpi-trend-fill" style="width: @(Math.Min(100, Math.Max(0, kpi.NormalizedValue)))%"></div>
                                        </div>
                                        <div class="kpi-trend-value @(kpi.ChangePercent >= 0 ? "success" : "danger")">
                                            @kpi.CurrentValue
                                            @if (kpi.ChangePercent != 0)
                                            {
                                                <span class="kpi-change">(@(kpi.ChangePercent >= 0 ? "+" : "")@(kpi.ChangePercent.ToString("F1"))%)</span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="kpi-summary">
                                <div class="kpi-summary-item">
                                    <span>Business Health:</span>
                                    <span class="@(overallBusinessHealth == "Healthy" ? "success" : overallBusinessHealth == "At Risk" ? "danger" : "warning")">@overallBusinessHealth</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Report 7: Member Retention Report -->
            <div class="report-card">
                    <h3> Member Retention</h3>
                <div class="report-content">
                    <div class="report-item">
                        <span>Active Members:</span>
                            <span class="success">@activeMembers</span>
                    </div>
                    <div class="report-item">
                        <span>Inactive (30+ days):</span>
                            <span class="warning">@inactiveMembers</span>
                        </div>
                        <div class="report-item">
                            <span>Renewal Rate:</span>
                            <span>@(renewalRate.ToString("F1"))%</span>
                        </div>
                        <div class="report-item">
                            <span>Churn Rate:</span>
                            <span class="danger">@(churnRate.ToString("F1"))%</span>
                        </div>
                        <div class="report-item">
                            <span>Avg. Membership Duration:</span>
                            <span>@averageMembershipDuration days</span>
                        </div>
                    </div>
                </div>

                <!-- Report 8: Membership Type Popularity -->
                <div class="report-card">
                    <h3> Membership Type Popularity</h3>
                    <div class="report-content">
                        @foreach (var pop in membershipPopularity)
                        {
                    <div class="report-item">
                                <span>@pop.TypeName:</span>
                                <span>@pop.MemberCount members</span>
                            </div>
                            <div class="report-item sub-item">
                                <span>Revenue:</span>
                                <span class="amount">₱@(pop.Revenue.ToString("N2"))</span>
                            </div>
                            <div class="report-item sub-item">
                                <span>Popularity:</span>
                                <span>@(pop.PopularityPercentage.ToString("F1"))%</span>
                    </div>
                        }
                </div>
            </div>

                <!-- Report 11: Attendance Patterns -->
            <div class="report-card">
                    <h3> Attendance Patterns</h3>
                <div class="report-content">
                    <div class="report-item">
                        <span>Total Check-ins:</span>
                            <span>@totalAttendance</span>
                        </div>
                        <div class="report-item">
                            <span>Peak Day:</span>
                            <span>@peakAttendanceDay</span>
                        </div>
                        <div class="report-item">
                            <span>Peak Time:</span>
                            <span>@peakAttendanceTime</span>
                    </div>
                    <div class="report-item">
                            <span>Avg. Visits/Member:</span>
                            <span>@(averageVisitsPerMember.ToString("F1"))</span>
                    </div>
                    <div class="report-item">
                            <span>Most Active Day:</span>
                            <span>@mostActiveDay</span>
                    </div>
                </div>
            </div>

                <!-- Report 13: Customer Lifetime Value -->
            <div class="report-card">
                    <h3> Customer Lifetime Value</h3>
                <div class="report-content">
                    <div class="report-item">
                            <span>Average CLV:</span>
                            <span class="amount">₱@(averageCLV.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Total CLV:</span>
                            <span class="amount">₱@(totalCLV.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Top 10% CLV:</span>
                            <span class="amount">₱@(top10PercentCLV.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Avg. Revenue/Member:</span>
                            <span class="amount">₱@(averageRevenuePerMember.ToString("N2"))</span>
                        </div>
                    </div>
                </div>

                <!-- Report 14: Marketing ROI -->
                <div class="report-card">
                    <h3> Marketing ROI</h3>
                    <div class="report-content">
                        <div class="report-item">
                            <span>Promotions Used:</span>
                            <span>@promotionsUsed</span>
                        </div>
                        <div class="report-item">
                            <span>Revenue from Promos:</span>
                            <span class="amount">₱@(revenueFromPromotions.ToString("N2"))</span>
                        </div>
                        <div class="report-item">
                            <span>Total Discount Given:</span>
                            <span class="amount">₱@(totalDiscountGiven.ToString("N2"))</span>
                    </div>
                    <div class="report-item">
                            <span>Net Revenue (After Discount):</span>
                            <span class="amount">₱@(netRevenueAfterDiscount.ToString("N2"))</span>
                    </div>
                    <div class="report-item">
                            <span>ROI:</span>
                            <span class="@(marketingROI >= 100 ? "success" : "warning")">@(marketingROI.ToString("F1"))%</span>
                        </div>
                    </div>
                </div>

                <!-- Report 15: Membership Expiration & Renewal Forecast -->
                <div class="report-card full-width">
                    <h3> Membership Expiration & Renewal Forecast</h3>
                    <div class="report-content">
                        <div class="forecast-grid">
                            <div class="forecast-item">
                                <div class="forecast-label">Expiring in 30 days</div>
                                <div class="forecast-count warning">@expiringIn30Days</div>
                                <div class="forecast-revenue">₱@(revenueAtRisk30Days.ToString("N2"))</div>
                            </div>
                            <div class="forecast-item">
                                <div class="forecast-label">Expiring in 60 days</div>
                                <div class="forecast-count warning">@expiringIn60Days</div>
                                <div class="forecast-revenue">₱@(revenueAtRisk60Days.ToString("N2"))</div>
                            </div>
                            <div class="forecast-item">
                                <div class="forecast-label">Expiring in 90 days</div>
                                <div class="forecast-count warning">@expiringIn90Days</div>
                                <div class="forecast-revenue">₱@(revenueAtRisk90Days.ToString("N2"))</div>
                            </div>
                            <div class="forecast-item">
                                <div class="forecast-label">Total At Risk</div>
                                <div class="forecast-count danger">@totalExpiring</div>
                                <div class="forecast-revenue danger">₱@(totalRevenueAtRisk.ToString("N2"))</div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
        </div> <!-- Close reports-content -->
    }
</div>

<style>
    .reports-page {
        padding: 30px;
        background: white;
        min-height: 100vh;
    }

    .reports-header {
        background: white;
        padding: 25px 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }

        .reports-header h1 {
            color: #000000;
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

    .date-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .date-filter label {
        font-weight: 600;
        color: #000000;
        }

    .period-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
    }

    .date-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    .loading-message {
        text-align: center;
        padding: 50px;
        font-size: 18px;
        color: #000000;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-icon {
        font-size: 2.5rem;
    }

    .stat-info h3 {
        margin: 0 0 10px 0;
        color: #000000;
        font-size: 1rem;
        font-weight: 600;
    }

    .stat-amount, .stat-number {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .income .stat-amount {
        color: #000000;
    }

    .members .stat-number {
        color: #000000;
    }

    .attendance .stat-number {
        color: #000000;
    }

    .clv .stat-amount {
        color: #000000;
    }

    .stat-breakdown {
        font-size: 0.8rem;
        color: #000000;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    /* Reports Section */
    .reports-section {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

        .section-header h2 {
            margin: 0;
            color: #000000;
            font-size: 20px;
            font-weight: 600;
        }

    .export-buttons {
        display: flex;
        gap: 10px;
    }

    .export-btn {
        background: #234060;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .export-btn:hover {
            background: #1a3450;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(35, 64, 96, 0.3);
        }

    .print-btn {
        background: #27ae60;
    }

        .print-btn:hover {
            background: #229954;
        }

    /* Print Styles */
    @@media print {
        .reports-header,
        .section-header,
        .export-buttons,
        .date-filter {
            display: none !important;
        }

        .reports-page {
            padding: 0;
            background: white;
        }

        .reports-section {
            box-shadow: none;
            padding: 0;
        }

        .report-card {
            page-break-inside: avoid;
            margin-bottom: 20px;
        }

        .stat-card,
        .performance-card {
            page-break-inside: avoid;
        }

        body {
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }
    }

    /* Reports Grid */
    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .report-card {
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 20px;
        background: #fafbfc;
    }

    .report-card.full-width {
        grid-column: 1 / -1;
    }

        .report-card h3 {
            margin: 0 0 15px 0;
            color: #000000;
            font-size: 1.1rem;
            font-weight: 600;
        }

    .report-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .report-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #ecf0f1;
        color: #000000;
    }
    
    .report-item span {
        color: #000000;
    }

    .report-item.sub-item {
        padding-left: 20px;
        font-size: 0.9rem;
        color: #000000;
    }

        .report-item:last-child {
            border-bottom: none;
        }

    .amount {
        font-weight: 600;
        color: #000000;
    }

    .amount.total {
        font-size: 1.1rem;
        color: #000000;
    }

    .success {
        color: #000000;
        font-weight: bold;
        }

    .warning {
        color: #000000;
        font-weight: bold;
    }

    .danger {
        color: #000000;
        font-weight: bold;
    }

    .trend-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 10px;
    }

    .trend-item {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e1e8ed;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 60px;
    }

    .trend-amount {
        font-size: 1.4rem;
        font-weight: bold;
        color: #000000;
    }

    .forecast-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 10px;
    }

    .forecast-item {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e1e8ed;
    }

    .forecast-label {
        font-size: 0.9rem;
        color: #000000;
        margin-bottom: 10px;
    }

    .forecast-count {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
        color: #000000;
    }

    .forecast-revenue {
        font-size: 1.1rem;
        font-weight: 600;
        color: #000000;
    }

    /* Business Performance Overview */
    .performance-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .performance-card {
        background: white;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .performance-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f4f8;
    }

    .performance-header h3 {
        margin: 0;
        color: #000000;
        font-size: 1rem;
        font-weight: 600;
    }

    .performance-indicator {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .performance-indicator.success {
        background: transparent;
        color: #000000;
    }

    .performance-indicator.danger {
        background: transparent;
        color: #000000;
    }

    .performance-indicator.warning {
        background: transparent;
        color: #000000;
    }

    .performance-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .performance-metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f4f8;
        color: #000000;
    }
    
    .performance-metric span {
        color: #000000;
    }

    .performance-metric:last-child {
        border-bottom: none;
    }

    /* Enhanced Revenue Trends */
    .trend-comparison {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e1e8ed;
    }

    .comparison-header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .comparison-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .comparison-label {
        font-size: 0.85rem;
        color: #000000;
    }

    .comparison-amount {
        font-size: 1.2rem;
        font-weight: bold;
        color: #000000;
    }

    .comparison-change {
        font-size: 1.1rem;
        font-weight: bold;
        color: #000000;
    }

    .comparison-direction {
        font-size: 1rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 6px;
        color: #000000;
        background: transparent;
    }

    /* Growth Trend Report */
    .growth-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 10px;
    }

    .growth-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #e1e8ed;
        text-align: center;
    }

    .growth-label {
        font-size: 0.9rem;
        color: #000000;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .growth-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #000000;
    }

    .growth-detail {
        display: flex;
        flex-direction: column;
        gap: 5px;
        font-size: 0.85rem;
        color: #000000;
    }

    /* KPI Trend Chart */
    .kpi-trend-container {
        margin-top: 10px;
    }

    .kpi-trend-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .kpi-trend-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e1e8ed;
    }

    .kpi-trend-label {
        min-width: 150px;
        font-weight: 600;
        color: #000000;
    }

    .kpi-trend-bar {
        flex: 1;
        height: 30px;
        background: #e1e8ed;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    .kpi-trend-fill {
        height: 100%;
        background: linear-gradient(90deg, #234060 0%, #3498db 100%);
        border-radius: 15px;
        transition: width 0.3s ease;
    }

    .kpi-trend-value {
        min-width: 120px;
        text-align: right;
        font-weight: bold;
        font-size: 1.1rem;
        color: #000000;
    }

    .kpi-change {
        font-size: 0.85rem;
        margin-left: 5px;
    }

    .kpi-summary {
        margin-top: 20px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e1e8ed;
    }

    .kpi-summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #000000;
    }
    
    .kpi-summary-item span {
        color: #000000;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .reports-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .reports-grid {
            grid-template-columns: 1fr;
        }

        .trend-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .forecast-grid {
            grid-template-columns: 1fr;
        }

        .performance-overview {
            grid-template-columns: 1fr;
        }

        .comparison-header {
            grid-template-columns: 1fr;
        }

        .growth-grid {
            grid-template-columns: 1fr;
        }

        .kpi-trend-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .kpi-trend-label {
            min-width: auto;
        }

        .kpi-trend-bar {
            width: 100%;
        }
    }
</style>

@code {
    private string selectedPeriod = "month";
    private DateTime? customStartDate = DateTime.Today.AddDays(-30);
    private DateTime? customEndDate = DateTime.Today;
    private bool isLoading = true;

    // Report Data
    private decimal totalIncome = 0;
    private decimal memberIncome = 0;
    private decimal walkinIncome = 0;
    private decimal cashRevenue = 0;
    private decimal ewalletRevenue = 0;
    private decimal cashPercentage = 0;
    private decimal ewalletPercentage = 0;
    private decimal memberPercentage = 0;
    private decimal walkinPercentage = 0;

    private int activeMembers = 0;
    private int newMembers = 0;
    private int expiringMembers = 0;
    private int inactiveMembers = 0;
    private int totalAttendance = 0;
    private string peakAttendanceDay = "N/A";
    private string peakAttendanceTime = "N/A";
    private double averageVisitsPerMember = 0;
    private string mostActiveDay = "N/A";

    private decimal collectedPayments = 0;
    private decimal pendingPayments = 0;
    private double collectionRate = 0;
    private int overdueCount = 0;

    private decimal averageCLV = 0;
    private decimal totalCLV = 0;
    private decimal top10PercentCLV = 0;
    private decimal averageRevenuePerMember = 0;

    private double renewalRate = 0;
    private double churnRate = 0;
    private int averageMembershipDuration = 0;

    private int promotionsUsed = 0;
    private decimal revenueFromPromotions = 0;
    private decimal totalDiscountGiven = 0;
    private decimal netRevenueAfterDiscount = 0;
    private double marketingROI = 0;

    private int expiringIn30Days = 0;
    private int expiringIn60Days = 0;
    private int expiringIn90Days = 0;
    private int totalExpiring = 0;
    private decimal revenueAtRisk30Days = 0;
    private decimal revenueAtRisk60Days = 0;
    private decimal revenueAtRisk90Days = 0;
    private decimal totalRevenueAtRisk = 0;

    private List<MembershipTypeRevenue> revenueByMembershipType = new();
    private List<MembershipPopularity> membershipPopularity = new();
    private List<RevenueTrend> revenueTrends = new();

    // Business Performance Overview
    private string revenueDirection = "Stable";
    private decimal currentPeriodRevenue = 0;
    private decimal previousPeriodRevenue = 0;
    private double revenueChangePercent = 0;
    private string newMembersDirection = "Stable";
    private int currentPeriodNewMembers = 0;
    private int previousPeriodNewMembers = 0;
    private double newMembersChangePercent = 0;
    private string attendanceDirection = "Stable";
    private int currentPeriodAttendance = 0;
    private int previousPeriodAttendance = 0;
    private double attendanceChangePercent = 0;
    private string renewalDirection = "Stable";
    private string overallPerformance = "Stable";

    // Enhanced Revenue Trends
    private RevenueTrendComparison? revenueTrendComparison = null;

    // Growth Trend Report
    private double revenueGrowthPercent = 0;
    private double activeMembersGrowthPercent = 0;
    private double attendanceGrowthPercent = 0;
    private int currentPeriodActiveMembers = 0;
    private int previousPeriodActiveMembers = 0;

    // KPI Trend Chart
    private List<KPITrend> kpiTrends = new();
    private string overallBusinessHealth = "Stable";

    private class MembershipTypeRevenue
    {
        public string TypeName { get; set; } = string.Empty;
        public decimal Revenue { get; set; }
    }

    private class MembershipPopularity
    {
        public string TypeName { get; set; } = string.Empty;
        public int MemberCount { get; set; }
        public decimal Revenue { get; set; }
        public double PopularityPercentage { get; set; }
    }

    private class RevenueTrend
    {
        public string Label { get; set; } = string.Empty;
        public decimal Amount { get; set; }
    }

    private class RevenueTrendComparison
    {
        public decimal CurrentMonth { get; set; }
        public decimal PreviousMonth { get; set; }
        public double ChangePercent { get; set; }
        public string Direction { get; set; } = "Stable";
    }

    private class KPITrend
    {
        public string Label { get; set; } = string.Empty;
        public decimal CurrentValue { get; set; }
        public decimal PreviousValue { get; set; }
        public double ChangePercent { get; set; }
        public double NormalizedValue { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadReportData();
    }

    private async Task OnPeriodChanged()
    {
        await LoadReportData();
    }

    private (DateTime start, DateTime end) GetDateRange()
    {
        var today = DateTime.Today;
        return selectedPeriod switch
        {
            "today" => (today, today.AddDays(1).AddSeconds(-1)),
            "week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(1).AddSeconds(-1)),
            "month" => (new DateTime(today.Year, today.Month, 1), today.AddDays(1).AddSeconds(-1)),
            "year" => (new DateTime(today.Year, 1, 1), today.AddDays(1).AddSeconds(-1)),
            "custom" => (customStartDate ?? today.AddDays(-30), customEndDate ?? today),
            _ => (today.AddDays(-30), today)
        };
    }

    private async Task LoadReportData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var (startDate, endDate) = GetDateRange();

            // Report 1: Revenue by Payment Method
            await LoadRevenueByPaymentMethod(startDate, endDate);

            // Report 2: Revenue by Membership Type
            await LoadRevenueByMembershipType(startDate, endDate);

            // Report 3: Revenue by Source
            await LoadRevenueBySource(startDate, endDate);

            // Report 4: Payment Collection
            await LoadPaymentCollection(startDate, endDate);

            // Business Performance Overview
            await LoadBusinessPerformanceOverview(startDate, endDate);

            // Growth Trend Report
            await LoadGrowthTrendReport(startDate, endDate);

            // KPI Trend Chart
            await LoadKPITrendChart(startDate, endDate);

            // Report 7: Member Retention
            await LoadMemberRetention();

            // Report 8: Membership Type Popularity
            await LoadMembershipPopularity();

            // Report 11: Attendance Patterns
            await LoadAttendancePatterns(startDate, endDate);

            // Report 13: Customer Lifetime Value
            await LoadCustomerLifetimeValue();

            // Report 14: Marketing ROI
            await LoadMarketingROI(startDate, endDate);

            // Report 15: Expiration & Renewal Forecast
            await LoadExpirationForecast();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading reports: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Report 1: Revenue by Payment Method
    private async Task LoadRevenueByPaymentMethod(DateTime startDate, DateTime endDate)
    {
        // Member payments
        var memberPayments = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .ToListAsync();

        cashRevenue = memberPayments.Where(p => p.PaymentType == "Cash").Sum(p => p.Amount);
        ewalletRevenue = memberPayments.Where(p => p.PaymentType == "Ewallet").Sum(p => p.Amount);

        // Walk-in payments
        var walkinPayments = await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .ToListAsync();

        cashRevenue += walkinPayments.Where(w => w.PaymentMethod == "Cash").Sum(w => w.PaymentAmount);
        ewalletRevenue += walkinPayments.Where(w => w.PaymentMethod == "Ewallet").Sum(w => w.PaymentAmount);

        totalIncome = cashRevenue + ewalletRevenue;
        cashPercentage = totalIncome > 0 ? (cashRevenue / totalIncome) * 100 : 0;
        ewalletPercentage = totalIncome > 0 ? (ewalletRevenue / totalIncome) * 100 : 0;
    }

    // Report 2: Revenue by Membership Type
    private async Task LoadRevenueByMembershipType(DateTime startDate, DateTime endDate)
    {
        var payments = await Context.Payments
            .Include(p => p.Member)
            .ThenInclude(m => m!.MembershipType)
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .ToListAsync();

        revenueByMembershipType = payments
            .Where(p => p.Member?.MembershipType != null)
            .GroupBy(p => p.Member!.MembershipType!.TypeName)
            .Select(g => new MembershipTypeRevenue
            {
                TypeName = g.Key,
                Revenue = g.Sum(p => p.Amount)
            })
            .OrderByDescending(m => m.Revenue)
            .ToList();
    }

    // Report 3: Revenue by Source
    private async Task LoadRevenueBySource(DateTime startDate, DateTime endDate)
    {
        memberIncome = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);

        walkinIncome = await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        totalIncome = memberIncome + walkinIncome;
        memberPercentage = totalIncome > 0 ? (memberIncome / totalIncome) * 100 : 0;
        walkinPercentage = totalIncome > 0 ? (walkinIncome / totalIncome) * 100 : 0;
    }

    // Report 4: Payment Collection
    private async Task LoadPaymentCollection(DateTime startDate, DateTime endDate)
    {
        collectedPayments = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);

        // Pending = members who should have paid but haven't
        var today = DateTime.Today;
        var membersWithExpiredMemberships = await Context.Members
            .Where(m => !m.IsArchived && m.ExpirationDate.HasValue && m.ExpirationDate < today)
            .Include(m => m.MembershipType)
            .ToListAsync();

        pendingPayments = membersWithExpiredMemberships
            .Where(m => m.MembershipType != null)
            .Sum(m => m.MembershipType!.Price);

        overdueCount = membersWithExpiredMemberships.Count;

        var totalExpected = collectedPayments + pendingPayments;
        collectionRate = totalExpected > 0 ? (double)((collectedPayments / totalExpected) * 100) : 100;
    }

    // Business Performance Overview
    private async Task LoadBusinessPerformanceOverview(DateTime startDate, DateTime endDate)
    {
        // Calculate previous period based on current period length
        var periodLength = (endDate - startDate).TotalDays;
        var previousStartDate = startDate.AddDays(-periodLength - 1);
        var previousEndDate = startDate.AddSeconds(-1);

        // Revenue Movement
        currentPeriodRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);
        currentPeriodRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        previousPeriodRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= previousStartDate && p.PaymentDate <= previousEndDate)
            .SumAsync(p => p.Amount);
        previousPeriodRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= previousStartDate && w.VisitDate <= previousEndDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        revenueChangePercent = previousPeriodRevenue > 0 
            ? (double)((currentPeriodRevenue - previousPeriodRevenue) / previousPeriodRevenue) * 100 
            : (currentPeriodRevenue > 0 ? 100 : 0);
        revenueDirection = revenueChangePercent > 5 ? "Growing" : revenueChangePercent < -5 ? "Declining" : "Stable";

        // New Members
        currentPeriodNewMembers = await Context.Members
            .CountAsync(m => !m.IsArchived && m.JoinDate >= startDate && m.JoinDate <= endDate);
        previousPeriodNewMembers = await Context.Members
            .CountAsync(m => !m.IsArchived && m.JoinDate >= previousStartDate && m.JoinDate <= previousEndDate);
        newMembersChangePercent = previousPeriodNewMembers > 0 
            ? ((currentPeriodNewMembers - previousPeriodNewMembers) / (double)previousPeriodNewMembers) * 100 
            : (currentPeriodNewMembers > 0 ? 100 : 0);
        newMembersDirection = newMembersChangePercent > 5 ? "Growing" : newMembersChangePercent < -5 ? "Declining" : "Stable";

        // Attendance Trends
        currentPeriodAttendance = await Context.Attendances
            .CountAsync(a => a.CheckinTime >= startDate && a.CheckinTime <= endDate);
        previousPeriodAttendance = await Context.Attendances
            .CountAsync(a => a.CheckinTime >= previousStartDate && a.CheckinTime <= previousEndDate);
        attendanceChangePercent = previousPeriodAttendance > 0 
            ? ((currentPeriodAttendance - previousPeriodAttendance) / (double)previousPeriodAttendance) * 100 
            : (currentPeriodAttendance > 0 ? 100 : 0);
        attendanceDirection = attendanceChangePercent > 5 ? "Growing" : attendanceChangePercent < -5 ? "Declining" : "Stable";

        // Renewal Activity (using existing renewalRate and churnRate)
        renewalDirection = renewalRate > 70 ? "Growing" : renewalRate < 50 ? "Declining" : "Stable";

        // Overall Performance
        var positiveIndicators = 0;
        if (revenueChangePercent > 0) positiveIndicators++;
        if (newMembersChangePercent > 0) positiveIndicators++;
        if (attendanceChangePercent > 0) positiveIndicators++;
        if (renewalRate > 60) positiveIndicators++;

        overallPerformance = positiveIndicators >= 3 ? "Improving" : positiveIndicators <= 1 ? "Dropping" : "Stable";
    }

    // Report 5: Revenue Trends (Enhanced with month-over-month comparison)
    private async Task LoadRevenueTrends(DateTime startDate, DateTime endDate)
    {
        revenueTrends = new List<RevenueTrend>();

        if (selectedPeriod == "year")
        {
            // Monthly trends
            var months = Enumerable.Range(0, 12)
                .Select(i => startDate.AddMonths(i))
                .Where(d => d <= endDate)
                .ToList();

            foreach (var month in months)
            {
                var monthStart = new DateTime(month.Year, month.Month, 1);
                var monthEnd = monthStart.AddMonths(1).AddSeconds(-1);

                var monthRevenue = await Context.Payments
                    .Where(p => p.PaymentDate >= monthStart && p.PaymentDate <= monthEnd)
                    .SumAsync(p => p.Amount);

                var monthWalkins = await Context.WalkIns
                    .Where(w => w.VisitDate >= monthStart && w.VisitDate <= monthEnd && !w.IsArchived)
                    .SumAsync(w => w.PaymentAmount);

                revenueTrends.Add(new RevenueTrend
                {
                    Label = monthStart.ToString("MMM yyyy"),
                    Amount = monthRevenue + monthWalkins
                });
            }
        }
        else
        {
            // Daily trends for shorter periods
            var days = Enumerable.Range(0, (int)(endDate - startDate).TotalDays + 1)
                .Select(i => startDate.AddDays(i))
                .ToList();

            foreach (var day in days.Take(14)) // Limit to 14 days for readability
            {
                var dayEnd = day.AddDays(1).AddSeconds(-1);

                var dayRevenue = await Context.Payments
                    .Where(p => p.PaymentDate >= day && p.PaymentDate <= dayEnd)
                    .SumAsync(p => p.Amount);

                var dayWalkins = await Context.WalkIns
                    .Where(w => w.VisitDate >= day && w.VisitDate <= dayEnd && !w.IsArchived)
                    .SumAsync(w => w.PaymentAmount);

                revenueTrends.Add(new RevenueTrend
                {
                    Label = day.ToString("MMM dd"),
                    Amount = dayRevenue + dayWalkins
                });
            }
        }

        // Add month-over-month comparison for current month
        if (selectedPeriod == "month" || selectedPeriod == "year")
        {
            var currentMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
            var currentMonthEnd = currentMonth.AddMonths(1).AddSeconds(-1);
            var previousMonth = currentMonth.AddMonths(-1);
            var previousMonthEnd = currentMonth.AddSeconds(-1);

            var currentMonthRevenue = await Context.Payments
                .Where(p => p.PaymentDate >= currentMonth && p.PaymentDate <= currentMonthEnd)
                .SumAsync(p => p.Amount);
            currentMonthRevenue += await Context.WalkIns
                .Where(w => w.VisitDate >= currentMonth && w.VisitDate <= currentMonthEnd && !w.IsArchived)
                .SumAsync(w => w.PaymentAmount);

            var previousMonthRevenue = await Context.Payments
                .Where(p => p.PaymentDate >= previousMonth && p.PaymentDate <= previousMonthEnd)
                .SumAsync(p => p.Amount);
            previousMonthRevenue += await Context.WalkIns
                .Where(w => w.VisitDate >= previousMonth && w.VisitDate <= previousMonthEnd && !w.IsArchived)
                .SumAsync(w => w.PaymentAmount);

            var changePercent = previousMonthRevenue > 0 
                ? ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100 
                : (currentMonthRevenue > 0 ? 100 : 0);

            revenueTrendComparison = new RevenueTrendComparison
            {
                CurrentMonth = currentMonthRevenue,
                PreviousMonth = previousMonthRevenue,
                ChangePercent = (double)changePercent,
                Direction = changePercent > 5 ? "Growing" : changePercent < -5 ? "Declining" : "Stable"
            };
        }
    }

    // Growth Trend Report
    private async Task LoadGrowthTrendReport(DateTime startDate, DateTime endDate)
    {
        var periodLength = (endDate - startDate).TotalDays;
        var previousStartDate = startDate.AddDays(-periodLength - 1);
        var previousEndDate = startDate.AddSeconds(-1);

        // Revenue Growth
        var currentRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);
        currentRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        var previousRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= previousStartDate && p.PaymentDate <= previousEndDate)
            .SumAsync(p => p.Amount);
        previousRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= previousStartDate && w.VisitDate <= previousEndDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        revenueGrowthPercent = previousRevenue > 0 
            ? (double)((currentRevenue - previousRevenue) / previousRevenue) * 100 
            : (currentRevenue > 0 ? 100 : 0);

        // Active Members Growth
        currentPeriodActiveMembers = await Context.Members
            .CountAsync(m => !m.IsArchived && m.Status == "Active");
        previousPeriodActiveMembers = await Context.Members
            .Where(m => !m.IsArchived && m.Status == "Active")
            .CountAsync(); // Simplified - in real scenario, would track historical counts

        activeMembersGrowthPercent = previousPeriodActiveMembers > 0 
            ? ((currentPeriodActiveMembers - previousPeriodActiveMembers) / (double)previousPeriodActiveMembers) * 100 
            : (currentPeriodActiveMembers > 0 ? 100 : 0);

        // Attendance Growth (already calculated in Business Performance Overview)
        attendanceGrowthPercent = attendanceChangePercent;
    }

    // KPI Trend Chart
    private async Task LoadKPITrendChart(DateTime startDate, DateTime endDate)
    {
        var periodLength = (endDate - startDate).TotalDays;
        var previousStartDate = startDate.AddDays(-periodLength - 1);
        var previousEndDate = startDate.AddSeconds(-1);

        kpiTrends = new List<KPITrend>();

        // Revenue KPI
        var currentRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
            .SumAsync(p => p.Amount);
        currentRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= startDate && w.VisitDate <= endDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        var previousRevenue = await Context.Payments
            .Where(p => p.PaymentDate >= previousStartDate && p.PaymentDate <= previousEndDate)
            .SumAsync(p => p.Amount);
        previousRevenue += await Context.WalkIns
            .Where(w => w.VisitDate >= previousStartDate && w.VisitDate <= previousEndDate && !w.IsArchived)
            .SumAsync(w => w.PaymentAmount);

        var revenueChange = previousRevenue > 0 
            ? ((currentRevenue - previousRevenue) / previousRevenue) * 100 
            : (currentRevenue > 0 ? 100 : 0);

        kpiTrends.Add(new KPITrend
        {
            Label = "Revenue",
            CurrentValue = currentRevenue,
            PreviousValue = previousRevenue,
            ChangePercent = (double)revenueChange,
            NormalizedValue = Math.Min(100, Math.Max(0, (double)(currentRevenue / Math.Max(1, previousRevenue)) * 50))
        });

        // Member Count KPI
        var currentMembers = await Context.Members.CountAsync(m => !m.IsArchived);
        var previousMembers = currentMembers; // Simplified
        var membersChange = previousMembers > 0 
            ? ((currentMembers - previousMembers) / (double)previousMembers) * 100 
            : (currentMembers > 0 ? 100 : 0);

        kpiTrends.Add(new KPITrend
        {
            Label = "Member Count",
            CurrentValue = currentMembers,
            PreviousValue = previousMembers,
            ChangePercent = membersChange,
            NormalizedValue = Math.Min(100, Math.Max(0, (currentMembers / Math.Max(1, previousMembers)) * 50))
        });

        // Attendance KPI
        var currentAttend = await Context.Attendances
            .CountAsync(a => a.CheckinTime >= startDate && a.CheckinTime <= endDate);
        var previousAttend = await Context.Attendances
            .CountAsync(a => a.CheckinTime >= previousStartDate && a.CheckinTime <= previousEndDate);
        var attendChange = previousAttend > 0 
            ? ((currentAttend - previousAttend) / (double)previousAttend) * 100 
            : (currentAttend > 0 ? 100 : 0);

        kpiTrends.Add(new KPITrend
        {
            Label = "Attendance",
            CurrentValue = currentAttend,
            PreviousValue = previousAttend,
            ChangePercent = attendChange,
            NormalizedValue = Math.Min(100, Math.Max(0, (currentAttend / Math.Max(1, previousAttend)) * 50))
        });

        // Churn Rate KPI (lower is better, so we invert)
        var churnChange = churnRate;
        kpiTrends.Add(new KPITrend
        {
            Label = "Churn Rate",
            CurrentValue = (decimal)churnRate,
            PreviousValue = (decimal)churnRate, // Simplified
            ChangePercent = -churnChange, // Negative because lower churn is better
            NormalizedValue = Math.Min(100, Math.Max(0, 100 - churnRate * 5)) // Invert: lower churn = higher value
        });

        // Determine overall business health
        var healthyKPIs = kpiTrends.Count(k => 
            (k.Label != "Churn Rate" && k.ChangePercent >= 0) || 
            (k.Label == "Churn Rate" && k.ChangePercent <= 0));
        overallBusinessHealth = healthyKPIs >= 3 ? "Healthy" : healthyKPIs <= 1 ? "At Risk" : "Stable";
    }

    // Report 7: Member Retention
    private async Task LoadMemberRetention()
    {
        var today = DateTime.Today;
        var thirtyDaysAgo = today.AddDays(-30);

        activeMembers = await Context.Members
            .CountAsync(m => !m.IsArchived && m.Status == "Active" && 
                           (!m.ExpirationDate.HasValue || m.ExpirationDate >= today));

        inactiveMembers = await Context.Members
            .CountAsync(m => !m.IsArchived && m.Status == "Active" && 
                           m.ExpirationDate.HasValue && m.ExpirationDate < thirtyDaysAgo);

        var allMembers = await Context.Members
            .Where(m => !m.IsArchived)
            .ToListAsync();

        var renewedMembers = allMembers.Count(m => 
            m.ExpirationDate.HasValue && m.ExpirationDate >= today && 
            m.JoinDate < m.ExpirationDate);

        var totalMembers = allMembers.Count;
        renewalRate = totalMembers > 0 ? (renewedMembers / (double)totalMembers) * 100 : 0;
        churnRate = totalMembers > 0 ? (inactiveMembers / (double)totalMembers) * 100 : 0;

        if (allMembers.Any())
        {
            averageMembershipDuration = (int)allMembers
                .Where(m => m.ExpirationDate.HasValue)
                .Average(m => (m.ExpirationDate!.Value - m.JoinDate).TotalDays);
        }

        newMembers = await Context.Members
            .CountAsync(m => !m.IsArchived && m.JoinDate >= thirtyDaysAgo);

        expiringMembers = await Context.Members
            .CountAsync(m => !m.IsArchived && m.Status == "Active" && 
                           m.ExpirationDate.HasValue && 
                           m.ExpirationDate >= today && 
                           m.ExpirationDate <= today.AddDays(7));
    }

    // Report 8: Membership Type Popularity
    private async Task LoadMembershipPopularity()
    {
        var members = await Context.Members
            .Include(m => m.MembershipType)
            .Where(m => !m.IsArchived)
            .ToListAsync();

        var totalMembers = members.Count;

        membershipPopularity = members
            .Where(m => m.MembershipType != null)
            .GroupBy(m => m.MembershipType!.TypeName)
            .Select(g => new MembershipPopularity
            {
                TypeName = g.Key,
                MemberCount = g.Count(),
                Revenue = g.Sum(m => m.MembershipType!.Price),
                PopularityPercentage = totalMembers > 0 ? (g.Count() / (double)totalMembers) * 100 : 0
            })
            .OrderByDescending(m => m.MemberCount)
            .ToList();
    }

    // Report 11: Attendance Patterns
    private async Task LoadAttendancePatterns(DateTime startDate, DateTime endDate)
    {
        var attendances = await Context.Attendances
            .Where(a => a.CheckinTime >= startDate && a.CheckinTime <= endDate)
            .ToListAsync();

        totalAttendance = attendances.Count;

        if (attendances.Any())
        {
            var dayGroups = attendances
                .GroupBy(a => a.CheckinTime.DayOfWeek)
                .OrderByDescending(g => g.Count())
                .ToList();

            if (dayGroups.Any())
            {
                peakAttendanceDay = dayGroups.First().Key.ToString();
                mostActiveDay = dayGroups.First().Key.ToString();
            }

            var hourGroups = attendances
                .GroupBy(a => a.CheckinTime.Hour)
                .OrderByDescending(g => g.Count())
                .ToList();

            if (hourGroups.Any())
            {
                var peakHour = hourGroups.First().Key;
                peakAttendanceTime = $"{peakHour:00}:00";
            }

            var memberIds = attendances.Select(a => a.MemberID).Distinct().Count();
            averageVisitsPerMember = memberIds > 0 ? (double)totalAttendance / memberIds : 0;
        }
    }

    // Report 13: Customer Lifetime Value
    private async Task LoadCustomerLifetimeValue()
    {
        var members = await Context.Members
            .Include(m => m.Payments)
            .Where(m => !m.IsArchived)
            .ToListAsync();

        if (!members.Any())
        {
            averageCLV = 0;
            totalCLV = 0;
            averageRevenuePerMember = 0;
            return;
        }

        var memberCLVs = members.Select(m => new
        {
            MemberID = m.MemberID,
            TotalRevenue = m.Payments.Sum(p => p.Amount),
            MembershipDuration = m.ExpirationDate.HasValue 
                ? (m.ExpirationDate.Value - m.JoinDate).TotalDays 
                : (DateTime.Today - m.JoinDate).TotalDays
        }).ToList();

        totalCLV = memberCLVs.Sum(m => m.TotalRevenue);
        averageCLV = memberCLVs.Any() ? memberCLVs.Average(m => m.TotalRevenue) : 0;
        averageRevenuePerMember = averageCLV;

        var sortedCLVs = memberCLVs.OrderByDescending(m => m.TotalRevenue).ToList();
        var top10PercentCount = Math.Max(1, (int)(sortedCLVs.Count * 0.1));
        top10PercentCLV = sortedCLVs.Take(top10PercentCount).Any() 
            ? sortedCLVs.Take(top10PercentCount).Average(m => m.TotalRevenue) 
            : 0;
    }

    // Report 14: Marketing ROI
    private async Task LoadMarketingROI(DateTime startDate, DateTime endDate)
    {
        try
        {
            // Check if MemberPromos table exists by trying to query it
            var memberPromos = await Context.MemberPromos
                .Include(mp => mp.Promotion)
                .Include(mp => mp.Member)
                .ThenInclude(m => m!.Payments)
                .Where(mp => mp.DateUsed.HasValue && mp.DateUsed >= startDate && mp.DateUsed <= endDate)
                .ToListAsync();

            promotionsUsed = memberPromos.Count;

            revenueFromPromotions = memberPromos
                .Where(mp => mp.Member != null)
                .Sum(mp => mp.Member!.Payments
                    .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
                    .Sum(p => p.Amount));

            totalDiscountGiven = memberPromos
                .Where(mp => mp.Promotion != null && mp.Member != null)
                .Sum(mp =>
                {
                    var memberPayments = mp.Member!.Payments
                        .Where(p => p.PaymentDate >= startDate && p.PaymentDate <= endDate)
                        .Sum(p => p.Amount);
                    return memberPayments * (mp.Promotion!.DiscountRate / 100);
                });

            netRevenueAfterDiscount = revenueFromPromotions - totalDiscountGiven;

            marketingROI = totalDiscountGiven > 0 
                ? (double)((netRevenueAfterDiscount / totalDiscountGiven) * 100) 
                : revenueFromPromotions > 0 ? 100 : 0;
        }
        catch (Exception)
        {
            // MemberPromos table doesn't exist yet or has no data
            // Set default values
            promotionsUsed = 0;
            revenueFromPromotions = 0;
            totalDiscountGiven = 0;
            netRevenueAfterDiscount = 0;
            marketingROI = 0;
        }
    }

    // Report 15: Expiration & Renewal Forecast
    private async Task LoadExpirationForecast()
    {
        var today = DateTime.Today;
        var in30Days = today.AddDays(30);
        var in60Days = today.AddDays(60);
        var in90Days = today.AddDays(90);

        var members = await Context.Members
            .Include(m => m.MembershipType)
            .Where(m => !m.IsArchived && m.Status == "Active" && m.ExpirationDate.HasValue)
            .ToListAsync();

        expiringIn30Days = members.Count(m => m.ExpirationDate >= today && m.ExpirationDate <= in30Days);
        expiringIn60Days = members.Count(m => m.ExpirationDate > in30Days && m.ExpirationDate <= in60Days);
        expiringIn90Days = members.Count(m => m.ExpirationDate > in60Days && m.ExpirationDate <= in90Days);
        totalExpiring = members.Count(m => m.ExpirationDate >= today && m.ExpirationDate <= in90Days);

        revenueAtRisk30Days = members
            .Where(m => m.ExpirationDate >= today && m.ExpirationDate <= in30Days && m.MembershipType != null)
            .Sum(m => m.MembershipType!.Price);

        revenueAtRisk60Days = members
            .Where(m => m.ExpirationDate > in30Days && m.ExpirationDate <= in60Days && m.MembershipType != null)
            .Sum(m => m.MembershipType!.Price);

        revenueAtRisk90Days = members
            .Where(m => m.ExpirationDate > in60Days && m.ExpirationDate <= in90Days && m.MembershipType != null)
            .Sum(m => m.MembershipType!.Price);

        totalRevenueAtRisk = revenueAtRisk30Days + revenueAtRisk60Days + revenueAtRisk90Days;
    }

    private async Task ExportToPDF()
    {
        try
        {
            // Make sure reports are loaded before exporting
            if (isLoading)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please wait for reports to finish loading before exporting.");
                return;
            }

            // Force a state update to ensure UI is rendered
            StateHasChanged();
            await Task.Delay(100);

            var fileName = $"Reports_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            var result = await JSRuntime.InvokeAsync<bool>("exportToPDF", "reports-content", fileName);
            
            if (result)
            {
                await JSRuntime.InvokeVoidAsync("alert", "PDF exported successfully!");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Error exporting PDF. Please try again.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error exporting PDF: {ex.Message}");
        }
    }

    private async Task PrintReports()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("window.print");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error printing: {ex.Message}");
        }
    }
}
