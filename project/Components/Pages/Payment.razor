@page "/payment"
@layout MainLayout
@using System.Linq
@using System.ComponentModel.DataAnnotations
@using Microsoft.EntityFrameworkCore
@using project.Data
@using project.Models
@using project.Services
@using MemberModel = project.Models.Member
@using MembershipTypeModel = project.Models.MembershipType
@using PaymentModel = project.Models.Payment
@using TrainerModel = project.Models.Trainer
@using TrainerScheduleModel = project.Models.TrainerSchedule
@using MemberPromo = project.Models.MemberPromo
@inject AppDbContext Context
@inject IJSRuntime JSRuntime
@inject IToastService ToastService

<div class="payments-container">
    <div class="payments-header">
        <div>
            <h1>Membership Payments</h1>
            <p class="subtitle">Create new subscriptions and record payments based on membership plans.</p>
        </div>
        <div class="header-actions">
            <button class="primary-btn" @onclick="OpenSubscriptionModal">+ New Subscription</button>
        </div>
    </div>

    <div class="payments-content">
        <div class="info-card">
            <h3>How it works</h3>
            <ul>
                <li>Select the membership type the customer wants.</li>
                <li>The form auto-fills the price and computes the expiration date.</li>
                <li>Submitting the form creates the member record and records a payment entry.</li>
            </ul>
        </div>
    </div>

    <!-- Detailed subscriptions datatable with search -->
    <div class="table-container payments-table-section">
        <div class="table-toolbar payments-filters">
            <div class="toolbar-left">
                <span class="table-title">Recent Subscriptions</span>
                <div class="filter-group">
                    <label class="filter-label">Period:</label>
                    <select class="period-select" @bind="paymentsSelectedPeriod" @bind:after="OnPaymentsPeriodChanged">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    @if (paymentsSelectedPeriod == "custom")
                    {
                        <input type="date" class="date-input" @bind="paymentsCustomStartDate" @bind:after="OnPaymentsPeriodChanged" />
                        <span>to</span>
                        <input type="date" class="date-input" @bind="paymentsCustomEndDate" @bind:after="OnPaymentsPeriodChanged" />
                    }
                </div>
            </div>
            <input type="text"
                   class="search-bar"
                   placeholder="Search by name or payment method..."
                   @oninput="OnPaymentsSearchChanged" />
        </div>

        <div class="subscriptions-table">
            <table class="members-table payments-table">
                <thead>
                    <tr>
                        <th>MEMBER NAME</th>
                        <th>JOIN DATE</th>
                        <th>PAYMENT DATE</th>
                        <th>PAYMENT METHOD</th>
                        <th>AMOUNT PAID</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredSubscriptions == null || !filteredSubscriptions.Any())
                    {
                        <tr>
                            <td colspan="5" class="no-data">
                                <div class="no-data-content">
                                    <p>No subscriptions found.</p>
                                </div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var sub in filteredSubscriptions)
                        {
                            var fullName = sub.Member != null
                                ? $"{sub.Member.FirstName} {sub.Member.LastName}"
                                : $"Member #{sub.MemberID}";
                            <tr>
                                <td>
                                    <span class="member-name-text">@fullName</span>
                                </td>
                                <td>@sub.Member?.JoinDate.ToString("MM/dd/yyyy")</td>
                                <td>@sub.PaymentDate.ToString("MM/dd/yyyy")</td>
                                <td>@sub.PaymentType</td>
                                <td>₱@sub.Amount.ToString("N2")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (showSubscriptionModal)
{
    <div class="modal-overlay" @onclick="CloseSubscriptionModal">
        <div class="modal-content subscription-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>New Subscription</h2>
                <button class="close-btn" @onclick="CloseSubscriptionModal">×</button>
            </div>

            <div class="modal-body">
                @if (!string.IsNullOrWhiteSpace(generalError))
                {
                    <div class="general-error">
                        ⚠️ @generalError
                    </div>
                }

                <div class="form-section">
                    <h4>Member Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">First Name</label>
                            <input type="text" class="form-control @(GetErrorClass("FirstName"))" @bind="subscriptionMember.FirstName" placeholder="First name" />
                            @DisplayError("FirstName")
                        </div>
                        <div class="form-group">
                            <label>Middle Initial</label>
                            <input type="text" class="form-control" @bind="subscriptionMember.MiddleInitial" maxlength="10" placeholder="M.I." />
                        </div>
                        <div class="form-group">
                            <label class="required">Last Name</label>
                            <input type="text" class="form-control @(GetErrorClass("LastName"))" @bind="subscriptionMember.LastName" placeholder="Last name" />
                            @DisplayError("LastName")
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Contact Number</label>
                            <input type="text"
                                   class="form-control @(GetErrorClass("ContactNumber"))"
                                   @bind-value="ContactNumberInput"
                                   @bind-value:event="oninput"
                                   inputmode="numeric"
                                   pattern="[0-9]*"
                                   maxlength="11"
                                   placeholder="09XXXXXXXXX" />
                            @DisplayError("ContactNumber")
                        </div>
                        <div class="form-group">
                            <label class="required">Email</label>
                            <input type="email" class="form-control @(GetErrorClass("Email"))" @bind="subscriptionMember.Email" placeholder="Enter email address (e.g., name@example.com)" />
                            @DisplayError("Email")
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">Address</label>
                        <textarea class="form-control @(GetErrorClass("Address"))" rows="3" @bind="subscriptionMember.Address" placeholder="Complete address"></textarea>
                        @DisplayError("Address")
                    </div>

                    <!-- Lead Source -->
                    <div class="form-group">
                        <label>How did you hear about us?</label>
                        <div class="select-wrapper">
                            <select class="form-control select-dropdown" @bind="subscriptionMember.LeadSource">
                                <option value="">Select source (optional)</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Referral">Referral (Friend/Family)</option>
                                <option value="Walk-in">Walk-in / Passed by</option>
                                <option value="Promotion">Promotion / Discount</option>
                                <option value="Google">Google Search</option>
                                <option value="Website">Website</option>
                                <option value="Other">Other</option>
                            </select>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Join Date & Time</label>
                            <input type="datetime-local"
                                   class="form-control @(GetErrorClass("JoinDate"))"
                                   @bind="subscriptionJoinDate"
                                   @bind:format="yyyy-MM-ddTHH:mm"
                                   @bind:after="OnJoinDateChanged"
                                   readonly />
                            @DisplayError("JoinDate")
                        </div>
                        <div class="form-group">
                            <label>Assign Trainer (Optional)</label>
                            <div class="select-wrapper">
                                <select class="form-control select-dropdown"
                                        @bind="subscriptionMember.TrainerID"
                                        @bind:after="OnTrainerChanged">
                                    <option value="">No trainer needed</option>
                                    @foreach (var trainer in availableTrainers)
                                    {
                                        <option value="@trainer.TrainerID">@trainer.FullName - @trainer.Specialty</option>
                                    }
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                        </div>
                    </div>

                    @if (subscriptionMember.TrainerID.HasValue)
                    {
                        <div class="form-row">
                            <div class="form-group">
                                <label class="required">Preferred Schedule</label>
                                @if (visibleSchedules.Any())
                                {
                                    <div class="select-wrapper">
                                        <select class="form-control select-dropdown @(GetErrorClass("TrainerScheduleID"))"
                                                @bind="selectedTrainerScheduleId"
                                                @bind:after="OnScheduleChanged">
                                            <option value="0">Select schedule</option>
                                            @foreach (var schedule in visibleSchedules)
                                            {
                                                <option value="@schedule.TrainerScheduleID">@FormatScheduleOption(schedule)</option>
                                            }
                                        </select>
                                        <span class="dropdown-arrow">▼</span>
                                    </div>
                                    @DisplayError("TrainerScheduleID")
                                }
                                else
                                {
                                    <div class="info-box">
                                        <span class="info-icon">ℹ️</span>
                                        <div class="info-content">
                                            <strong>No schedule available</strong>
                                            <p>This trainer has no schedule configured yet.</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="form-section">
                    <h4>Membership Plan</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Membership Type</label>
                            <div class="select-wrapper">
                                <select class="form-control select-dropdown @(GetErrorClass("MembershipTypeID"))" @bind="selectedMembershipTypeId" @bind:after="OnMembershipTypeChanged">
                                    <option value="0">Select membership</option>
                                    @foreach (var type in membershipTypes)
                                    {
                                        <option value="@type.MembershipTypeID">@type.TypeName - ₱@type.Price.ToString("N2") (@type.DurationInDays days)</option>
                                    }
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            @DisplayError("MembershipTypeID")
                        </div>
                        <div class="form-group">
                            <label class="required">Payment Method</label>
                            <div class="select-wrapper">
                                <select class="form-control select-dropdown @(GetErrorClass("PaymentMethod"))" @bind="selectedPaymentMethod">
                                    <option value="Cash">Cash</option>
                                    <option value="Ewallet">Ewallet</option>
                                </select>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            @DisplayError("PaymentMethod")
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Promotion (Optional)</label>
                        <div class="select-wrapper">
                            <select class="form-control select-dropdown" @bind="selectedPromotionId" @bind:after="OnPromotionChanged">
                                <option value="0">No promotion</option>
                                @if (activePromotions != null && activePromotions.Any())
                                {
                                    @foreach (var promo in activePromotions)
                                    {
                                        <option value="@promo.PromoID">@promo.PromoName - @promo.DiscountRate.ToString("F0")% off</option>
                                    }
                                }
                            </select>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        @if (selectedPromotion != null)
                        {
                            <small class="promo-description">@selectedPromotion.Description</small>
                        }
                        @if (activePromotions != null && !activePromotions.Any())
                        {
                            <small class="promo-description" style="color: #999;">No active promotions available</small>
                        }
                    </div>

                    @if (selectedMembershipType != null)
                    {
                        <div class="price-breakdown">
                            <div class="price-row">
                                <span>Original Price:</span>
                                <span class="price-original">₱@(selectedMembershipType.Price.ToString("N2"))</span>
                            </div>
                            @if (selectedPromotion != null && discountAmount > 0)
                            {
                                <div class="price-row discount-row">
                                    <span>Discount (@selectedPromotion.DiscountRate.ToString("F0")%):</span>
                                    <span class="price-discount">-₱@(discountAmount.ToString("N2"))</span>
                                </div>
                            }
                            <div class="price-row total-row">
                                <span><strong>Final Price:</strong></span>
                                <span class="price-final"><strong>₱@(finalPrice.ToString("N2"))</strong></span>
                            </div>
                        </div>
                    }

                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-cancel" @onclick="CloseSubscriptionModal">Cancel</button>
                <button class="btn btn-primary" disabled="@isSaving" @onclick="SaveSubscriptionAsync">
                    @(isSaving ? "Saving..." : "Complete Subscription")
                </button>
            </div>
        </div>
    </div>
}

<style>
    .payments-container {
        padding: 30px;
    }

    .payments-header {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }

    .payments-header h1 {
        margin: 0;
        font-size: 26px;
        color: #233347;
    }

    .subtitle {
        margin: 6px 0 0 0;
        color: #6b7a8a;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .primary-btn {
        background: #5cb85c;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .primary-btn:hover {
        background: #4aac4a;
        box-shadow: 0 8px 20px rgba(92,184,92,0.35);
        transform: translateY(-1px);
    }

    .payments-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 25px;
    }

    .info-card {
        background: #fff;
        border-radius: 10px;
        padding: 22px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .subscriptions-table {
        overflow-x: auto;
    }

    /* Shared datatable styles to match Members page */
    .search-bar {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        width: 250px;
        font-size: 14px;
        transition: all 0.3s;
    }

        .search-bar:focus {
            outline: none;
            border-color: #5cb85c;
            box-shadow: 0 0 0 3px rgba(92, 184, 92, 0.1);
        }

    .table-container {
        margin: 0;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow-x: auto;
        overflow-y: auto;
        max-height: calc(100vh - 250px);
        position: relative;
    }

    .table-toolbar {
        display: flex;
        align-items: center;
        padding: 12px 16px 8px 16px;
        margin-bottom: 4px;
        gap: 12px;
        flex-wrap: wrap;
    }

        .table-toolbar .search-bar {
            margin-left: auto;
        }

    .payments-filters {
        align-items: flex-end;
        padding: 12px 16px 8px 16px;
        background: #ffffff;
    }

    .toolbar-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-label {
        font-weight: 600;
        color: #234060;
        font-size: 14px;
    }

    .period-select,
    .date-input {
        height: 36px;
        border: 1px solid #dcdfe5;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 14px;
    }

    .date-input {
        min-width: 150px;
    }

    .payments-filters .search-bar {
        min-width: 260px;
    }

    .table-title {
        font-size: 16px;
        font-weight: 600;
        color: #234060;
    }

    .members-table {
        width: 100%;
        border-collapse: collapse;
    }

        .members-table thead {
            background: #234060;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .members-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #1a3450;
        }

        .members-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            vertical-align: middle;
            font-size: 14px;
        }

        .members-table tbody tr {
            transition: background 0.2s;
        }

            .members-table tbody tr:hover {
                background: #f8f9fa;
            }

    .member-name-text {
        color: #1f2b3d;
        font-size: 14px;
    }

    .info-card h3,
    .placeholder-card h3 {
        margin: 0 0 12px 0;
        color: #233347;
    }

    .info-card ul {
        padding-left: 18px;
        margin: 0;
        color: #4c5b6c;
        line-height: 1.6;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 20px;
    }

    .modal-content {
        width: 95%;
        max-width: 900px;
        background: white;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        max-height: 95vh;
        overflow: hidden;
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .close-btn {
        background: transparent;
        border: none;
        font-size: 32px;
        color: #777;
        cursor: pointer;
        line-height: 1;
    }

    .close-btn:hover {
        color: #000;
    }

    .form-section {
        margin-bottom: 30px;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
        margin-bottom: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    margin-bottom: 12px;
    }

    .form-group label {
        font-weight: 600;
        font-size: 14px;
        color: #2d3b4f;
    }

    .required::after {
        content: "*";
        color: #e74c3c;
        margin-left: 3px;
    }

    .form-control {
        border: 1px solid #dcdfe5;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
        font-family: inherit;
    }

    .form-control:focus {
        border-color: #4aac4a;
        box-shadow: 0 0 0 3px rgba(92,184,92,0.12);
        outline: none;
    }

    .form-control.error {
        border-color: #e74c3c;
        box-shadow: 0 0 0 2px rgba(231,76,60,0.15);
    }

    textarea.form-control {
        resize: vertical;
    }

    .select-wrapper {
        position: relative;
        overflow: visible;
    }

    .select-dropdown {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 100%;
        background: white;
        padding-right: 35px;
        box-sizing: border-box;
        border: 1px solid #dcdfe5 !important;
        border-radius: 8px;
    }

    .select-dropdown:focus {
        border-color: #4aac4a !important;
        box-shadow: 0 0 0 3px rgba(92,184,92,0.12);
        outline: none;
    }

    .select-dropdown.error {
        border-color: #e74c3c !important;
        box-shadow: 0 0 0 2px rgba(231,76,60,0.15);
    }

    .dropdown-arrow {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: #777;
        font-size: 12px;
        z-index: 1;
        background: white;
        padding-left: 4px;
    }

    .btn {
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-cancel {
        background: #f3f4f6;
        color: #555;
    }

    .btn-cancel:hover {
        background: #e3e5e9;
    }

    .btn-primary {
        background: #5cb85c;
        color: white;
    }

    .btn-primary:hover:not([disabled]) {
        background: #49a949;
        box-shadow: 0 8px 20px rgba(92,184,92,0.35);
    }

    .btn-primary[disabled] {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .field-error {
        font-size: 12px;
        color: #d35400;
    }

    .general-error {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 10px 14px;
        border-radius: 8px;
        color: #856404;
        margin-bottom: 15px;
    }

    .promo-description {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #666;
        font-style: italic;
    }

    .price-breakdown {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }

    .price-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .price-row:last-child {
        border-bottom: none;
        margin-top: 5px;
        padding-top: 12px;
        border-top: 2px solid #dee2e6;
    }

    .price-original {
        color: #666;
        text-decoration: line-through;
    }

    .price-discount {
        color: #5cb85c;
        font-weight: 600;
    }

    .price-final {
        color: #234060;
        font-size: 1.1em;
    }

    .total-row {
        font-size: 1.05em;
    }

    .payments-table-section {
        margin-top: 25px;
    }

    @@media (max-width: 640px) {
        .payments-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private List<MembershipTypeModel> membershipTypes = new();
    private List<TrainerModel> availableTrainers = new();
    private List<TrainerScheduleModel> trainerSchedules = new();
    private List<TrainerScheduleModel> visibleSchedules = new();
    private List<Promotion> activePromotions = new();
    private MemberModel subscriptionMember = new();
    private DateTime subscriptionJoinDate = DateTime.Today;
    private DateTime? subscriptionExpiration;
    private int selectedMembershipTypeId;
    private MembershipTypeModel? selectedMembershipType;
    private string selectedPaymentMethod = "Cash";
    private int selectedTrainerScheduleId;
    private int selectedPromotionId = 0;
    private Promotion? selectedPromotion;
    private decimal discountAmount = 0;
    private decimal finalPrice = 0;
    private bool showSubscriptionModal;
    private bool isSaving;
    private string? generalError;
    private readonly Dictionary<string, string> fieldErrors = new();
    private List<PaymentModel> recentSubscriptions = new();
    private List<PaymentModel> filteredSubscriptions = new();
    private string paymentsSearchQuery = string.Empty;
    private string paymentsSelectedPeriod = "today";
    private DateTime? paymentsCustomStartDate = DateTime.Today;
    private DateTime? paymentsCustomEndDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceDataAsync();
        await LoadRecentSubscriptionsAsync();
    }

    private async Task LoadReferenceDataAsync()
    {
        membershipTypes = await Context.MembershipTypes
            .Where(mt => !mt.IsArchived)
            .OrderBy(mt => mt.TypeName)
            .ToListAsync();

        availableTrainers = await Context.Trainers
            .AsNoTracking()
            .OrderBy(t => t.LastName)
            .ThenBy(t => t.FirstName)
            .ToListAsync();

        trainerSchedules = await Context.TrainerSchedules
            .AsNoTracking()
            .Include(ts => ts.Trainer)
            .Where(ts => ts.IsAvailable)
            .OrderBy(ts => ts.DayOfWeek)
            .ThenBy(ts => ts.StartTime)
            .ToListAsync();

        await LoadActivePromotions();
    }

    private async Task LoadRecentSubscriptionsAsync()
    {
        // Load latest payments with their members for the summary table
        // Then collapse exact-duplicate payments (same member, same date, same amount, same method) in memory.
        // Doing the GroupBy client-side avoids LINQ-to-SQL translation issues with Date and anonymous keys.

        // First, load a reasonable window of recent payments from the database
        var rawPayments = await Context.Payments
            .Include(p => p.Member)
            .AsNoTracking()
            .OrderByDescending(p => p.PaymentDate)
            .Take(200) // load more than we need, we'll collapse then keep the latest 50
            .ToListAsync();

        // Now collapse duplicates in memory
        recentSubscriptions = rawPayments
            .GroupBy(p => new
            {
                p.MemberID,
                Date = p.PaymentDate.Date,
                p.Amount,
                p.PaymentType
            })
            .Select(g => g
                .OrderByDescending(p => p.PaymentDate) // keep the latest time for that day
                .First())
            .OrderByDescending(p => p.PaymentDate)
            .Take(50)
            .ToList();

        ApplyPaymentsFilter();
    }

    private async Task LoadActivePromotions()
    {
        try
        {
            var today = DateTime.Today;
            // Show promotions that haven't expired yet (EndDate >= today)
            // This includes both active and upcoming promotions
            activePromotions = await Context.Promotions
                .AsNoTracking()
                .Where(p => p.EndDate >= today)
                .OrderByDescending(p => p.DiscountRate)
                .ThenByDescending(p => p.StartDate)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            // Promotions table might not exist yet or there's an error
            System.Diagnostics.Debug.WriteLine($"Error loading promotions: {ex.Message}");
            activePromotions = new List<Promotion>();
        }
    }

    private async void OpenSubscriptionModal()
    {
        subscriptionMember = new MemberModel
        {
            FirstName = string.Empty,
            LastName = string.Empty,
            ContactNumber = string.Empty,
            Email = string.Empty,
            Address = string.Empty,
            Status = "Active"
        };

        subscriptionJoinDate = DateTime.Now;
        subscriptionExpiration = null;
        selectedMembershipTypeId = 0;
        selectedMembershipType = null;
        selectedPaymentMethod = "Cash";
        selectedTrainerScheduleId = 0;
        selectedPromotionId = 0;
        selectedPromotion = null;
        discountAmount = 0;
        finalPrice = 0;
        subscriptionMember.TrainerID = null;
        subscriptionMember.TrainerScheduleID = null;
        visibleSchedules = new();
        generalError = null;
        fieldErrors.Clear();
        await LoadActivePromotions();
        showSubscriptionModal = true;
        StateHasChanged();
    }

    private void OnPaymentsSearchChanged(ChangeEventArgs e)
    {
        paymentsSearchQuery = e.Value?.ToString() ?? string.Empty;
        ApplyPaymentsFilter();
    }

    private void OnPaymentsPeriodChanged()
    {
        ApplyPaymentsFilter();
    }

    private (DateTime start, DateTime end) GetPaymentsDateRange()
    {
        var today = DateTime.Today;

        return paymentsSelectedPeriod switch
        {
            "today" => (today, today.AddDays(1).AddSeconds(-1)),
            "yesterday" => (today.AddDays(-1), today.AddSeconds(-1)),
            "week" => (today.AddDays(-(int)today.DayOfWeek), today.AddDays(1).AddSeconds(-1)),
            "month" => (new DateTime(today.Year, today.Month, 1), today.AddDays(1).AddSeconds(-1)),
            "year" => (new DateTime(today.Year, 1, 1), today.AddDays(1).AddSeconds(-1)),
            "custom" => ((paymentsCustomStartDate ?? today), (paymentsCustomEndDate ?? today.AddDays(1).AddSeconds(-1))),
            _ => (today, today.AddDays(1).AddSeconds(-1))
        };
    }

    private void ApplyPaymentsFilter()
    {
        if (recentSubscriptions == null)
        {
            filteredSubscriptions = new List<PaymentModel>();
            return;
        }

        var (start, end) = GetPaymentsDateRange();

        var query = recentSubscriptions.Where(p =>
        {
            var joinDate = p.Member?.JoinDate.Date ?? DateTime.MinValue;
            return joinDate >= start && joinDate <= end;
        });

        var term = (paymentsSearchQuery ?? string.Empty).Trim().ToLower();
        if (!string.IsNullOrEmpty(term))
        {
            query = query.Where(p =>
            {
                var name = p.Member != null
                    ? $"{p.Member.FirstName} {p.Member.LastName}"
                    : $"Member #{p.MemberID}";
                var paymentType = p.PaymentType ?? string.Empty;
                return name.ToLower().Contains(term) ||
                       paymentType.ToLower().Contains(term);
            });
        }

        filteredSubscriptions = query.ToList();
    }

    private void CloseSubscriptionModal()
    {
        if (isSaving)
            return;

        showSubscriptionModal = false;
    }

    private async Task SaveSubscriptionAsync()
    {
        if (isSaving)
            return;

        generalError = null;
        fieldErrors.Clear();

        if (!ValidateForm())
            return;

        try
        {
            isSaving = true;

            subscriptionMember.JoinDate = subscriptionJoinDate;
            subscriptionMember.ExpirationDate = subscriptionExpiration;
            subscriptionMember.MembershipTypeID = selectedMembershipTypeId;
            if (subscriptionMember.TrainerID.HasValue && selectedTrainerScheduleId > 0)
            {
                subscriptionMember.TrainerScheduleID = selectedTrainerScheduleId;
            }
            else
            {
                subscriptionMember.TrainerScheduleID = null;
                subscriptionMember.TrainerID = null;
            }

            Context.Members.Add(subscriptionMember);
            await Context.SaveChangesAsync();

            // Use final price (with discount if promotion applied)
            var paymentAmount = finalPrice > 0 ? finalPrice : (selectedMembershipType?.Price ?? 0);

            // Prevent duplicate payments for the same member / amount / method on the same day
            var today = DateTime.Today;
            var existingPayment = await Context.Payments
                .AsNoTracking()
                .FirstOrDefaultAsync(p =>
                    p.MemberID == subscriptionMember.MemberID &&
                    p.PaymentType == selectedPaymentMethod &&
                    p.Amount == paymentAmount &&
                    p.PaymentDate.Date == today);

            if (existingPayment == null)
            {
                var payment = new PaymentModel
                {
                    MemberID = subscriptionMember.MemberID,
                    Amount = paymentAmount,
                    PaymentDate = DateTime.Now,
                    PaymentType = selectedPaymentMethod
                };

                Context.Payments.Add(payment);
                await Context.SaveChangesAsync();
            }

            // Save promotion usage if a promotion was selected
            if (selectedPromotion != null && selectedPromotionId > 0)
            {
                try
                {
                    var memberPromo = new MemberPromo
                    {
                        MemberID = subscriptionMember.MemberID,
                        PromotionID = selectedPromotion.PromoID,
                        DateUsed = DateTime.Now
                    };
                    Context.MemberPromos.Add(memberPromo);
                    await Context.SaveChangesAsync();
                }
                catch (Exception ex)
                {
                    // Log error but don't fail the subscription
                    System.Diagnostics.Debug.WriteLine($"Error saving promotion usage: {ex.Message}");
                }
            }

            await LoadRecentSubscriptionsAsync();

            showSubscriptionModal = false;
            var promoMessage = selectedPromotion != null 
                ? $" with {selectedPromotion.DiscountRate}% discount" 
                : "";
            ToastService.ShowSuccess($"Subscription created for {subscriptionMember.FullName}{promoMessage}.");
        }
        catch (Exception ex)
        {
            generalError = $"Unable to save subscription: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private bool ValidateForm()
    {
        void AddError(string key, string message) => fieldErrors[key] = message;

        if (string.IsNullOrWhiteSpace(subscriptionMember.FirstName))
            AddError("FirstName", "First name is required.");

        if (string.IsNullOrWhiteSpace(subscriptionMember.LastName))
            AddError("LastName", "Last name is required.");

        if (string.IsNullOrWhiteSpace(subscriptionMember.ContactNumber))
            AddError("ContactNumber", "Contact number is required.");
        else
        {
            var digitsOnly = new string(subscriptionMember.ContactNumber.Where(char.IsDigit).ToArray());
            if (digitsOnly.Length != 11)
                AddError("ContactNumber", "Contact number must be 11 digits.");
            else
                subscriptionMember.ContactNumber = digitsOnly;
        }

        if (string.IsNullOrWhiteSpace(subscriptionMember.Email))
            AddError("Email", "Email is required.");
        else
        {
            // Validate email format - must contain @ symbol and domain
            var email = subscriptionMember.Email.Trim();
            if (!email.Contains("@") || email.IndexOf("@") == 0 || email.IndexOf("@") == email.Length - 1)
            {
                // Email must have @ symbol, and it can't be at the start or end
                AddError("Email", "Please enter a valid email address with @ symbol and domain (e.g., name@example.com, not just 'gmail' or 'name')");
            }
            else
            {
                // Split by @ and check domain part exists
                var parts = email.Split('@');
                if (parts.Length != 2 || string.IsNullOrWhiteSpace(parts[0]) || string.IsNullOrWhiteSpace(parts[1]))
                {
                    AddError("Email", "Please enter a valid email address with @ symbol and domain (e.g., name@example.com, not just 'gmail' or 'name')");
                }
                else
                {
                    // Check if domain part contains at least a dot (e.g., gmail.com)
                    if (!parts[1].Contains("."))
                    {
                        AddError("Email", "Please enter a valid email address with @ symbol and domain (e.g., name@example.com, not just 'gmail' or 'name')");
                    }
                    else
                    {
                        // Final validation using EmailAddressAttribute
                        var emailAttribute = new EmailAddressAttribute();
                        if (!emailAttribute.IsValid(email))
                        {
                            AddError("Email", "Please enter a valid email address with @ symbol and domain (e.g., name@example.com, not just 'gmail' or 'name')");
                        }
                    }
                }
            }
        }

        if (string.IsNullOrWhiteSpace(subscriptionMember.Address))
            AddError("Address", "Address is required.");

        if (subscriptionJoinDate == DateTime.MinValue)
            AddError("JoinDate", "Join date is required.");

        if (selectedMembershipTypeId <= 0)
            AddError("MembershipTypeID", "Please select a membership type.");

        if (string.IsNullOrWhiteSpace(selectedPaymentMethod))
            AddError("PaymentMethod", "Please select a payment method.");

        if (subscriptionMember.TrainerID.HasValue && selectedTrainerScheduleId <= 0)
            AddError("TrainerScheduleID", "Please choose a schedule for the trainer.");

        if (selectedMembershipType == null && selectedMembershipTypeId > 0)
        {
            selectedMembershipType = membershipTypes.FirstOrDefault(mt => mt.MembershipTypeID == selectedMembershipTypeId);
        }

        if (selectedMembershipType != null && subscriptionJoinDate != DateTime.MinValue)
        {
            subscriptionExpiration = subscriptionJoinDate.AddDays(selectedMembershipType.DurationInDays);
        }

        OnScheduleChanged();

        return fieldErrors.Count == 0;
    }

    private void OnMembershipTypeChanged()
    {
        selectedMembershipType = membershipTypes.FirstOrDefault(mt => mt.MembershipTypeID == selectedMembershipTypeId);
        if (selectedMembershipType != null && subscriptionJoinDate != DateTime.MinValue)
        {
            subscriptionExpiration = subscriptionJoinDate.AddDays(selectedMembershipType.DurationInDays);
        }
        else
        {
            subscriptionExpiration = null;
        }
        CalculatePrice();
    }

    private void OnPromotionChanged()
    {
        selectedPromotion = activePromotions.FirstOrDefault(p => p.PromoID == selectedPromotionId);
        CalculatePrice();
    }

    private void CalculatePrice()
    {
        if (selectedMembershipType == null)
        {
            finalPrice = 0;
            discountAmount = 0;
            return;
        }

        var originalPrice = selectedMembershipType.Price;
        
        if (selectedPromotion != null && selectedPromotion.DiscountRate > 0)
        {
            discountAmount = originalPrice * (selectedPromotion.DiscountRate / 100);
            finalPrice = originalPrice - discountAmount;
        }
        else
        {
            discountAmount = 0;
            finalPrice = originalPrice;
        }
        
        StateHasChanged();
    }

    private void OnJoinDateChanged()
    {
        if (selectedMembershipType != null)
        {
            subscriptionExpiration = subscriptionJoinDate.AddDays(selectedMembershipType.DurationInDays);
        }
    }

    private void OnTrainerChanged()
    {
        if (subscriptionMember.TrainerID.HasValue)
        {
            visibleSchedules = trainerSchedules
                .Where(ts => ts.TrainerID == subscriptionMember.TrainerID.Value)
                .ToList();
            selectedTrainerScheduleId = 0;
        }
        else
        {
            visibleSchedules = new();
            selectedTrainerScheduleId = 0;
            subscriptionMember.TrainerScheduleID = null;
        }
    }

    private void OnScheduleChanged()
    {
        if (selectedTrainerScheduleId > 0)
        {
            var schedule = trainerSchedules.FirstOrDefault(ts => ts.TrainerScheduleID == selectedTrainerScheduleId);
            if (schedule != null)
            {
                subscriptionMember.TrainerScheduleID = schedule.TrainerScheduleID;
            }
        }
        else
        {
            subscriptionMember.TrainerScheduleID = null;
        }
    }

    private string GetErrorClass(string field) => fieldErrors.ContainsKey(field) ? "error" : string.Empty;

    private RenderFragment DisplayError(string field) => builder =>
    {
        if (fieldErrors.TryGetValue(field, out var message))
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "field-error");
            builder.AddContent(2, message);
            builder.CloseElement();
        }
    };

    private string ContactNumberInput
    {
        get => subscriptionMember.ContactNumber;
        set
        {
            var digits = new string((value ?? string.Empty).Where(char.IsDigit).Take(11).ToArray());
            subscriptionMember.ContactNumber = digits;
        }
    }

    private string FormatScheduleOption(TrainerScheduleModel schedule)
    {
        var day = Enum.GetName(typeof(DayOfWeek), schedule.DayOfWeek) ?? $"Day {schedule.DayOfWeek}";
        var start = DateTime.Today.Add(schedule.StartTime).ToString("hh\\:mm tt");
        var end = DateTime.Today.Add(schedule.EndTime).ToString("hh\\:mm tt");
        var trainerName = schedule.Trainer?.FullName ?? $"Trainer #{schedule.TrainerID}";
        return $"{trainerName} - {day} {start} - {end}";
    }
}

