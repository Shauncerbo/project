@page "/administration/restore"
@layout MainLayout
@using System.Linq
@using System.Collections.Generic
@using System.Threading.Tasks
@inject IJSRuntime JSRuntime
@inject AppDbContext Context
@inject project.Services.IAuthService AuthService
@using project.Data
@using project.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.Maui.Storage

<div class="settings-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Restore Accounts</h1>
        <p class="page-subtitle">Restore archived staff/trainer accounts to make them active again.</p>
    </div>

    <div class="account-management-card">
        @if (accountIsLoading)
        {
            <div class="account-loading">Loading archived accounts...</div>
        }
        else if (archivedUsers == null || !archivedUsers.Any())
        {
            <div class="empty-state">
                <h3>No Accounts to Restore</h3>
                <p>There are no archived accounts available to restore.</p>
            </div>
        }
        else
        {
            <div class="table-container">
                <table class="archived-table">
                    <thead>
                        <tr>
                            <th>USERNAME</th>
                            <th>ROLE</th>
                            <th>ARCHIVED ON</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in archivedUsers)
                        {
                            <tr>
                                <td>@user.Username</td>
                                <td>@user.Role?.RoleName</td>
                                <td>@(user.UpdatedAt.HasValue ? user.UpdatedAt.Value.ToString("MMM dd, yyyy") : "-")</td>
                                <td class="account-actions">
                                    <button class="btn-restore" @onclick="() => RestoreAccount(user)">
                                        <span class="restore-icon">↩️</span> Restore
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<style>
    .settings-container {
        padding: 30px;
        background: white;
        min-height: 100vh;
    }

    .page-header {
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #234060;
        margin: 0 0 8px 0;
    }

    .page-subtitle {
        color: #666;
        font-size: 14px;
        margin: 0;
    }

    .account-management-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 25px;
        margin-bottom: 20px;
    }

    .account-loading {
        padding: 16px;
        color: #555;
    }

    .account-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .table-container {
        overflow-x: auto;
    }

    .archived-table {
        width: 100%;
        border-collapse: collapse;
    }

    .archived-table thead {
        background: #234060;
        color: white;
    }

    .archived-table th {
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .archived-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
    }

    .archived-table tbody tr:hover {
        background: #f8f9fa;
    }

    .btn-restore {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: #FFA500;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-restore:hover {
        background: #ff8c00;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255,165,0,0.3);
    }

    .restore-icon {
        font-size: 16px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state h3 {
        font-size: 20px;
        font-weight: 600;
        color: #666;
        margin: 0 0 8px 0;
    }

    .empty-state p {
        font-size: 14px;
        color: #999;
        margin: 0;
    }
</style>

@code {
    private List<User> archivedUsers = new();
    private bool accountIsLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadArchivedAccounts();
    }

    private async Task LoadArchivedAccounts()
    {
        accountIsLoading = true;
        StateHasChanged();

        try
        {
            var availableRoles = await Context.Roles
                .Where(r => r.RoleName == "Staff" || r.RoleName == "Trainer")
                .Select(r => r.RoleID)
                .ToListAsync();

            var managedUsers = await Context.Users
                .Include(u => u.Role)
                .Where(u => availableRoles.Contains(u.RoleID))
                .OrderBy(u => u.Username)
                .ToListAsync();

            archivedUsers = managedUsers.Where(u => u.IsActive == false).ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading archived accounts: {ex.Message}");
        }
        finally
        {
            accountIsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RestoreAccount(User user)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"Restore account '{user.Username}'? This will make the account active again.");
        if (!confirm)
            return;

        try
        {
            user.IsActive = true;
            user.UpdatedAt = DateTime.Now;
            Context.Users.Update(user);
            await Context.SaveChangesAsync();
            await LogAuditAction("Account Restored", "User", user.UserID, user.Username, $"Restored account: {user.Username}");
            await LoadArchivedAccounts();
            await JSRuntime.InvokeVoidAsync("alert", $"Account '{user.Username}' restored successfully!");
        }
        catch (Exception ex)
        {
            await LogAuditAction("Account Restore Failed", "User", user.UserID, user.Username, $"Failed to restore account: {ex.Message}", "Failed", ex.Message);
            await JSRuntime.InvokeVoidAsync("alert", $"Error restoring account: {ex.Message}");
        }
    }

    private async Task LogAuditAction(string action, string entityType, int? entityID, string entityName, string description, string status = "Success", string errorMessage = "")
    {
        try
        {
            var username = await AuthService.GetCurrentUsername();
            var userId = await AuthService.GetCurrentUserId();

            var auditLog = new AuditLog
            {
                Action = action,
                EntityType = entityType,
                EntityID = entityID,
                EntityName = entityName,
                PerformedBy = username,
                PerformedByUserID = userId,
                Description = description,
                Timestamp = DateTime.Now,
                Status = status,
                ErrorMessage = errorMessage
            };

            Context.AuditLogs.Add(auditLog);
            await Context.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error logging audit action: {ex.Message}");
        }
    }
}

