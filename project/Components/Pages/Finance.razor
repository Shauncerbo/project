@page "/finance"
@layout MainLayout
@using project.Data
@using project.Models
@using Microsoft.EntityFrameworkCore
@using project.Services
@inject AppDbContext Context
@inject IToastService ToastService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<div class="finance-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Capital & Investments</h1>
            <p class="page-subtitle">Manage owner's capital and equipment investments</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <h3>TOTAL OWNER'S CAPITAL</h3>
            <div class="summary-card-content">
                <p class="summary-amount">₱@totalCapital.ToString("N2")</p>
            </div>
        </div>
        <div class="summary-card">
            <h3>TOTAL EQUIPMENT VALUE</h3>
            <div class="summary-card-content">
                <p class="summary-amount">₱@totalInvestment.ToString("N2")</p>
            </div>
        </div>
        <div class="summary-card">
            <h3>TOTAL LIABILITIES</h3>
            <div class="summary-card-content">
                <p class="summary-amount">₱@totalLiability.ToString("N2")</p>
            </div>
        </div>
        <div class="summary-card">
            <h3>NET WORTH</h3>
            <div class="summary-card-content">
                <p class="summary-amount">₱@((totalCapital + totalInvestment - totalLiability).ToString("N2"))</p>
            </div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="finance-sections">
        <!-- Owner's Capital Section -->
        <div class="finance-section">
            <div class="section-header">
                <h2>Owner's Capital</h2>
                <button class="add-btn" @onclick="OpenAddCapitalModal">+ Add Capital</button>
            </div>
            <div class="table-container">
                <table class="finance-table">
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>DESCRIPTION</th>
                            <th style="text-align: right;">AMOUNT</th>
                            <th style="text-align: center;">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (capitals == null || !capitals.Any())
                        {
                            <tr>
                                <td colspan="4" class="no-data">
                                    <div class="no-data-content">
                                        <p>No capital entries found</p>
                                    </div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var capital in capitals.OrderByDescending(c => c.DateAdded))
                            {
                                <tr>
                                    <td>@capital.DateAdded.ToString("MMM dd, yyyy")</td>
                                    <td>@(capital.Description ?? "Owner's Capital")</td>
                                    <td class="amount-cell">₱@capital.Amount.ToString("N2")</td>
                                    <td style="text-align: center;">
                                        <div class="action-buttons">
                                            <button class="action-btn archive-btn" @onclick="() => ShowArchiveCapitalConfirmation(capital)" title="Archive">
                                                <img src="/archived_icon.svg" class="action-icon" alt="Archive" />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Equipment & Assets Section -->
        <div class="finance-section">
            <div class="section-header">
                <h2>Equipment & Assets</h2>
                <button class="add-btn" @onclick="OpenAddInvestmentModal">+ Add Equipment</button>
            </div>
            <div class="table-container">
                <table class="finance-table">
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>NAME</th>
                            <th>DESCRIPTION</th>
                            <th style="text-align: center;">QUANTITY</th>
                            <th style="text-align: right;">UNIT PRICE</th>
                            <th style="text-align: right;">TOTAL COST</th>
                            <th style="text-align: center;">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (investments == null || !investments.Any())
                        {
                            <tr>
                                <td colspan="7" class="no-data">
                                    <div class="no-data-content">
                                        <p>No equipment entries found</p>
                                    </div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var investment in investments.OrderByDescending(i => i.Date))
                            {
                                var totalCost = investment.Price * investment.Quantity;
                                <tr>
                                    <td>@investment.Date.ToString("MMM dd, yyyy")</td>
                                    <td><strong>@investment.Name</strong></td>
                                    <td style="max-width: 300px; word-wrap: break-word; line-height: 1.5;">@(investment.Description ?? "-")</td>
                                    <td style="text-align: center;">@investment.Quantity</td>
                                    <td class="amount-cell">₱@investment.Price.ToString("N2")</td>
                                    <td class="amount-cell">₱@totalCost.ToString("N2")</td>
                                    <td style="text-align: center;">
                                        <div class="action-buttons">
                                            <button class="action-btn edit-btn" @onclick="() => EditInvestment(investment)" title="Edit">
                                                <img src="/Newedit_icon.svg" class="action-icon" alt="Edit" />
                                            </button>
                                            <button class="action-btn archive-btn" @onclick="() => ShowArchiveConfirmation(investment)" title="Archive">
                                                <img src="/archived_icon.svg" class="action-icon" alt="Archive" />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Liabilities Section -->
    <div class="finance-section" style="margin-top: 30px;">
        <div class="section-header">
            <h2>Liabilities</h2>
            <button class="add-btn" @onclick="OpenAddLiabilityModal">+ Add Liability</button>
        </div>
        <div class="table-container">
            <table class="finance-table">
                <thead>
                    <tr>
                        <th>DATE</th>
                        <th>NAME</th>
                        <th>TYPE</th>
                        <th>DESCRIPTION</th>
                        <th>DUE DATE</th>
                        <th style="text-align: right;">AMOUNT</th>
                        <th style="text-align: center;">STATUS</th>
                        <th style="text-align: center;">ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    @if (liabilities == null || !liabilities.Any())
                    {
                        <tr>
                            <td colspan="8" class="no-data">
                                <div class="no-data-content">
                                    <p>No liabilities found</p>
                                </div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var liability in liabilities.OrderByDescending(l => l.Date))
                        {
                            <tr style="@(liability.IsPaid ? "opacity: 0.6;" : "")">
                                <td>@liability.Date.ToString("MMM dd, yyyy")</td>
                                <td><strong>@liability.Name</strong></td>
                                <td><span style="padding: 4px 8px; background: #f0f0f0; border-radius: 4px; font-size: 12px;">@liability.LiabilityType</span></td>
                                <td style="max-width: 200px; word-wrap: break-word;">@(liability.Description ?? "-")</td>
                                <td>@(liability.DueDate.HasValue ? liability.DueDate.Value.ToString("MMM dd, yyyy") : "-")</td>
                                <td class="amount-cell" style="color: #dc3545;">₱@liability.Amount.ToString("N2")</td>
                                <td style="text-align: center;">
                                    @if (liability.IsPaid)
                                    {
                                        <span style="padding: 4px 10px; background: #d4edda; color: #155724; border-radius: 4px; font-size: 12px; font-weight: 600;">PAID</span>
                                    }
                                    else
                                    {
                                        <span style="padding: 4px 10px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 12px; font-weight: 600;">UNPAID</span>
                                    }
                                </td>
                                <td style="text-align: center;">
                                    <div class="action-buttons">
                                        @if (!liability.IsPaid)
                                        {
                                            <button class="action-btn" style="background: #5cb85c;" @onclick="() => MarkLiabilityAsPaid(liability)" title="Mark as Paid">
                                                <span style="color: white; font-size: 14px;">✓</span>
                                            </button>
                                        }
                                        <button class="action-btn edit-btn" @onclick="() => EditLiability(liability)" title="Edit">
                                            <img src="/Newedit_icon.svg" class="action-icon" alt="Edit" />
                                        </button>
                                        <button class="action-btn archive-btn" @onclick="() => ShowArchiveLiabilityConfirmation(liability)" title="Delete">
                                            <img src="/archived_icon.svg" class="action-icon" alt="Delete" />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Liability Modal -->
@if (showLiabilityModal)
{
    <div class="modal-overlay" @onclick="CloseLiabilityModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(isEditLiability ? "Edit Liability" : "Add Liability")</h2>
                <button class="close-btn" @onclick="CloseLiabilityModal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="required">Date</label>
                    <input type="date" class="form-control @(HasError("LiabilityDate") ? "error" : "")" @bind="currentLiability.Date" @bind:format="yyyy-MM-dd" />
                    @if (HasError("LiabilityDate"))
                    {
                        <div class="error-message">Date is required</div>
                    }
                </div>
                <div class="form-group">
                    <label class="required">Name</label>
                    <input type="text" class="form-control @(HasError("LiabilityName") ? "error" : "")" @bind="currentLiability.Name" placeholder="Enter liability name (e.g., Bank Loan, Supplier Payable)" />
                    @if (HasError("LiabilityName"))
                    {
                        <div class="error-message">Name is required</div>
                    }
                </div>
                <div class="form-group">
                    <label class="required">Type</label>
                    <select class="form-control" @bind="currentLiability.LiabilityType">
                        <option value="Loan">Loan</option>
                        <option value="Payable">Payable</option>
                        <option value="Debt">Debt</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" @bind="currentLiability.Description" placeholder="Enter description (optional)" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="required">Amount (₱)</label>
                    <input type="number" step="0.01" min="0" class="form-control @(HasError("LiabilityAmount") ? "error" : "")" @bind="currentLiability.Amount" placeholder="Enter amount" />
                    @if (HasError("LiabilityAmount"))
                    {
                        <div class="error-message">Amount must be greater than 0</div>
                    }
                </div>
                <div class="form-group">
                    <label>Due Date (Optional)</label>
                    <input type="date" class="form-control" @bind="currentLiability.DueDate" @bind:format="yyyy-MM-dd" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" @onclick="CloseLiabilityModal">Cancel</button>
                <button class="btn btn-save" @onclick="SaveLiability">@(isEditLiability ? "Update Liability" : "Save Liability")</button>
            </div>
        </div>
    </div>
}

<!-- Archive Liability Confirmation Modal -->
@if (showArchiveLiabilityConfirmation)
{
    <div class="modal-overlay" @onclick="CloseArchiveLiabilityConfirmation">
        <div class="modal-content confirmation-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
                <button class="close-btn" @onclick="CloseArchiveLiabilityConfirmation">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this liability?</p>
                <p class="confirmation-warning">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" @onclick="CloseArchiveLiabilityConfirmation">Cancel</button>
                <button class="btn btn-danger" @onclick="ConfirmArchiveLiability">Yes, Delete</button>
            </div>
        </div>
    </div>
}

<!-- Add Capital Modal -->
@if (showCapitalModal)
{
    <div class="modal-overlay" @onclick="CloseCapitalModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Add Owner's Capital</h2>
                <button class="close-btn" @onclick="CloseCapitalModal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="required">Date</label>
                    <input type="date" class="form-control @(HasError("CapitalDate") ? "error" : "")" @bind="currentCapital.DateAdded" @bind:format="yyyy-MM-dd" />
                    @if (HasError("CapitalDate"))
                    {
                        <div class="error-message">Date is required</div>
                    }
                </div>
                <div class="form-group">
                    <label class="required">Description</label>
                    <input type="text" class="form-control @(HasError("CapitalDescription") ? "error" : "")" @bind="currentCapital.Description" placeholder="Enter description" />
                    @if (HasError("CapitalDescription"))
                    {
                        <div class="error-message">Description is required</div>
                    }
                </div>
                <div class="form-group">
                    <label class="required">Amount (₱)</label>
                    <input type="number" step="0.01" min="0" class="form-control @(HasError("CapitalAmount") ? "error" : "")" @bind="currentCapital.Amount" placeholder="Enter amount" />
                    @if (HasError("CapitalAmount"))
                    {
                        <div class="error-message">Amount must be greater than 0</div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" @onclick="CloseCapitalModal">Cancel</button>
                <button class="btn btn-save" @onclick="SaveCapital">Save Capital</button>
            </div>
        </div>
    </div>
}

<!-- Add/Edit Equipment Modal -->
@if (showInvestmentModal)
{
    <div class="modal-overlay" @onclick="CloseInvestmentModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(isEditInvestment ? "Edit Gym Equipment" : "Add Gym Equipment")</h2>
                <button class="close-btn" @onclick="CloseInvestmentModal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="required">Date</label>
                    <input type="date" class="form-control @(HasError("InvestmentDate") ? "error" : "")" @bind="currentInvestment.Date" @bind:format="yyyy-MM-dd" />
                    @if (HasError("InvestmentDate"))
                    {
                        <div class="error-message">Date is required</div>
                    }
                </div>
                <div class="form-group">
                    <label class="required">Name of Equipment</label>
                    <input type="text" class="form-control @(HasError("InvestmentName") ? "error" : "")" @bind="currentInvestment.Name" placeholder="Enter equipment name (e.g., Treadmills, Dumbbells, etc.)" />
                    @if (HasError("InvestmentName"))
                    {
                        <div class="error-message">Name is required</div>
                    }
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control @(HasError("InvestmentDescription") ? "error" : "")" @bind="currentInvestment.Description" placeholder="Enter equipment description (optional)" rows="3"></textarea>
                    @if (HasError("InvestmentDescription"))
                    {
                        <div class="error-message">Description error</div>
                    }
                </div>
                <div class="form-group">
                    <label class="required">Quantity</label>
                    <input type="number" step="1" min="1" class="form-control @(HasError("InvestmentQuantity") ? "error" : "")" @bind="currentInvestment.Quantity" placeholder="Enter quantity" />
                    @if (HasError("InvestmentQuantity"))
                    {
                        <div class="error-message">Quantity must be at least 1</div>
                    }
                </div>
                <div class="form-group">
                    <label class="required">Price (₱)</label>
                    <input type="number" step="0.01" min="0" class="form-control @(HasError("InvestmentPrice") ? "error" : "")" @bind="currentInvestment.Price" placeholder="Enter price per unit" />
                    @if (HasError("InvestmentPrice"))
                    {
                        <div class="error-message">Price must be greater than 0</div>
                    }
                    @if (currentInvestment.Quantity > 0 && currentInvestment.Price > 0)
                    {
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Total Cost: ₱@((currentInvestment.Quantity * currentInvestment.Price).ToString("N2"))
                        </small>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" @onclick="CloseInvestmentModal">Cancel</button>
                <button class="btn btn-save" @onclick="SaveInvestment">@(isEditInvestment ? "Update Equipment" : "Save Equipment")</button>
            </div>
        </div>
    </div>
}

<!-- Archive Capital Confirmation Modal -->
@if (showArchiveCapitalConfirmation)
{
    <div class="modal-overlay" @onclick="CloseArchiveCapitalConfirmation">
        <div class="modal-content confirmation-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Confirm Archive</h2>
                <button class="close-btn" @onclick="CloseArchiveCapitalConfirmation">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to archive this capital entry?</p>
                <p class="confirmation-warning">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" @onclick="CloseArchiveCapitalConfirmation">Cancel</button>
                <button class="btn btn-danger" @onclick="ConfirmArchiveCapital">Yes, Archive</button>
            </div>
        </div>
    </div>
}

<!-- Archive Investment Confirmation Modal -->
@if (showArchiveConfirmation)
{
    <div class="modal-overlay" @onclick="CloseArchiveConfirmation">
        <div class="modal-content confirmation-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Confirm Archive</h2>
                <button class="close-btn" @onclick="CloseArchiveConfirmation">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to archive this equipment entry?</p>
                <p class="confirmation-warning">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" @onclick="CloseArchiveConfirmation">Cancel</button>
                <button class="btn btn-danger" @onclick="ConfirmArchiveInvestment">Yes, Archive</button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmation)
{
    <div class="modal-overlay" @onclick="CloseDeleteConfirmation">
        <div class="modal-content confirmation-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
                <button class="close-btn" @onclick="CloseDeleteConfirmation">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this entry?</p>
                <p class="confirmation-warning">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" @onclick="CloseDeleteConfirmation">Cancel</button>
                <button class="btn btn-danger" @onclick="ConfirmDelete">Yes, Delete</button>
            </div>
        </div>
    </div>
}

<style>
    .finance-container {
        padding: 30px;
        background: #ffffff;
        min-height: 100vh;
    }

    .page-header {
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin: 0 0 5px 0;
    }

    .page-subtitle {
        font-size: 14px;
        color: #666;
        margin: 0;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #234060;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 120px;
    }

    .summary-card h3 {
        font-size: 13px;
        font-weight: 600;
        color: #666;
        margin: 0 0 15px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: left;
    }

    .summary-card-content {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        width: 100%;
    }

    .summary-amount {
        font-size: 28px;
        font-weight: 700;
        color: #234060;
        margin: 0;
        text-align: right;
    }

    .finance-sections {
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    .finance-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .section-header h2 {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .add-btn {
        background: #5cb85c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .add-btn:hover {
        background: #4cae4c;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(92, 184, 92, 0.3);
    }

    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .finance-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .finance-table thead {
        background: #234060;
        color: white;
    }

    .finance-table th {
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        border: none;
    }

    .finance-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s;
    }

    .finance-table tbody tr:last-child {
        border-bottom: none;
    }

    .finance-table tbody tr:hover {
        background: #f8f9fa;
    }

    .finance-table td {
        padding: 14px 16px;
        color: #333;
        font-size: 14px;
        vertical-align: middle;
    }

    .finance-table td strong {
        color: #234060;
        font-weight: 600;
    }

    .amount-cell {
        font-weight: 600;
        color: #234060;
        text-align: right;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        align-items: center;
    }

    .action-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .action-icon {
        width: 18px;
        height: 18px;
        object-fit: contain;
    }

    .edit-btn:hover {
        background: #e3f2fd;
        transform: scale(1.1);
    }

    .archive-btn:hover {
        background: #fff3e0;
        transform: scale(1.1);
    }

    .delete-btn:hover {
        background: #ffeaea;
        transform: scale(1.1);
    }

    .no-data {
        text-align: center;
        padding: 40px 20px !important;
    }

    .no-data-content p {
        color: #999;
        font-size: 14px;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .confirmation-modal {
        max-width: 420px;
    }

    .modal-header {
        padding: 20px 30px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #333;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .close-btn:hover {
        background: #f0f0f0;
        color: #333;
    }

    .modal-body {
        padding: 30px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .form-group label.required::after {
        content: " *";
        color: #dc3545;
    }

    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #234060;
        box-shadow: 0 0 0 3px rgba(35, 64, 96, 0.1);
    }

    .form-control.error {
        border-color: #dc3545;
    }

    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
    }

    .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-cancel {
        background: #f0f0f0;
        color: #333;
    }

    .btn-cancel:hover {
        background: #e0e0e0;
    }

    .btn-save {
        background: #5cb85c;
        color: white;
    }

    .btn-save:hover {
        background: #4cae4c;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(92, 184, 92, 0.3);
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
    }

    .btn-danger:hover {
        background: #c0392b;
    }

    .confirmation-warning {
        color: #e74c3c;
        font-weight: 600;
        margin-top: 10px;
    }

</style>

@code {
    private List<Capital> capitals = new List<Capital>();
    private List<Investment> investments = new List<Investment>();
    private List<Liability> liabilities = new List<Liability>();
    private decimal totalCapital = 0;
    private decimal totalInvestment = 0;
    private decimal totalLiability = 0;
    
    private bool showCapitalModal = false;
    private bool showInvestmentModal = false;
    private bool showLiabilityModal = false;
    private bool showDeleteConfirmation = false;
    private bool showArchiveConfirmation = false;
    private bool showArchiveCapitalConfirmation = false;
    private bool showArchiveLiabilityConfirmation = false;
    private bool isEditInvestment = false;
    private bool isEditLiability = false;
    private Capital currentCapital = new Capital();
    private Investment currentInvestment = new Investment();
    private Liability currentLiability = new Liability();
    private Capital? capitalToDelete;
    private Investment? investmentToDelete;
    private Investment? investmentToArchive;
    private Capital? capitalToArchive;
    private Liability? liabilityToArchive;
    private HashSet<string> validationErrors = new HashSet<string>();

    private string? currentUserRole;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is admin
        var isAuthenticated = await AuthService.IsUserAuthenticated();
        if (!isAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        currentUserRole = await AuthService.GetCurrentUserRole();
        
        // Only admin can access this page
        if (currentUserRole?.ToLower() != "admin")
        {
            NavigationManager.NavigateTo("/dashboard");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            // Use AsNoTracking() to avoid tracking conflicts and improve performance
            capitals = await Context.Capitals.AsNoTracking().ToListAsync();
            investments = await Context.Investments.AsNoTracking().ToListAsync();
            liabilities = await Context.Liabilities.AsNoTracking().Where(l => !l.IsArchived).ToListAsync();
            
            totalCapital = capitals.Sum(c => c.Amount);
            totalInvestment = investments.Sum(i => i.Price * i.Quantity);
            totalLiability = liabilities.Where(l => !l.IsPaid).Sum(l => l.Amount);
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading data: {ex.Message}");
        }
    }

    // Liability Methods
    private void OpenAddLiabilityModal()
    {
        isEditLiability = false;
        currentLiability = new Liability { Date = DateTime.Today, LiabilityType = "Other" };
        validationErrors.Clear();
        showLiabilityModal = true;
        StateHasChanged();
    }

    private void CloseLiabilityModal()
    {
        showLiabilityModal = false;
        currentLiability = new Liability();
        validationErrors.Clear();
        StateHasChanged();
    }

    private void EditLiability(Liability liability)
    {
        isEditLiability = true;
        currentLiability = new Liability
        {
            LiabilityID = liability.LiabilityID,
            Date = liability.Date,
            Name = liability.Name,
            Description = liability.Description,
            Amount = liability.Amount,
            LiabilityType = liability.LiabilityType,
            DueDate = liability.DueDate,
            IsPaid = liability.IsPaid
        };
        validationErrors.Clear();
        showLiabilityModal = true;
        StateHasChanged();
    }

    private async Task SaveLiability()
    {
        validationErrors.Clear();

        if (currentLiability.Date == default)
            validationErrors.Add("LiabilityDate");
        if (string.IsNullOrWhiteSpace(currentLiability.Name))
            validationErrors.Add("LiabilityName");
        if (currentLiability.Amount <= 0)
            validationErrors.Add("LiabilityAmount");

        if (validationErrors.Any())
        {
            StateHasChanged();
            return;
        }

        try
        {
            if (isEditLiability)
            {
                var existing = await Context.Liabilities.FindAsync(currentLiability.LiabilityID);
                if (existing != null)
                {
                    existing.Date = currentLiability.Date;
                    existing.Name = currentLiability.Name;
                    existing.Description = currentLiability.Description;
                    existing.Amount = currentLiability.Amount;
                    existing.LiabilityType = currentLiability.LiabilityType;
                    existing.DueDate = currentLiability.DueDate;
                    existing.IsPaid = currentLiability.IsPaid;
                    existing.UpdatedAt = DateTime.Now;
                    await Context.SaveChangesAsync();
                }
                ToastService.ShowSuccess("Liability updated successfully");
            }
            else
            {
                currentLiability.CreatedAt = DateTime.Now;
                Context.Liabilities.Add(currentLiability);
                await Context.SaveChangesAsync();
                ToastService.ShowSuccess("Liability added successfully");
            }

            await LoadData();
            CloseLiabilityModal();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving liability: {ex.Message}");
        }
    }

    private async Task MarkLiabilityAsPaid(Liability liability)
    {
        try
        {
            var existing = await Context.Liabilities.FindAsync(liability.LiabilityID);
            if (existing != null)
            {
                existing.IsPaid = true;
                existing.PaidDate = DateTime.Now;
                existing.UpdatedAt = DateTime.Now;
                await Context.SaveChangesAsync();
            }
            await LoadData();
            ToastService.ShowSuccess("Liability marked as paid");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error updating liability: {ex.Message}");
        }
    }

    private void ShowArchiveLiabilityConfirmation(Liability liability)
    {
        liabilityToArchive = liability;
        showArchiveLiabilityConfirmation = true;
        StateHasChanged();
    }

    private void CloseArchiveLiabilityConfirmation()
    {
        showArchiveLiabilityConfirmation = false;
        liabilityToArchive = null;
        StateHasChanged();
    }

    private async Task ConfirmArchiveLiability()
    {
        if (liabilityToArchive != null)
        {
            try
            {
                var existing = await Context.Liabilities.FindAsync(liabilityToArchive.LiabilityID);
                if (existing != null)
                {
                    existing.IsArchived = true;
                    existing.UpdatedAt = DateTime.Now;
                    await Context.SaveChangesAsync();
                }
                await LoadData();
                ToastService.ShowSuccess("Liability deleted successfully");
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Error deleting liability: {ex.Message}");
            }
        }
        CloseArchiveLiabilityConfirmation();
    }

    private void OpenAddCapitalModal()
    {
        currentCapital = new Capital { DateAdded = DateTime.Today };
        validationErrors.Clear();
        showCapitalModal = true;
        StateHasChanged();
    }

    private void CloseCapitalModal()
    {
        showCapitalModal = false;
        currentCapital = new Capital();
        validationErrors.Clear();
        StateHasChanged();
    }

    private void OpenAddInvestmentModal()
    {
        isEditInvestment = false;
        currentInvestment = new Investment { Date = DateTime.Today, Quantity = 1 };
        validationErrors.Clear();
        showInvestmentModal = true;
        StateHasChanged();
    }

    private void EditInvestment(Investment investment)
    {
        isEditInvestment = true;
        currentInvestment = new Investment
        {
            InvestmentID = investment.InvestmentID,
            Date = investment.Date,
            Name = investment.Name,
            Description = investment.Description,
            Quantity = investment.Quantity,
            Price = investment.Price
        };
        validationErrors.Clear();
        showInvestmentModal = true;
        StateHasChanged();
    }

    private void CloseInvestmentModal()
    {
        showInvestmentModal = false;
        isEditInvestment = false;
        currentInvestment = new Investment();
        validationErrors.Clear();
        StateHasChanged();
    }

    private void ShowArchiveConfirmation(Investment investment)
    {
        investmentToArchive = investment;
        showArchiveConfirmation = true;
        StateHasChanged();
    }

    private void CloseArchiveConfirmation()
    {
        showArchiveConfirmation = false;
        investmentToArchive = null;
        StateHasChanged();
    }

    private bool HasError(string field) => validationErrors.Contains(field);

    private bool ValidateCapital()
    {
        validationErrors.Clear();
        
        if (currentCapital.DateAdded == DateTime.MinValue)
            validationErrors.Add("CapitalDate");
        
        if (string.IsNullOrWhiteSpace(currentCapital.Description))
            validationErrors.Add("CapitalDescription");
        
        if (currentCapital.Amount <= 0)
            validationErrors.Add("CapitalAmount");
        
        return validationErrors.Count == 0;
    }

    private bool ValidateInvestment()
    {
        validationErrors.Clear();
        
        if (currentInvestment.Date == DateTime.MinValue)
            validationErrors.Add("InvestmentDate");
        
        if (string.IsNullOrWhiteSpace(currentInvestment.Name))
            validationErrors.Add("InvestmentName");
        
        if (currentInvestment.Quantity < 1)
            validationErrors.Add("InvestmentQuantity");
        
        if (currentInvestment.Price <= 0)
            validationErrors.Add("InvestmentPrice");
        
        return validationErrors.Count == 0;
    }

    private async Task SaveCapital()
    {
        if (!ValidateCapital())
        {
            StateHasChanged();
            return;
        }

        try
        {
            Context.Capitals.Add(currentCapital);
            await Context.SaveChangesAsync();
            
            // Clear the tracked entity before reloading
            Context.Entry(currentCapital).State = EntityState.Detached;
            
            await LoadData();
            CloseCapitalModal();
            ToastService.ShowSuccess("Capital added successfully");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving capital: {ex.Message}");
        }
    }

    private async Task SaveInvestment()
    {
        if (!ValidateInvestment())
        {
            StateHasChanged();
            return;
        }

        try
        {
            Investment? trackedEntity = null;
            
            if (isEditInvestment)
            {
                trackedEntity = await Context.Investments.FindAsync(currentInvestment.InvestmentID);
                if (trackedEntity != null)
                {
                    trackedEntity.Date = currentInvestment.Date;
                    trackedEntity.Name = currentInvestment.Name;
                    trackedEntity.Description = currentInvestment.Description;
                    trackedEntity.Quantity = currentInvestment.Quantity;
                    trackedEntity.Price = currentInvestment.Price;
                    Context.Investments.Update(trackedEntity);
                }
            }
            else
            {
                Context.Investments.Add(currentInvestment);
                trackedEntity = currentInvestment;
            }
            
            await Context.SaveChangesAsync();
            
            // Detach the entity before reloading to avoid tracking conflicts
            if (trackedEntity != null)
            {
                Context.Entry(trackedEntity).State = EntityState.Detached;
            }
            
            await LoadData();
            CloseInvestmentModal();
            ToastService.ShowSuccess(isEditInvestment ? "Equipment updated successfully" : "Equipment added successfully");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving equipment: {ex.Message}");
        }
    }

    private async Task ConfirmArchiveInvestment()
    {
        if (investmentToArchive == null) return;

        try
        {
            // Attach and remove the entity
            var entity = await Context.Investments.FindAsync(investmentToArchive.InvestmentID);
            if (entity != null)
            {
                Context.Investments.Remove(entity);
                await Context.SaveChangesAsync();
                
                // Detach after removal
                Context.Entry(entity).State = EntityState.Detached;
            }
            
            await LoadData();
            CloseArchiveConfirmation();
            ToastService.ShowSuccess("Equipment archived successfully");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error archiving equipment: {ex.Message}");
        }
    }

    private void ShowArchiveCapitalConfirmation(Capital capital)
    {
        capitalToArchive = capital;
        showArchiveCapitalConfirmation = true;
        StateHasChanged();
    }

    private void CloseArchiveCapitalConfirmation()
    {
        showArchiveCapitalConfirmation = false;
        capitalToArchive = null;
        StateHasChanged();
    }

    private async Task ConfirmArchiveCapital()
    {
        if (capitalToArchive == null) return;

        try
        {
            // Attach and remove the entity
            var entity = await Context.Capitals.FindAsync(capitalToArchive.CapitalID);
            if (entity != null)
            {
                Context.Capitals.Remove(entity);
                await Context.SaveChangesAsync();
                
                // Detach after removal
                Context.Entry(entity).State = EntityState.Detached;
            }
            
            await LoadData();
            CloseArchiveCapitalConfirmation();
            ToastService.ShowSuccess("Capital archived successfully");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error archiving capital: {ex.Message}");
        }
    }

    private void ConfirmDeleteCapital(Capital capital)
    {
        capitalToDelete = capital;
        investmentToDelete = null;
        showDeleteConfirmation = true;
        StateHasChanged();
    }

    private void ConfirmDeleteInvestment(Investment investment)
    {
        investmentToDelete = investment;
        capitalToDelete = null;
        showDeleteConfirmation = true;
        StateHasChanged();
    }

    private void CloseDeleteConfirmation()
    {
        showDeleteConfirmation = false;
        capitalToDelete = null;
        investmentToDelete = null;
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        try
        {
            if (capitalToDelete != null)
            {
                var entity = await Context.Capitals.FindAsync(capitalToDelete.CapitalID);
                if (entity != null)
                {
                    Context.Capitals.Remove(entity);
                    await Context.SaveChangesAsync();
                    Context.Entry(entity).State = EntityState.Detached;
                }
                ToastService.ShowSuccess("Capital deleted successfully");
            }
            else if (investmentToDelete != null)
            {
                var entity = await Context.Investments.FindAsync(investmentToDelete.InvestmentID);
                if (entity != null)
                {
                    Context.Investments.Remove(entity);
                    await Context.SaveChangesAsync();
                    Context.Entry(entity).State = EntityState.Detached;
                }
                ToastService.ShowSuccess("Equipment deleted successfully");
            }
            
            await LoadData();
            CloseDeleteConfirmation();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting entry: {ex.Message}");
        }
    }
}

